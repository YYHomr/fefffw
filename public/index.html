<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>VOChat 2</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <!-- PDF.js for advanced PDF text extraction -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Client-side document generation libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- Machine learning libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ml5/0.12.2/ml5.min.js"></script>
  <!-- TensorFlow.js for machine learning -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
  <!-- Tesseract.js for OCR -->
  <script src="https://unpkg.com/tesseract.js@v4.1.1/dist/tesseract.min.js"></script>
  <!-- PptxGenJS for PowerPoint generation -->
  <script src="https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
  <style>
    :root {
      /* Formal Color Palette - Minimal and Professional */
      --primary-50: #f8f9fa;
      --primary-100: #f1f3f4;
      --primary-200: #e8eaed;
      --primary-300: #dadce0;
      --primary-400: #bdc1c6;
      --primary-500: #9aa0a6;
      --primary-600: #80868b;
      --primary-700: #5f6368;
      --primary-800: #3c4043;
      --primary-900: #202124;

      /* Neutral Grays - Professional Palette */
      --gray-50: #fafafa;
      --gray-100: #f5f5f5;
      --gray-200: #eeeeee;
      --gray-300: #e0e0e0;
      --gray-400: #bdbdbd;
      --gray-500: #9e9e9e;
      --gray-600: #757575;
      --gray-700: #616161;
      --gray-800: #424242;
      --gray-900: #212121;

      /* Dark Theme - Formal */
      --dark-bg-primary: #1a1a1a;
      --dark-bg-secondary: #2d2d2d;
      --dark-bg-tertiary: #3a3a3a;
      --dark-surface: #404040;
      --dark-surface-hover: #4a4a4a;
      --dark-surface-active: #525252;

      /* Enhanced User Message Colors */
      /* Enhanced User Message Colors */
      --user-primary: #4a5568;
      --user-primary-hover: #2d3748;
      --user-gradient-start: #4a5568;
      --user-gradient-end: #718096;

      /* Minimal Accent Colors */
      --accent-primary: #000000;
      --accent-primary-hover: #333333;
      --accent-success: #137333;
      --accent-warning: #ea8600;
      --accent-error: #d93025;

      /* Spacing Scale */
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;
      --space-16: 4rem;

      /* Border Radius - Subtle */
      --radius-xs: 0.125rem;
      --radius-sm: 0.25rem;
      --radius-md: 0.375rem;
      --radius-lg: 0.5rem;
      --radius-xl: 0.75rem;
      --radius-2xl: 1rem;

      /* Shadows - Subtle and Professional */
      --shadow-xs: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

      /* Typography */
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.875rem;

      /* Line Heights */
      --leading-tight: 1.25;
      --leading-normal: 1.5;
      --leading-relaxed: 1.625;

      /* Transitions - Subtle */
      --transition-fast: 150ms ease;
      --transition-normal: 250ms ease;
      --transition-slow: 350ms ease;

      /* Z-Index Scale */
      --z-dropdown: 50;
      --z-sticky: 60;
      --z-fixed: 70;
      --z-modal: 90;
      --z-tooltip: 100;
      --z-welcome: 110;

      /* Agent Mode Colors */
      --agent-glow: 0 0 15px rgba(0, 123, 255, 0.6);
      --agent-border: #007bff;
    }

    /* Agent Mode Styles - Premium Overhaul */
    @keyframes agent-glow-anim {
      0% {
        box-shadow: 0 0 15px rgba(0, 123, 255, 0.2);
      }

      50% {
        box-shadow: 0 0 25px rgba(0, 123, 255, 0.5), 0 0 45px rgba(0, 200, 255, 0.2);
      }

      100% {
        box-shadow: 0 0 15px rgba(0, 123, 255, 0.2);
      }
    }

    @keyframes gradient-shift {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    @keyframes slide-up-fade {
      from {
        opacity: 0;
        transform: translate(-50%, 10px);
      }

      to {
        opacity: 1;
        transform: translate(-50%, -10px);
      }
    }

    /* Target the input wrapper specifically when agent mode is active on the parent */
    .input-area.agent-mode-active .input-wrapper {
      position: relative;
      border: 1px solid transparent !important;
      background: linear-gradient(var(--bg-primary, #ffffff), var(--bg-primary, #ffffff)) padding-box,
        linear-gradient(45deg, #007bff, #00c6ff, #007bff) border-box;
      background-size: 200% 200%;
      animation: agent-glow-anim 3s infinite ease-in-out, gradient-shift 5s ease infinite;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 100;
    }

    /* Remove effects from the main container if any remained */
    .input-area.agent-mode-active {
      background: transparent;
      border: none !important;
      box-shadow: none !important;
      animation: none !important;
    }

    body.dark .input-area.agent-mode-active .input-wrapper {
      background: linear-gradient(var(--dark-bg-secondary, #1f1f1f), var(--dark-bg-secondary, #1f1f1f)) padding-box,
        linear-gradient(45deg, #007bff, #00fa9a, #007bff) border-box;
      background-size: 200% 200%;
    }

    /* Agent Mode Badge */
    .input-area.agent-mode-active .input-wrapper::before {
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%) translateY(-10px);
      background: linear-gradient(135deg, #007bff, #00c6ff);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
      z-index: 101;
      animation: slide-up-fade 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      pointer-events: none;
      white-space: nowrap;
    }

    .agent-step-box {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      padding: 6px 12px;
      margin: 4px;
      font-size: 12px;
      color: var(--gray-700);
      animation: fadeIn 0.3s ease;
    }

    body.dark .agent-step-box {
      background: var(--dark-surface);
      border-color: var(--dark-surface-hover);
      color: var(--gray-300);
    }

    .agent-step-box i {
      color: var(--agent-border);
    }

    .agent-step-box.loading i {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    /* Agent Sidebar Styles */
    .agent-view-panel {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: white;
    }

    body.dark .agent-view-panel {
      background: var(--dark-bg-secondary);
    }

    .agent-screen-mockup {
      flex: 1;
      background: #0f0f0f;
      border-radius: 8px;
      margin: 10px;
      padding: 20px;
      color: #e0e0e0;
      font-family: 'Fira Code', 'Courier New', monospace;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.6;
      border: 1px solid #333;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .agent-screen-line {
      margin-bottom: 8px;
      border-left: 2px solid transparent;
      padding-left: 10px;
    }

    .agent-screen-line.cmd {
      color: #569cd6;
      border-left-color: #569cd6;
      font-weight: bold;
    }

    .agent-screen-line.info {
      color: #9cdcfe;
      border-left-color: #9cdcfe;
    }

    .agent-screen-line.success {
      color: #6a9955;
      border-left-color: #6a9955;
    }

    .agent-screen-line.error {
      color: #f44747;
      border-left-color: #f44747;
    }

    .agent-screen-line.code {
      color: #dcdcaa;
      border-left-color: #dcdcaa;
      font-family: monospace;
    }

    .agent-screen-line.web {
      color: #ce9178;
      border-left-color: #ce9178;
    }

    .agent-screen-line.link {
      color: #4fc1ff;
      text-decoration: underline;
      cursor: pointer;
    }

    .agent-screen-line.link:hover {
      color: #9cdcfe;
    }



    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: var(--font-size-base);
      line-height: var(--leading-normal);
      background: var(--gray-50);
      color: var(--gray-900);
      height: 100vh;
      display: grid;
      grid-template-columns: auto 1fr 0px;
      grid-template-rows: auto 1fr auto;
      grid-template-areas:
        "sidebar header codeview"
        "sidebar main codeview"
        "sidebar input codeview";
      transition: all var(--transition-normal);
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body.code-view-open {
      grid-template-columns: auto 1fr 50%;
    }

    @media (max-width: 1024px) {
      body.code-view-open {
        grid-template-columns: auto 1fr 70%;
      }
    }

    @media (max-width: 768px) {
      body.code-view-open {
        grid-template-columns: auto 1fr 0px;
      }
    }

    body.dark {
      background: var(--dark-bg-primary);
      color: var(--gray-100);
    }

    /* Mobile App Download Banner */
    .mobile-app-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-hover));
      color: white;
      padding: var(--space-3) var(--space-4);
      display: none;
      align-items: center;
      justify-content: space-between;
      z-index: 100;
      box-shadow: var(--shadow-md);
    }

    .mobile-app-banner.show {
      display: flex;
    }

    .banner-content {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex: 1;
    }

    .banner-text {
      font-size: var(--font-size-sm);
      font-weight: 500;
    }

    .download-app-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: var(--radius-lg);
      padding: var(--space-2) var(--space-4);
      color: white;
      font-size: var(--font-size-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .download-app-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .banner-close {
      background: none;
      border: none;
      color: white;
      font-size: var(--font-size-lg);
      cursor: pointer;
      padding: var(--space-1);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
    }

    .banner-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Header Styles - Made Smaller */
    .header {
      grid-area: header;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3) var(--space-6);
      background: transparent;
      border-bottom: none;
      position: relative;
      z-index: var(--z-sticky);
      height: 60px;
    }

    body.dark .header {
      background: var(--dark-bg-secondary);
      /* matches new chat bg */
      border-bottom: 1px solid var(--dark-surface-hover);
      border-bottom: none;
    }

    body.dark .input-area {
      background: var(--dark-bg-secondary);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .sidebar-toggle {
      background: none;
      border: none;
      color: inherit;
      font-size: var(--font-size-lg);
      cursor: pointer;
      padding: var(--space-2);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-toggle:hover {
      background: var(--gray-100);
    }

    body.dark .sidebar-toggle:hover {
      background: var(--dark-surface);
    }

    .header-title {
      font-size: var(--font-size-xl);
      font-weight: 600;
      color: var(--gray-900);
      letter-spacing: -0.025em;
    }

    body.dark .header-title {
      color: var(--gray-100);
    }

    /* Upgrade Button Styles */
    .upgrade-button-container {
      display: flex;
      align-items: center;
      margin-left: auto;
      margin-right: var(--space-4);
      position: relative;
    }

    .upgrade-button {
      background: linear-gradient(135deg, #c63afd, #49005f);
      color: #000 !important;
      border: none;
      padding: 8px 18px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      text-decoration: none;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
      white-space: nowrap;
    }

    .upgrade-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
      background: linear-gradient(135deg, #49005f, #c63afd);
    }

    .upgrade-button i {
      font-size: 14px;
    }

    .dismiss-upgrade-btn {
      position: absolute;
      right: -8px;
      top: -8px;
      background: #333;
      color: white;
      border: 2px solid white;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 10px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      transform: scale(0.5);
      z-index: 10;
    }

    body.dark .dismiss-upgrade-btn {
      background: #eee;
      color: #333;
      border-color: #2d2d2d;
    }

    .upgrade-button-container:hover .dismiss-upgrade-btn {
      opacity: 1;
      visibility: visible;
      transform: scale(1);
    }

    .dismiss-upgrade-btn:hover {
      background: #f44336;
      color: white;
      border-color: #f44336;
    }

    /* Conversation Name Display */
    .conversation-name {
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--gray-600);
      margin-left: var(--space-4);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    body.dark .conversation-name {
      color: var(--gray-400);
    }

    /* New Model Selector with Hover Text */
    .model-selector {
      position: relative;
      display: flex;
      align-items: center;
    }

    .model-buttons {
      display: flex;
      align-items: center;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    body.dark .model-buttons {
      background: var(--dark-surface);
      border-color: var(--dark-surface-hover);
    }

    .model-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      color: var(--gray-700);
      font-size: var(--font-size-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
      border: none;
      background: transparent;
      position: relative;
    }

    body.dark .model-button {
      color: var(--gray-300);
    }

    .model-button:hover {
      background: var(--gray-100);
    }

    body.dark .model-button:hover {
      background: var(--dark-surface-hover);
    }

    .model-button.active {
      background: var(--accent-primary);
      color: white;
    }

    .model-button.active:hover {
      background: var(--accent-primary-hover);
    }

    /* Model Button Tooltips */
    .model-button .tooltip {
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--gray-800);
      color: white;
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-md);
      font-size: var(--font-size-xs);
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-fast);
      z-index: var(--z-tooltip);
      pointer-events: none;
      box-shadow: var(--shadow-lg);
    }

    .model-button .tooltip::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 5px;
      border-style: solid;
      border-color: transparent transparent var(--gray-800) transparent;
    }

    .model-button:hover .tooltip {
      opacity: 1;
      visibility: visible;
    }

    body.dark .model-button .tooltip {
      background: var(--gray-900);
    }

    body.dark .model-button .tooltip::before {
      border-color: transparent transparent var(--gray-900) transparent;
    }

    /* Enhanced Sidebar Styles with Shrinking/Expanding and Adjustable Width */
    .sidebar {
      grid-area: sidebar;
      width: 280px;
      min-width: 60px;
      max-width: 400px;
      background: white;
      border-right: 1px solid var(--gray-200);
      display: flex;
      flex-direction: column;
      transition: width var(--transition-normal), background var(--transition-normal);
      position: relative;
      z-index: var(--z-fixed);
      overflow: hidden;
      resize: horizontal;
    }

    body.dark .sidebar {
      background: var(--dark-bg-primary);
      border-right-color: var(--dark-surface);
    }

    .sidebar.collapsed {
      width: 60px !important;
      resize: none;
    }

    .sidebar.collapsed .sidebar-content,
    .sidebar.collapsed .sidebar-header .sidebar-title,
    .sidebar.collapsed .sidebar-header .sidebar-actions {
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-fast), visibility var(--transition-fast);
    }

    .sidebar.collapsed .sidebar-toggle-desktop {
      transform: rotate(180deg);
    }

    /* Collapsed Sidebar Icons */
    .sidebar.collapsed .sidebar-icons {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4) 0;
      opacity: 1;
      visibility: visible;
    }

    .sidebar-icons {
      display: none;
      position: absolute;
      top: 80px;
      left: 0;
      right: 0;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-fast), visibility var(--transition-fast);
    }

    .sidebar-icon {
      width: 40px;
      height: 40px;
      background: var(--gray-100);
      border: none;
      border-radius: var(--radius-lg);
      color: var(--gray-600);
      font-size: var(--font-size-base);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    body.dark .sidebar-icon {
      background: var(--dark-surface);
      color: var(--gray-400);
    }

    .sidebar-icon:hover {
      background: var(--accent-primary);
      color: white;
      transform: scale(1.05);
    }

    .sidebar-icon.active {
      background: var(--accent-primary);
      color: white;
    }

    .sidebar-header {
      padding: var(--space-5) var(--space-5) var(--space-4);
      border-bottom: 1px solid var(--gray-100);
      position: relative;
    }

    body.dark .sidebar-header {
      border-bottom-color: var(--dark-surface);
    }

    /* Popup Modal Styles */
    .popup-modal {
      display: none;
      /* Hidden by default */
      position: fixed;
      /* Stay in place */
      z-index: var(--z-modal);
      /* Sit on top */
      left: 0;
      top: 0;
      width: 100%;
      /* Full width */
      height: 100%;
      /* Full height */
      overflow: auto;
      /* Enable scroll if needed */
      background-color: rgba(0, 0, 0, 0.7);
      /* Black w/ opacity */
      align-items: center;
      justify-content: center;
    }

    .popup-modal.show {
      display: flex;
    }

    .popup-modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 0;
      border: 1px solid #888;
      width: 80%;
      max-width: 700px;
      box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
      animation-name: animatetop;
      animation-duration: 0.4s;
      position: relative;
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    @keyframes animatetop {
      from {
        top: -300px;
        opacity: 0
      }

      to {
        top: 0;
        opacity: 1
      }
    }

    .popup-modal-content img {
      width: 100%;
      height: auto;
      display: block;
    }

    .popup-modal-close {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .popup-modal-close:hover,
    .popup-modal-close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }

    .sidebar-toggle-desktop {
      position: absolute;
      top: var(--space-4);
      right: var(--space-4);
      background: none;
      border: none;
      color: var(--gray-600);
      font-size: var(--font-size-sm);
      cursor: pointer;
      padding: var(--space-1);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }

    body.dark .sidebar-toggle-desktop {
      color: var(--gray-400);
    }

    .sidebar-toggle-desktop:hover {
      background: var(--gray-100);
      color: var(--gray-800);
    }

    body.dark .sidebar-toggle-desktop:hover {
      background: var(--dark-surface);
      color: var(--gray-200);
    }

    .sidebar-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      transition: opacity var(--transition-fast), visibility var(--transition-fast);
    }

    body.dark .sidebar-title {
      color: var(--gray-200);
    }

    .sidebar-title i {
      font-size: var(--font-size-base);
      color: var(--gray-600);
    }

    body.dark .sidebar-title i {
      color: var(--gray-400);
    }

    .sidebar-actions {
      display: flex;
      gap: var(--space-2);
      transition: opacity var(--transition-fast), visibility var(--transition-fast);
    }

    .sidebar-button {
      flex: 1;
      background: var(--accent-primary);
      border: none;
      border-radius: var(--radius-xl);
      padding: var(--space-3) var(--space-4);
      color: white;
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      box-shadow: var(--shadow-sm);
    }

    .sidebar-button:active {
      transform: scale(0.98);
    }

    .sidebar-button:hover {
      background: var(--accent-primary-hover);
    }

    .sidebar-button.secondary {
      background: var(--gray-50);
      color: var(--gray-700);
      border: 1px solid var(--gray-200);
      box-shadow: none;
    }

    body.dark .sidebar-button.secondary {
      background: var(--dark-surface);
      color: var(--gray-300);
      border-color: var(--dark-surface-hover);
    }

    .sidebar-button.secondary:hover {
      background: var(--gray-200);
      border-color: var(--gray-400);
    }

    body.dark .sidebar-button.secondary:hover {
      background: var(--dark-surface-hover);
      border-color: var(--gray-600);
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-5) var(--space-6);
      transition: opacity var(--transition-fast), visibility var(--transition-fast);
    }

    .memory-section {
      margin-bottom: var(--space-8);
    }

    .section-title {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--gray-500);
      margin-bottom: var(--space-4);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    body.dark .section-title {
      color: var(--gray-300);
    }

    .memory-textarea {
      width: 100%;
      min-height: 100px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 1.5rem;
      padding: var(--space-4) var(--space-6);
      color: var(--gray-900);
      font-family: inherit;
      font-size: var(--font-size-sm);
      line-height: var(--leading-relaxed);
      resize: vertical;
      transition: all var(--transition-fast);
    }

    body.dark .memory-textarea {
      background: var(--dark-surface);
      border-color: var(--dark-surface-hover);
      color: var(--gray-100);
    }

    .memory-textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }

    body.dark .sidebar-footer,
    body.dark .memory-section {
      border-top-color: var(--dark-surface) !important;
    }

    .memory-textarea::placeholder {
      color: var(--gray-500);
    }

    .memory-actions {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-4);
    }

    .history-section {
      flex: 1;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3) var(--space-4);
      background: transparent;
      border: 1px solid transparent;
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all var(--transition-fast);
      margin: 0 -var(--space-2);
    }

    .history-item:hover {
      background: var(--gray-100);
    }

    body.dark .history-item:hover {
      background: var(--dark-surface);
    }

    body.dark .history-item {
      background: transparent;
      border-color: transparent;
    }

    .history-item.active {
      background: var(--gray-100);
      border-color: var(--gray-200);
      color: var(--gray-900);
    }

    body.dark .history-item.active {
      background: var(--dark-surface);
      border-color: var(--dark-surface-hover);
      color: white;
    }

    .history-text {
      flex: 1;
      font-size: var(--font-size-sm);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 500;
    }

    .history-delete {
      background: none;
      border: none;
      color: var(--accent-error);
      font-size: var(--font-size-sm);
      cursor: pointer;
      padding: var(--space-1);
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
      opacity: 0.7;
    }

    .history-delete:hover {
      opacity: 1;
      background: rgba(217, 48, 37, 0.1);
    }

    /* Main Chat Area */
    .main-content {
      grid-area: main;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      background: var(--gray-50);
    }

    body.dark .main-content {
      background: var(--dark-bg-secondary);
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-8);
      scroll-behavior: smooth;
    }


    .chat-messages {
      width: 100%;
    }


    .chat-container {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-messages {
      display: flex;
      flex-direction: column;
      gap: var(--space-6);
      max-width: 800px;
      margin: 0 auto;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      color: var(--gray-500);
    }

    .empty-state-icon {
      font-size: var(--font-size-3xl);
      margin-bottom: var(--space-4);
      color: var(--gray-400);
    }

    .empty-state-title {
      font-size: var(--font-size-2xl);
      font-weight: 600;
      margin-bottom: var(--space-2);
      color: var(--gray-800);
      font-size: 42px;
      /* Bigger main text */
      font-weight: 700;
    }


    body.dark .empty-state-title {
      color: var(--gray-200);
    }

    .empty-state-subtitle {
      font-size: var(--font-size-lg);
      margin-bottom: var(--space-6);
      color: var(--gray-600);
    }

    body.dark .empty-state-subtitle {
      color: var(--gray-400);
    }

    .start-button {
      background: var(--accent-primary);
      border: none;
      border-radius: var(--radius-xl);
      padding: var(--space-4) var(--space-8);
      color: white;
      font-size: var(--font-size-base);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-6);
    }

    .start-button:hover {
      background: var(--accent-primary-hover);
      box-shadow: var(--shadow-md);
    }

    /* Conversation Starters */
    .conversation-starters {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      max-width: 600px;
      margin: 0 auto;
    }

    .conversation-starters h3 {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: var(--space-2);
      text-align: center;
    }

    body.dark .conversation-starters h3 {
      color: var(--gray-300);
    }

    .starter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-3);
    }

    .starter-item {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 1.5rem;
      padding: var(--space-4) var(--space-6);
      cursor: pointer;
      transition: all var(--transition-fast);
      text-align: left;
    }

    body.dark .starter-item {
      background: var(--dark-surface);
      border-color: var(--dark-surface-hover);
    }

    .starter-item:hover {
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .starter-item h4 {
      font-size: var(--font-size-base);
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: var(--space-2);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    body.dark .starter-item h4 {
      color: var(--gray-200);
    }

    .starter-item p {
      font-size: var(--font-size-sm);
      color: var(--gray-600);
      line-height: var(--leading-relaxed);
    }

    body.dark .starter-item p {
      color: var(--gray-400);
    }

    /* PowerPoint Starter Special Styling */
    .powerpoint-starter {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      border: none;
      color: white;
      position: relative;
      overflow: hidden;
    }

    .powerpoint-starter h4 {
      color: white;
      font-weight: 700;
    }

    .powerpoint-starter p {
      color: rgba(255, 255, 255, 0.9);
    }

    .powerpoint-starter:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(255, 107, 53, 0.3);
      border-color: transparent;
    }

    body.dark .powerpoint-starter {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
    }

    /* Starter Image Styling */
    .starter-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: var(--radius-lg);
      margin-top: var(--space-3);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-fast);
    }

    .powerpoint-starter .starter-image {
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .powerpoint-starter:hover .starter-image {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    /* PowerPoint Modal Styling */
    .powerpoint-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: var(--z-modal);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-normal);
    }

    .powerpoint-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .powerpoint-modal-content {
      background: white;
      border-radius: var(--radius-xl);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
      transform: scale(0.9);
      transition: all var(--transition-normal);
    }

    .powerpoint-modal.show .powerpoint-modal-content {
      transform: scale(1);
    }

    body.dark .powerpoint-modal-content {
      background: var(--dark-bg-secondary);
      border: 1px solid var(--dark-surface-hover);
    }

    .powerpoint-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-6);
      border-bottom: 1px solid var(--gray-200);
    }

    body.dark .powerpoint-modal-header {
      border-bottom-color: var(--dark-surface-hover);
    }

    .powerpoint-modal-header h3 {
      margin: 0;
      font-size: var(--font-size-xl);
      font-weight: 600;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    body.dark .powerpoint-modal-header h3 {
      color: var(--gray-100);
    }

    .powerpoint-modal-close {
      background: none;
      border: none;
      color: var(--gray-500);
      font-size: var(--font-size-lg);
      cursor: pointer;
      padding: var(--space-2);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
    }

    .powerpoint-modal-close:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    body.dark .powerpoint-modal-close:hover {
      background: var(--dark-surface-hover);
      color: var(--gray-300);
    }

    .powerpoint-modal-body {
      padding: var(--space-6);
    }

    .powerpoint-form {
      display: flex;
      flex-direction: column;
      gap: var(--space-5);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .form-group label {
      font-weight: 600;
      color: var(--gray-800);
      font-size: var(--font-size-sm);
    }

    body.dark .form-group label {
      color: var(--gray-200);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: var(--space-3);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-lg);
      font-size: var(--font-size-base);
      font-family: inherit;
      transition: all var(--transition-fast);
    }

    body.dark .form-group input,
    body.dark .form-group select,
    body.dark .form-group textarea {
      background: var(--dark-surface);
      border-color: var(--dark-surface-hover);
      color: var(--gray-200);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .powerpoint-modal-footer {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: var(--space-3);
      padding: var(--space-6);
      border-top: 1px solid var(--gray-200);
    }

    body.dark .powerpoint-modal-footer {
      border-top-color: var(--dark-surface-hover);
    }

    .powerpoint-btn-primary,
    .powerpoint-btn-secondary {
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-lg);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      border: none;
    }

    .powerpoint-btn-primary {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .powerpoint-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .powerpoint-btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }

    .powerpoint-btn-secondary:hover {
      background: var(--gray-200);
    }

    body.dark .powerpoint-btn-secondary {
      background: var(--dark-surface);
      color: var(--gray-300);
      border-color: var(--dark-surface-hover);
    }

    body.dark .powerpoint-btn-secondary:hover {
      background: var(--dark-surface-hover);
    }

    /* Enhanced Message Styles */
    .message {
      display: flex;
      gap: var(--space-3);
      max-width: 100%;
      margin-bottom: var(--space-4);
      position: relative;
    }

    .message.user {
      flex-direction: row-reverse;
      margin-left: auto;
      max-width: 75%;
    }

    .message.bot {
      max-width: 90%;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-xl);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-base);
      font-weight: 600;
      flex-shrink: 0;
    }

    /* Enhanced User Message Avatar */
    .message.user .message-avatar {
      background: linear-gradient(135deg, var(--user-gradient-start), var(--user-gradient-end));
      color: white;
      box-shadow: var(--shadow-md);
      border: 2px solid white;
    }

    body.dark .message.user .message-avatar {
      border-color: var(--dark-bg-primary);
    }

    /* Minimal Bot Message Avatar */
    .message.bot .message-avatar {
      background: var(--gray-100);
      color: var(--gray-600);
      border: 1px solid var(--gray-200);
    }

    body.dark .message.bot .message-avatar {
      background: var(--dark-surface);
      color: var(--gray-400);
      border-color: var(--dark-surface-hover);
    }

    .message-content {
      flex: 1;
      min-width: 0;
    }

    /* Enhanced User Message Bubble */
    .message.user .message-bubble {
      background: linear-gradient(135deg, var(--user-gradient-start), var(--user-gradient-end));
      color: white;
      border: none;
      border-radius: 1.5rem;
      padding: var(--space-4) var(--space-6);
      box-shadow: var(--shadow-sm);
      position: relative;
      word-wrap: break-word;
      line-height: var(--leading-relaxed);
      font-weight: 500;
    }

    .message.user .message-bubble::before {
      content: none;
    }


    /* AI Message - Enhanced with Better Paragraph Organization */
    .message.bot .message-bubble {
      background: none;
      border: none;
      border-radius: 0;
      padding: 0;
      box-shadow: none;
      word-wrap: break-word;
      line-height: var(--leading-relaxed);
      color: var(--gray-800);
      text-align: left;
    }

    body.dark .message.bot .message-bubble {
      color: var(--gray-200);
    }

    /* Enhanced Paragraph Styling for AI Messages */
    .message.bot .message-bubble p {
      margin: 0 0 var(--space-4) 0;
      line-height: 1.7;
      font-size: var(--font-size-base);
      color: inherit;
      text-align: left;
      word-spacing: 0.05em;
      letter-spacing: 0.01em;
    }

    .message.bot .message-bubble p:last-child {
      margin-bottom: 0;
    }

    /* Visual Dividers for Long Content - REMOVED */

    /* Enhanced Typography for Better Readability */
    .message.bot .message-bubble strong,
    .message.bot .message-bubble b {
      font-weight: 600;
      color: var(--gray-900);
    }

    body.dark .message.bot .message-bubble strong,
    body.dark .message.bot .message-bubble b {
      color: var(--gray-100);
    }

    /* Section Dividers for Major Content Breaks - REMOVED */

    /* Enhanced User Message Meta */
    .message.user .message-meta {
      font-size: var(--font-size-xs);
      color: var(--gray-400) !important;
      margin-top: var(--space-2);
      font-weight: 500;
      text-align: right;
    }

    body.dark .message.user .message-meta {
      color: var(--gray-500) !important;
    }

    /* Bot Message Meta - Minimal */
    .message.bot .message-meta {
      font-size: var(--font-size-xs);
      color: var(--gray-500);
      margin-top: var(--space-2);
      font-weight: 400;
    }

    body.dark .message.bot .message-meta {
      color: var(--gray-600);
    }

    /* User Message Action Buttons */
    .user-message-actions {
      position: absolute;
      bottom: -30px;
      right: 0;
      display: flex;
      gap: var(--space-2);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-fast);
      z-index: 10;
    }

    .message.user:hover .user-message-actions {
      opacity: 1;
      visibility: visible;
    }

    .user-message-action {
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-md);
      padding: var(--space-1) var(--space-2);
      color: var(--gray-600);
      font-size: var(--font-size-xs);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    body.dark .user-message-action {
      background: var(--dark-surface);
      border-color: var(--dark-surface-hover);
      color: var(--gray-400);
    }

    .user-message-action:hover {
      background: var(--gray-100);
      color: var(--gray-800);
      border-color: var(--gray-400);
    }

    body.dark .user-message-action:hover {
      background: var(--dark-surface-hover);
      color: var(--gray-200);
      border-color: var(--gray-600);
    }

    /* Bot Message Copy Button */
    .bot-message-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: var(--space-2);
      gap: var(--space-2);
    }

    .bot-message-action {
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-md);
      padding: var(--space-1) var(--space-2);
      color: var(--gray-600);
      font-size: var(--font-size-xs);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    body.dark .bot-message-action {
      background: var(--dark-surface);
      border-color: var(--dark-surface-hover);
      color: var(--gray-400);
    }

    .bot-message-action:hover {
      background: var(--gray-100);
      color: var(--gray-800);
      border-color: var(--gray-400);
    }

    body.dark .bot-message-action:hover {
      background: var(--dark-surface-hover);
      color: var(--gray-200);
      border-color: var(--gray-600);
    }

    /* Code Block Styles - Enhanced for Bot Messages */
    .code-block {
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: 1rem;
      margin: var(--space-3) 0;
      position: relative;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: var(--font-size-sm);
      line-height: var(--leading-normal);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    body.dark .code-block {
      background: var(--dark-bg-primary);
      border-color: var(--dark-surface);
      color: var(--gray-300);
    }

    .code-block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-2) var(--space-4);
      background: rgba(0, 0, 0, 0.05);
      border-bottom: 1px solid var(--gray-300);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(4px);
    }

    body.dark .code-block-header {
      background: rgba(255, 255, 255, 0.05);
      border-bottom-color: var(--dark-surface);
    }

    .code-lang-label {
      font-size: var(--font-size-xs);
      font-weight: 600;
      text-transform: uppercase;
      color: var(--gray-600);
      letter-spacing: 0.05em;
    }

    body.dark .code-lang-label {
      color: var(--gray-400);
    }

    .code-block-actions {
      display: flex;
      gap: var(--space-2);
    }

    .code-view-tabs {
      display: flex;
      gap: var(--space-1);
      padding: var(--space-2) var(--space-3);
      background: var(--gray-100);
      border-bottom: 1px solid var(--gray-300);
    }

    body.dark .code-view-tabs {
      background: var(--dark-bg-tertiary);
      border-bottom-color: var(--dark-surface-hover);
    }

    .code-view-tab {
      padding: var(--space-1) var(--space-4);
      border: none;
      background: transparent;
      color: var(--gray-600);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
    }

    .code-view-tab.active {
      background: var(--accent-primary);
      color: white;
    }

    body.dark .code-view-tab {
      color: var(--gray-400);
    }

    body.dark .code-view-tab.active {
      background: var(--accent-primary);
      color: white;
    }

    .code-block-container {
      position: relative;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .code-block-container.collapsed {
      max-height: 300px;
    }

    .code-block pre {
      padding: var(--space-4) var(--space-6);
      margin: 0;
      overflow-x: auto;
    }

    .code-expand-btn {
      width: 100%;
      padding: var(--space-2);
      background: linear-gradient(to top, var(--gray-200), transparent);
      border: none;
      color: var(--gray-700);
      font-size: var(--font-size-xs);
      font-weight: 600;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      position: absolute;
      bottom: 0;
      left: 0;
      z-index: 5;
    }

    body.dark .code-expand-btn {
      background: linear-gradient(to top, var(--dark-bg-secondary), transparent);
      color: var(--gray-300);
    }

    .code-block-container.collapsed .code-expand-btn {
      display: flex;
    }

    .code-block-container:not(.collapsed) .code-expand-btn {
      position: static;
      background: var(--gray-200);
      display: flex;
    }

    body.da .code-block-container:not(.collapsed) .code-expand-btn {
      background: var(--dark-bg-secondary);
    }

    /* Compact Code Block for AI Coding Mode */
    .code-block.compact .code-block-header {
      border-bottom: none;
      border-radius: 1rem;
    }

    .code-block.compact .code-block-container,
    .code-block.compact .code-block-actions {
      display: none;
    }

    .code-block.compact {
      border-radius: 1rem;
      margin: var(--space-1) 0;
    }

    .code-line-count {
      font-size: var(--font-size-xs);
      color: var(--gray-500);
      margin-left: var(--space-2);
    }

    .code-action {
      background: var(--accent-primary);
      border: none;
      border-radius: var(--radius-md);
      padding: var(--space-1) var(--space-2);
      color: white;
      font-size: var(--font-size-xs);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    .code-action:hover {
      background: var(--accent-primary-hover);
    }

    /* Table Styles with Download Button */
    .table-container {
      position: relative;
      margin: 0 0 var(--space-2) 0;
      overflow-x: auto;
    }

    .table-actions {
      position: absolute;
      top: var(--space-1);
      right: var(--space-2);
      display: flex;
      gap: var(--space-2);
      z-index: 10;
    }

    .table-action {
      background: var(--accent-primary);
      border: none;
      border-radius: var(--radius-md);
      padding: var(--space-1) var(--space-2);
      color: white;
      font-size: var(--font-size-xs);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    .table-action:hover {
      background: var(--accent-primary-hover);
    }

    .message-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-size-sm);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .message-table th {
      background-color: var(--gray-200);
      color: var(--gray-800);
      font-weight: 600;
      text-align: left;
      padding: var(--space-3) var(--space-4);
      border: 1px solid var(--gray-300);
    }

    body.dark .message-table th {
      background-color: var(--dark-surface);
      color: var(--gray-200);
      border-color: var(--dark-surface-hover);
    }

    .message-table td {
      padding: var(--space-3) var(--space-4);
      border: 1px solid var(--gray-300);
      background-color: white;
    }

    body.dark .message-table td {
      background-color: var(--dark-bg-secondary);
      border-color: var(--dark-surface-hover);
      color: var(--gray-300);
    }

    .message-table tr:nth-child(even) td {
      background-color: var(--gray-50);
    }

    body.dark .message-table tr:nth-child(even) td {
      background-color: var(--dark-bg-tertiary);
    }

    /* Expandable Box for Analyzed Text */
    .expandable-box {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-top: var(--space-3);
      margin-bottom: var(--space-3);
      position: relative;
      overflow: hidden;
    }

    body.dark .expandable-box {
      background: var(--dark-bg-secondary);
      border-color: var(--dark-surface-hover);
    }

    .expandable-box-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      font-weight: 600;
      color: var(--gray-800);
    }

    body.dark .expandable-box-header {
      color: var(--gray-200);
    }

    .expandable-box-header i {
      transition: transform var(--transition-fast);
    }

    .expandable-box-header.expanded i {
      transform: rotate(90deg);
    }

    .expandable-box-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      color: var(--gray-700);
      margin-top: var(--space-3);
    }

    body.dark .expandable-box-content {
      color: var(--gray-300);
    }

    .expandable-box-content.expanded {
      max-height: 1000px;
      /* Adjust as needed for content height */
      transition: max-height 0.5s ease-in;
    }

    /* Floating Input Area - No Background */
    .input-area {
      grid-area: input;
      padding: var(--space-3) var(--space-4);
      background: transparent;
      border-top: none;
    }

    .input-container {
      max-width: 800px;
      margin: 0 auto;
      position: relative;
    }

    .input-wrapper {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid var(--gray-300);
      border-radius: 2rem;
      padding: var(--space-2) var(--space-3);
      transition: all var(--transition-fast);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-lg);
    }

    /* DARK MODE  ONLY darken the text bar */
    body.dark .input-wrapper {
      background: #1a1a1a;
      /* darker bar */
      border-color: #2c2c2c;
      /* darker border */
    }

    .input-wrapper:focus-within {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1), var(--shadow-lg);
    }

    .input-actions {
      display: flex;
      gap: var(--space-1);
    }

    .input-action {
      background: none;
      border: none;
      color: var(--gray-500);
      font-size: var(--font-size-lg);
      cursor: pointer;
      padding: var(--space-2);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
    }

    .input-action:hover {
      color: var(--gray-700);
      background: var(--gray-100);
    }

    body.dark .input-action:hover {
      color: var(--gray-300);
      background: var(--dark-surface-hover);
    }

    .message-input-container {
      position: relative;
      flex: 1;
      display: flex;
      min-height: 24px;
    }

    .message-input-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      padding: var(--space-1) var(--space-2);
      font-family: inherit;
      font-size: var(--font-size-base);
      line-height: var(--leading-normal);
      white-space: pre-wrap;
      word-wrap: break-word;
      color: var(--gray-900);
      overflow: hidden;
      box-sizing: border-box;
      z-index: 1;
    }

    body.dark .message-input-overlay {
      color: var(--gray-100);
    }

    .message-input {
      flex: 1;
      background: transparent !important;
      border: none;
      color: transparent !important;
      caret-color: var(--gray-900);
      font-family: inherit;
      font-size: var(--font-size-base);
      line-height: var(--leading-normal);
      padding: var(--space-1) var(--space-2);
      resize: none;
      max-height: 120px;
      min-height: 24px;
      position: relative;
      z-index: 2;
    }

    body.dark .message-input {
      caret-color: var(--gray-100);
    }

    .message-input:focus {
      outline: none;
    }

    .cmd-highlight {
      color: #007bff;
      font-weight: 600;
    }

    .message-input::placeholder {
      color: var(--gray-500);
    }

    /* Email List Styling */
    .email-list-container {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      margin-top: var(--space-4);
      width: 100%;
    }

    .email-card {
      background: var(--primary-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-xl);
      padding: var(--space-4);
      transition: all var(--transition-fast);
      cursor: pointer;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    body.dark .email-card {
      background: var(--dark-bg-secondary);
      border-color: var(--dark-bg-tertiary);
    }

    .email-card:hover {
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .email-card-header {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .email-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--accent-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      flex-shrink: 0;
    }

    body.dark .email-icon {
      background: var(--primary-200);
      color: var(--accent-primary);
    }

    .email-subject {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--gray-900);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    body.dark .email-subject {
      color: var(--gray-100);
    }

    .email-snippet {
      font-size: 0.875rem;
      color: var(--gray-600);
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    body.dark .email-snippet {
      color: var(--gray-400);
    }

    .email-card-actions {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-2);
      opacity: 0;
      transform: translateY(5px);
      transition: all var(--transition-fast);
    }

    .email-card:hover .email-card-actions {
      opacity: 1;
      transform: translateY(0);
    }

    .email-card-action {
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid var(--gray-300);
      background: white;
      color: var(--gray-700);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    body.dark .email-card-action {
      background: var(--dark-bg-tertiary);
      border-color: var(--dark-surface);
      color: var(--gray-300);
    }

    .email-card-action:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    body.dark .email-card-action:hover {
      background: var(--dark-surface-hover);
    }

    .send-button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: #3a3a3a;
      /* gray when empty */
      color: #bbb;
      /* light gray icon */
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.25s ease;
      font-size: 16px;
    }

    /* When active (text typed) */
    .send-button.active {
      background: #ffffff;
      /* white */
      color: #000000;
      /* black icon */
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
      transform: scale(1.05);
    }

    /* Disabled state if you want */
    .send-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }


    .send-button:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .send-button:disabled {
      background: var(--gray-400);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Powered by Vendo text */
    .powered-by {
      text-align: center;
      font-size: var(--font-size-xs);
      color: var(--gray-500);
      margin-top: var(--space-2);
      padding: var(--space-1);
    }

    body.dark .powered-by {
      color: var(--gray-600);
    }

    .powered-by a {
      color: var(--accent-primary);
      text-decoration: none;
      font-weight: 500;
    }

    body.dark .powered-by a {
      color: var(--accent-primary);
    }

    /* Response Timer */
    .response-timer {
      display: inline-block;
      font-size: var(--font-size-xs);
      color: var(--gray-500);
      margin-left: var(--space-2);
    }

    body.dark .response-timer {
      color: var(--gray-600);
    }

    /* Enhanced File Upload Styles */
    .file-input {
      display: none;
    }

    .file-menu {
      position: absolute;
      bottom: calc(100% + var(--space-2));
      left: 0;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-lg);
      padding: var(--space-2);
      min-width: 250px;
      box-shadow: var(--shadow-lg);
      z-index: var(--z-dropdown);
      opacity: 0;
      visibility: hidden;
      transform: translateY(8px);
      transition: all var(--transition-fast);
    }

    body.dark .file-menu {
      background: var(--dark-surface);
      border-color: var(--dark-surface-hover);
    }

    .file-menu.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .file-menu-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      width: 100%;
      background: none;
      border: none;
      color: inherit;
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      text-align: left;
      font-size: var(--font-size-sm);
    }

    .file-menu-item:hover {
      background: var(--gray-100);
    }

    .toggle-switch {
      width: 44px;
      height: 24px;
      background: var(--gray-300);
      border-radius: 12px;
      position: relative;
      transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .toggle-knob {
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    body.dark .toggle-switch {
      background: var(--gray-600);
    }

    /* Active State for Toggle handled by JS logic but ensuring styles are ready */
    .file-menu-item:hover .toggle-switch {
      background: var(--gray-400);
    }

    body.dark .file-menu-item:hover .toggle-switch {
      background: var(--gray-500);
    }

    /* Right-side Code View Panel */
    .code-view-panel {
      grid-area: codeview;
      height: 100vh;
      background: white;
      border-left: 1px solid var(--gray-300);
      z-index: 1000;
      display: none;
      flex-direction: column;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    body.dark .code-view-panel {
      background: var(--dark-bg-secondary);
      border-left-color: var(--dark-surface-hover);
    }

    .code-view-panel.open {
      display: flex;
    }

    .code-view-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4);
      border-bottom: 1px solid var(--gray-300);
      background: var(--gray-50);
    }

    body.dark .code-view-header {
      background: var(--dark-surface);
      border-bottom-color: var(--dark-surface-hover);
    }

    .code-view-header h3 {
      margin: 0;
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--gray-900);
    }

    body.dark .code-view-header h3 {
      color: var(--gray-100);
    }

    .code-view-close {
      background: none;
      border: none;
      color: var(--gray-500);
      font-size: var(--font-size-lg);
      cursor: pointer;
      padding: var(--space-2);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
    }

    .code-view-close:hover {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    body.dark .code-view-close:hover {
      background: var(--dark-surface-hover);
      color: var(--gray-300);
    }

    .code-view-actions {
      display: flex;
      gap: var(--space-2);
      padding: var(--space-3);
      border-bottom: 1px solid var(--gray-300);
      background: var(--gray-50);
    }

    body.dark .code-view-actions {
      background: var(--dark-surface);
      border-bottom-color: var(--dark-surface-hover);
    }

    .code-view-action {
      background: var(--accent-primary);
      border: none;
      border-radius: var(--radius-md);
      padding: var(--space-2) var(--space-3);
      color: white;
      font-size: var(--font-size-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .code-view-action:hover {
      background: var(--accent-primary-hover);
    }

    .code-view-content {
      flex: 1;
      overflow: auto;
      padding: var(--space-4);
    }

    .code-view-content pre {
      margin: 0;
      background: var(--gray-100);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      overflow: auto;
      font-family: 'Courier New', monospace;
      font-size: var(--font-size-sm);
      line-height: var(--leading-relaxed);
    }

    body.dark .code-view-content pre {
      background: var(--dark-bg-tertiary);
      color: var(--gray-300);
    }

    .code-view-output {
      padding: var(--space-4);
      border-top: 1px solid var(--gray-300);
      background: var(--gray-50);
    }

    body.dark .code-view-output {
      background: var(--dark-surface);
      border-top-color: var(--dark-surface-hover);
    }

    .code-view-output h4 {
      margin: 0 0 var(--space-2) 0;
      font-size: var(--font-size-base);
      font-weight: 600;
      color: var(--gray-900);
    }

    body.dark .code-view-output h4 {
      color: var(--gray-100);
    }

    .code-view-output pre {
      margin: 0;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      font-family: 'Courier New', monospace;
      font-size: var(--font-size-sm);
      color: var(--gray-800);
      max-height: 200px;
      overflow: auto;
    }

    body.dark .code-view-output pre {
      background: var(--dark-bg-tertiary);
      border-color: var(--dark-surface-hover);
      color: var(--gray-300);
    }

    /* Mobile responsiveness for code view */
    @media (max-width: 768px) {
      .code-view-panel {
        width: 100%;
        right: -100%;
      }
    }

    /* File Preview Styles */
    .file-preview {
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin: var(--space-3) 0;
      position: relative;
    }

    body.dark .file-preview {
      background: var(--dark-surface);
      border-color: var(--dark-surface-hover);
    }

    .file-preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-3);
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .file-icon {
      width: 40px;
      height: 40px;
      background: var(--accent-primary);
      color: white;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-lg);
    }

    .file-details h4 {
      font-size: var(--font-size-sm);
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: var(--space-1);
    }

    body.dark .file-details h4 {
      color: var(--gray-200);
    }

    .file-details p {
      font-size: var(--font-size-xs);
      color: var(--gray-600);
    }

    body.dark .file-details p {
      color: var(--gray-400);
    }

    .file-actions {
      display: flex;
      gap: var(--space-2);
    }

    .file-action {
      background: var(--accent-primary);
      border: none;
      border-radius: var(--radius-md);
      padding: var(--space-1) var(--space-2);
      color: white;
      font-size: var(--font-size-xs);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    .file-action:hover {
      background: var(--accent-primary-hover);
    }

    .file-content {
      max-height: 300px;
      overflow-y: auto;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: var(--font-size-sm);
      line-height: var(--leading-normal);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    body.dark .file-content {
      background: var(--dark-bg-primary);
      border-color: var(--dark-surface);
      color: var(--gray-300);
    }

    /* Image Preview Styles */
    .image-preview {
      max-width: 100%;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .image-preview:hover {
      transform: scale(1.02);
      box-shadow: var(--shadow-lg);
    }

    /* Enhanced Quick Replies */
    .quick-replies {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-4);
      flex-wrap: wrap;
    }


    .input-action {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .input-action svg {
      width: 22px;
      height: 22px;
      display: block;
      /* removes extra baseline space */
    }


    .quick-reply {
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-xl);
      padding: var(--space-2) var(--space-4);
      color: var(--gray-700);
      font-size: var(--font-size-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    body.dark .quick-reply {
      background: var(--dark-surface);
      border-color: var(--dark-surface-hover);
      color: var(--gray-300);
    }

    .quick-reply:hover {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    /* Image Grid */
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-3);
      margin-top: var(--space-3);
    }

    .image-grid img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 1px solid var(--gray-200);
    }

    body.dark .image-grid img {
      border-color: var(--dark-surface);
    }

    .image-grid img:hover {
      transform: scale(1.02);
      box-shadow: var(--shadow-md);
    }

    /* Enhanced Responsive Design */
    @media (max-width: 1024px) {
      .sidebar {
        width: 280px;
        max-width: 280px;
      }

      .starter-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      body {
        grid-template-columns: 1fr;
        grid-template-areas:
          "header"
          "main"
          "input";
      }

      body.mobile-banner-shown {
        padding-top: 60px;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: -320px;
        height: 100vh;
        z-index: var(--z-modal);
        box-shadow: var(--shadow-xl);
        width: 320px !important;
        max-width: 320px !important;
        resize: none;
      }

      .sidebar.show {
        left: 0;
      }

      .sidebar.collapsed {
        width: 320px !important;
      }

      .sidebar-toggle {
        display: block;
      }

      .sidebar-toggle-desktop {
        display: none;
      }

      .chat-container {
        padding: var(--space-4);
      }

      .input-area {
        padding: var(--space-4);
      }

      .header {
        padding: var(--space-4);
      }

      .message.user {
        max-width: 85%;
      }

      .message.bot {
        max-width: 95%;
      }

      .starter-grid {
        grid-template-columns: 1fr;
      }

      .starter-item {
        padding: var(--space-3);
      }
    }

    @media (max-width: 480px) {
      .header-title {
        font-size: var(--font-size-lg);
      }

      .model-button {
        min-width: 80px;
        padding: var(--space-2);
      }

      .model-button span {
        display: none;
      }

      .chat-container {
        padding: var(--space-3);
      }

      .input-area {
        padding: var(--space-3);
      }

      .message.user {
        max-width: 90%;
      }

      .message.bot {
        max-width: 100%;
      }
    }

    /* Scrollbar Styles */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gray-400);
      border-radius: var(--radius-xl);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-500);
    }

    body.dark ::-webkit-scrollbar-thumb {
      background: var(--gray-600);
    }

    body.dark ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-500);
    }

    /* Loading States */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      color: var(--gray-500);
      font-style: italic;
      padding: var(--space-2) 0;
    }

    .typing-dots {
      display: flex;
      gap: var(--space-1);
    }

    .typing-dot {
      width: 4px;
      height: 4px;
      background: var(--gray-500);
      border-radius: 50%;
      animation: typingDot 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) {
      animation-delay: -0.32s;
    }

    .typing-dot:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes typingDot {

      0%,
      80%,
      100% {
        transform: scale(0.8);
        opacity: 0.5;
      }

      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message {
      animation: fadeIn var(--transition-normal);
    }

    /* Focus States */
    *:focus-visible {
      outline: 2px solid var(--accent-primary);
      outline-offset: 2px;
    }

    /* Selection */
    ::selection {
      background: var(--accent-primary);
      color: white;
    }

    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {

      .sidebar-button,
      .start-button,
      .quick-reply,
      .starter-item {
        min-height: 44px;
      }

      .input-action,
      .send-button {
        min-width: 44px;
        min-height: 44px;
      }
    }

    /* Welcome Popup Styles */
    .welcome-popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: var(--z-welcome);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-normal);
    }

    .welcome-popup-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .welcome-popup {
      background: white;
      border-radius: var(--radius-2xl);
      padding: var(--space-8);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
      transform: scale(0.9) translateY(20px);
      transition: all var(--transition-normal);
      text-align: center;
    }

    body.dark .welcome-popup {
      background: var(--dark-bg-secondary);
      border: 1px solid var(--dark-surface);
    }

    .welcome-popup-overlay.show .welcome-popup {
      transform: scale(1) translateY(0);
    }

    .welcome-popup-header {
      margin-bottom: var(--space-6);
    }

    .welcome-popup-title {
      font-size: var(--font-size-3xl);
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: var(--space-3);
      line-height: var(--leading-tight);
    }

    body.dark .welcome-popup-title {
      color: var(--gray-100);
    }

    .welcome-popup-subtitle {
      font-size: var(--font-size-lg);
      color: var(--gray-600);
      line-height: var(--leading-relaxed);
    }

    body.dark .welcome-popup-subtitle {
      color: var(--gray-400);
    }

    .welcome-popup-content {
      margin-bottom: var(--space-8);
    }

    .welcome-popup-features {
      display: grid;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
      text-align: left;
    }

    .welcome-feature {
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
    }

    .welcome-feature-icon {
      width: 24px;
      height: 24px;
      background: var(--accent-primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-sm);
      flex-shrink: 0;
      margin-top: 2px;
    }

    .welcome-feature-text {
      flex: 1;
    }

    .welcome-feature-title {
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: var(--space-1);
    }

    body.dark .welcome-feature-title {
      color: var(--gray-100);
    }

    .welcome-feature-description {
      font-size: var(--font-size-sm);
      color: var(--gray-600);
      line-height: var(--leading-relaxed);
    }

    body.dark .welcome-feature-description {
      color: var(--gray-400);
    }

    .welcome-popup-actions {
      display: flex;
      gap: var(--space-3);
      justify-content: center;
    }

    .welcome-popup-button {
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-lg);
      font-weight: 600;
      font-size: var(--font-size-base);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: none;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .welcome-popup-button.primary {
      background: var(--accent-primary);
      color: white;
    }

    .welcome-popup-button.primary:hover {
      background: var(--accent-primary-hover);
      transform: translateY(-1px);
    }

    .welcome-popup-button.secondary {
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }

    body.dark .welcome-popup-button.secondary {
      background: var(--dark-surface);
      color: var(--gray-300);
      border-color: var(--dark-surface-hover);
    }

    .welcome-popup-button.secondary:hover {
      background: var(--gray-200);
      transform: translateY(-1px);
    }

    body.dark .welcome-popup-button.secondary:hover {
      background: var(--dark-surface-hover);
    }

    @media (max-width: 768px) {
      .welcome-popup {
        padding: var(--space-6);
        margin: var(--space-4);
      }

      .welcome-popup-title {
        font-size: var(--font-size-2xl);
      }

      .welcome-popup-actions {
        flex-direction: column;
      }

      .welcome-popup-button {
        width: 100%;
        justify-content: center;
      }
    }

    /* Tutorial Styles */
    .tutorial-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: var(--z-welcome);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-normal);
    }

    .tutorial-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .tutorial-highlight {
      position: absolute;
      border: 3px solid var(--accent-primary);
      border-radius: var(--radius-lg);
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8);
      pointer-events: none;
      z-index: calc(var(--z-welcome) + 1);
      transition: all var(--transition-normal);
    }

    .tutorial-tooltip {
      position: absolute;
      background: white;
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      max-width: 350px;
      box-shadow: var(--shadow-xl);
      z-index: calc(var(--z-welcome) + 2);
      transform: scale(0.9);
      opacity: 0;
      transition: all var(--transition-normal);
    }

    body.dark .tutorial-tooltip {
      background: var(--dark-bg-secondary);
      border: 1px solid var(--dark-surface);
    }

    .tutorial-tooltip.show {
      transform: scale(1);
      opacity: 1;
    }

    .tutorial-tooltip-header {
      margin-bottom: var(--space-4);
    }

    .tutorial-tooltip-title {
      font-size: var(--font-size-xl);
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: var(--space-2);
    }

    body.dark .tutorial-tooltip-title {
      color: var(--gray-100);
    }

    .tutorial-tooltip-description {
      color: var(--gray-600);
      line-height: var(--leading-relaxed);
    }

    body.dark .tutorial-tooltip-description {
      color: var(--gray-400);
    }

    .tutorial-tooltip-actions {
      display: flex;
      gap: var(--space-3);
      justify-content: flex-end;
      margin-top: var(--space-6);
    }

    .tutorial-button {
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-lg);
      font-weight: 500;
      font-size: var(--font-size-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: none;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .tutorial-button.primary {
      background: var(--accent-primary);
      color: white;
    }

    .tutorial-button.primary:hover {
      background: var(--accent-primary-hover);
    }

    .tutorial-button.secondary {
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }

    body.dark .tutorial-button.secondary {
      background: var(--dark-surface);
      color: var(--gray-300);
      border-color: var(--dark-surface-hover);
    }

    .tutorial-button.secondary:hover {
      background: var(--gray-200);
    }

    body.dark .tutorial-button.secondary:hover {
      background: var(--dark-surface-hover);
    }

    .tutorial-progress {
      position: fixed;
      top: var(--space-6);
      right: var(--space-6);
      background: white;
      border-radius: var(--radius-xl);
      padding: var(--space-3) var(--space-4);
      box-shadow: var(--shadow-lg);
      z-index: calc(var(--z-welcome) + 3);
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--gray-700);
    }

    body.dark .tutorial-progress {
      background: var(--dark-bg-secondary);
      color: var(--gray-300);
      border: 1px solid var(--gray-500);
      /* Fixed border */
    }

    /* Message Navigation Sidebar */
    .message-nav-sidebar {
      position: fixed;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: var(--z-fixed);
      padding: 10px 5px;
      pointer-events: none;
    }


    .nav-line-container {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      pointer-events: auto;
      cursor: pointer;
    }

    .nav-line {
      width: 20px;
      height: 2px;
      background: var(--gray-400);
      transition: all var(--transition-fast);
      border-radius: 1px;
    }

    .nav-line-container:hover .nav-line {
      width: 30px;
      background: var(--accent-primary);
      height: 3px;
    }

    .nav-tooltip {
      position: absolute;
      right: 35px;
      background: var(--gray-800);
      color: white;
      padding: 6px 10px;
      border-radius: var(--radius-md);
      font-size: var(--font-size-xs);
      white-space: nowrap;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-fast);
      box-shadow: var(--shadow-md);
      pointer-events: none;
    }

    .nav-line-container:hover .nav-tooltip {
      opacity: 1;
      visibility: visible;
      right: 40px;
    }

    body.dark .nav-line {
      background: var(--gray-600);
    }

    body.dark .nav-line-container:hover .nav-line {
      background: var(--gray-100);
    }

    body.dark .nav-tooltip {
      background: var(--dark-surface);
      border: 1px solid var(--dark-surface-hover);
    }
  </style>


</head>

<body>


  <!-- Welcome Popup -->
  <div class="welcome-popup-overlay" id="welcomePopup">
    <div class="welcome-popup">
      <img src="https://i.ibb.co/wNMJSyn6/1000038672.png" alt="Welcome to PRO" class="welcome-popup-img">

      <div class="welcome-popup-actions">
        <button class="welcome-popup-button" onclick="closeWelcomePopup()">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <!-- Tutorial Overlay -->
  <div class="tutorial-overlay" id="tutorialOverlay">
    <div class="tutorial-highlight" id="tutorialHighlight"></div>
    <div class="tutorial-tooltip" id="tutorialTooltip">
      <div class="tutorial-tooltip-header">
        <div class="tutorial-tooltip-title" id="tutorialTitle"></div>
        <div class="tutorial-tooltip-description" id="tutorialDescription"></div>
      </div>
      <div class="tutorial-tooltip-actions">
        <button class="tutorial-button secondary" onclick="skipTutorial()">
          <i class="fas fa-times"></i>
          Skip
        </button>
        <button class="tutorial-button primary" onclick="nextTutorialStep()">
          <span id="tutorialButtonText">Next</span>
          <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>
    <div class="tutorial-progress" id="tutorialProgress">
      Step <span id="tutorialCurrentStep">1</span> of <span id="tutorialTotalSteps">4</span>
    </div>
  </div>

  <!-- Share Chat QR Dropdown -->
  <div class="share-dropdown" id="shareDropdown">
    <div class="qr-code-container" id="qrCodeContainer" onclick="copyShareLink()" title="Click to copy link">
      <canvas id="qrCanvas"></canvas>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <a href="https://vo-ai.netlify.app" target="_blank" class="header-title"><img
          src="https://image2url.com/images/1758474233044-915e0111-d05a-44c0-a174-4ddf31d3476e.png" alt="VOAI Logo"
          style="height: 40px"></a> <!-- Conversation Name Display -->
      <div class="conversation-name" id="conversationName"></div>
      <!-- Share Chat Button -->
      <button class="share-chat-btn" id="shareChatBtn" onclick="openShareModal()" title="Share Chat"
        style="display: none;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M18 8C19.6569 8 21 6.65685 21 5C21 3.34315 19.6569 2 18 2C16.3431 2 15 3.34315 15 5C15 5.12548 15.0077 5.24917 15.0227 5.37061L8.08259 9.19346C7.54305 8.46607 6.66899 8 5.66667 8C3.82572 8 2.33333 9.49238 2.33333 11.3333C2.33333 13.1743 3.82572 14.6667 5.66667 14.6667C6.66899 14.6667 7.54305 14.2006 8.08259 13.4732L15.0227 17.2961C15.0077 17.4175 15 17.5412 15 17.6667C15 19.3235 16.3431 20.6667 18 20.6667C19.6569 20.6667 21 19.3235 21 17.6667C21 16.0098 19.6569 14.6667 18 14.6667C17.0318 14.6667 16.1898 15.1006 15.6429 15.7866L8.70272 11.9637C8.71774 11.8423 8.72545 11.7186 8.72545 11.5931C8.72545 11.4676 8.71774 11.3439 8.70272 11.2225L15.6429 7.39967C16.1898 8.08566 17.0318 8.51959 18 8.51959V8Z"
            fill="currentColor" />
        </svg>
      </button>
    </div>

    <!-- Upgrade to Pro Button -->
    <div class="upgrade-button-container" id="upgradeBtnContainer">
      <a href="/pricing.html" class="upgrade-button">
        <i class="fa-solid fa-circle-arrow-up"></i>
        <span>Upgrade to Pro</span>
      </a>
      <button class="dismiss-upgrade-btn" onclick="dismissUpgradeButton(event)" title="Dismiss">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- New Model Selector with Hover Text -->
    <div class="model-selector">
      <div class="model-buttons">
        <button class="model-button active"
          onclick="switchModel('lixern', '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', 'meta-llama/llama-4-scout-17b-16e-instruct')">
          <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path fill="currentColor"
              d="M14.415 3.308c2.074-.736 4.31-.846 5.717.56c1.406 1.407 1.296 3.643.56 5.717A14.5 14.5 0 0 1 19.552 12c.478.82.862 1.632 1.14 2.415c.736 2.075.846 4.31-.56 5.717c-1.407 1.406-3.643 1.296-5.717.56A14.5 14.5 0 0 1 12 19.552c-.82.478-1.632.862-2.415 1.14c-2.074.736-4.31.846-5.717-.56c-1.406-1.407-1.296-3.642-.56-5.716A14.5 14.5 0 0 1 4.446 12c-.477-.82-.86-1.633-1.138-2.416c-.736-2.074-.846-4.31.56-5.716s3.642-1.296 5.716-.56c.783.278 1.596.661 2.416 1.138a14.5 14.5 0 0 1 2.415-1.138M5.703 13.884q-.304.619-.51 1.201c-.672 1.892-.457 3.087.09 3.633c.545.546 1.74.762 3.632.09q.582-.207 1.2-.512a22.5 22.5 0 0 1-2.358-2.054a22 22 0 0 1-2.054-2.358m12.593 0a22.5 22.5 0 0 1-2.054 2.36a22 22 0 0 1-2.358 2.052q.619.304 1.2.512c1.893.67 3.088.456 3.634-.09s.76-1.741.09-3.633q-.208-.583-.512-1.201M12 6.812a20 20 0 0 0-2.828 2.36A20 20 0 0 0 6.812 12a20 20 0 0 0 2.36 2.828a20 20 0 0 0 2.827 2.36a20 20 0 0 0 2.83-2.36A20 20 0 0 0 17.186 12a20 20 0 0 0-2.359-2.828A20 20 0 0 0 12 6.812M12 10a2 2 0 1 1 0 4a2 2 0 0 1 0-4M8.915 5.192c-1.892-.67-3.087-.456-3.633.09s-.761 1.74-.09 3.633q.207.582.511 1.2a22.5 22.5 0 0 1 2.055-2.357a22.5 22.5 0 0 1 2.357-2.055a11 11 0 0 0-1.2-.51m9.803.09c-.546-.546-1.741-.76-3.633-.09q-.583.207-1.201.511a22 22 0 0 1 2.358 2.054a22.5 22.5 0 0 1 2.054 2.358q.304-.617.512-1.199c.67-1.892.456-3.088-.09-3.634" />
          </svg>
          <span>lixern</span>
          <div class="tooltip">The fastest</div>
        </button>
      </div>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <button class="sidebar-toggle-desktop" onclick="toggleSidebarCollapse()" aria-label="Collapse sidebar">
        <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M5 5h8v14H5zm14 14h-4V5h4zM4 3a1 1 0 0 0-1 1v16a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1zm7 9L7 8.5v7z" />
        </svg>
      </button>
      <h2 class="sidebar-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        Chats
      </h2>
      <div class="sidebar-actions">
        <button class="sidebar-button" onclick="resetConversation()" title="Start new chat">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          New Chat
        </button>
      </div>
    </div>


    <!-- Collapsed Sidebar Icons -->
    <div class="sidebar-icons">
      <button class="sidebar-icon" onclick="resetConversation()" title="New Chat">
        <i class="fas fa-plus"></i>
      </button>
      <button class="sidebar-icon" onclick="toggleTheme()" title="Toggle Theme">
        <i class="fas fa-moon" id="collapsedThemeIcon"></i>
      </button>
      <button class="sidebar-icon" onclick="showMemorySection()" title="Memory">
        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M13 4H6a1 1 0 0 0-1 1v10.337A3.5 3.5 0 0 1 6.5 15H19v-5h2v11a1 1 0 0 1-1 1H6.5A3.5 3.5 0 0 1 3 18.5V5a3 3 0 0 1 3-3h7zM6.5 17a1.5 1.5 0 0 0 0 3H19v-3zM18.53.33a.507.507 0 0 1 .94 0l.254.61a4.37 4.37 0 0 0 2.25 2.327l.718.32a.53.53 0 0 1 0 .962l-.76.338a4.36 4.36 0 0 0-2.218 2.25l-.247.566a.506.506 0 0 1-.934 0l-.246-.565a4.36 4.36 0 0 0-2.22-2.251l-.76-.338a.53.53 0 0 1 0-.963l.718-.32A4.37 4.37 0 0 0 18.276.942z" />
        </svg>
      </button>
      <button class="sidebar-icon" onclick="showHistorySection()" title="History">
        <i class="fas fa-history"></i>
      </button>
    </div>

    <div class="sidebar-content">
      <div class="history-section">
        <h3 class="section-title">
          Recent Chats
        </h3>
        <div class="history-list" id="historyList">
          <div class="empty-state">
            <p>No saved chats yet</p>
          </div>
        </div>
      </div>

      <div class="memory-section"
        style="margin-top: var(--space-8); border-top: 1px solid var(--gray-100); padding-top: var(--space-6);">
        <h3 class="section-title">
          Memory
        </h3>
        <textarea class="memory-textarea" id="memoryInput"
          placeholder="Add context about yourself that the AI should remember..." rows="4"></textarea>
        <div class="memory-actions">
          <button class="sidebar-button" onclick="saveMemory()">
            <i class="fas fa-save"></i>
            Save
          </button>
          <button class="sidebar-button secondary" onclick="clearMemory()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
              <path fill="currentColor"
                d="M17 6h5v2h-2v13a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V8H2V6h5V3a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v3Zm1 2H6v12h12V8Zm-4.586 6l1.768 1.768l-1.414 1.414L12 15.414l-1.768 1.768l-1.414-1.414L10.586 14l-1.768-1.768l1.414-1.414L12 12.586l1.768-1.768l1.414 1.414L13.414 14ZM9 4v2h6V4H9Z" />
            </svg>
            Clear
          </button>
        </div>
      </div>


    </div>
    <div class="sidebar-footer"
      style="padding: var(--space-4) var(--space-6); border-top: 1px solid var(--gray-100); display: flex; align-items: center; justify-content: space-between;">
      <button class="sidebar-icon" onclick="toggleSettings()" title="Settings"
        style="background: transparent; width: 32px; height: 32px;">
        <i class="fas fa-cog"></i>
      </button>
    </div>
  </aside>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Settings</h3>
        <button class="modal-close" onclick="toggleSettings()">&times;</button>
      </div>
      <div class="settings-tabs">
        <button class="settings-tab active" onclick="switchSettingsTab('appearance')">Appearance</button>
        <button class="settings-tab" onclick="switchSettingsTab('profile')">Profile</button>
        <button class="settings-tab" onclick="switchSettingsTab('data')">Data</button>
        <button class="settings-tab" onclick="switchSettingsTab('connections')">Connections</button>
      </div>
      <div class="modal-body">
        <!-- Appearance Tab -->
        <div id="tab-appearance" class="settings-tab-content active">
          <div class="settings-group">
            <label class="settings-label">User Name</label>
            <input type="text" class="settings-input" id="settingsUserName" placeholder="Enter your name">
          </div>
          <div class="settings-group">
            <label class="settings-label">Language</label>
            <select class="settings-input" id="settingsLanguage">
              <option value="en">English</option>
              <option value="ar">Arabic</option>
            </select>
          </div>
          <h3 class="settings-label">Theme</h3>
          <button class="sidebar-icon" onclick="toggleTheme()" title="Toggle theme" style="
            background: transparent;
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
          " onmouseover="this.style.background='rgba(0,0,0,0.1)'; this.style.transform='scale(1.1)';"
            onmouseout="this.style.background='transparent'; this.style.transform='scale(1)';">
            <i class="fas fa-moon" style="font-size: 18px; color: #555;"></i>
          </button>

        </div>

        <!-- Profile Tab -->
        <div id="tab-profile" class="settings-tab-content">
          <div class="settings-group">
            <label class="settings-label">Full Name</label>
            <input type="text" class="settings-input" id="profileName" placeholder="Your Name">
          </div>
          <div class="settings-group">
            <label class="settings-label">Email</label>
            <input type="email" class="settings-input" id="profileEmail" readonly
              style="background-color: var(--gray-100); cursor: not-allowed; opacity: 0.7;">
          </div>
          <div class="settings-group">
            <label class="settings-label">New Password</label>
            <input type="password" class="settings-input" id="profilePassword"
              placeholder="Leave blank to keep current">
          </div>
          <div class="settings-group">
            <button class="sidebar-button" onclick="updateProfile(this)" style="width: 100%; justify-content: center;">
              <i class="fas fa-save"></i> Update Profile
            </button>
          </div>
        </div>

        <!-- Data Tab -->
        <div id="tab-data" class="settings-tab-content">
          <div class="settings-group">
            <label class="settings-label">Export Data</label>
            <p style="font-size: var(--font-size-xs); color: var(--gray-500); margin-bottom: var(--space-2);">Download
              your chat history and settings as a JSON file.</p>
            <button class="sidebar-button" onclick="exportUserData()" style="width: 100%;">
              <i class="fas fa-download"></i> Export JSON
            </button>
          </div>
          <div class="settings-group">
            <label class="settings-label">Import Data</label>
            <p style="font-size: var(--font-size-xs); color: var(--gray-500); margin-bottom: var(--space-2);">Restore
              your data from a previously exported JSON file.</p>
            <input type="file" id="importFileInput" style="display: none;" accept=".json"
              onchange="importUserData(event)">
            <button class="sidebar-button secondary" onclick="document.getElementById('importFileInput').click()"
              style="width: 100%;">
              <i class="fas fa-upload"></i> Import JSON
            </button>
          </div>
        </div>

        <!-- Connections Tab -->
        <div id="tab-connections" class="settings-tab-content">
          <div class="settings-group">
            <label class="settings-label">Google Services</label>
            <div style="display: flex; flex-direction: column; gap: var(--space-3);">
              <button class="sidebar-button secondary" onclick="connectGmail()" style="justify-content: flex-start;">
                <i class="fab fa-google" style="color: #4285F4;"></i> Connect Gmail
              </button>
              <button class="sidebar-button secondary" onclick="connectGoogleCalendar()"
                style="justify-content: flex-start;">
                <i class="fas fa-calendar-alt" style="color: #34A853;"></i> Connect Calendar
              </button>
              <br>
              <label class="settings-label">GitHub</label>
              <p style="font-size: var(--font-size-xs); color: var(--gray-500); margin-bottom: var(--space-2);">Connect
                your GitHub account to use GitHub actions.</p>
              <button class="sidebar-button secondary" onclick="connectGitHub()" style="justify-content: flex-start;">
                <i class="fab fa-github" style="color: #24292e;"></i> Connect GitHub
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="sidebar-button" onclick="saveSettings()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast" class="toast">Settings saved!</div>

  <style>
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: var(--z-modal);
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: white;
      width: 90%;
      max-width: 500px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      animation: modalFadeIn 0.3s ease;
    }

    body.dark .modal-content {
      background: var(--dark-bg-secondary);
      color: white;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: var(--space-4) var(--space-6);
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    body.dark .modal-header {
      border-bottom-color: var(--dark-surface);
    }

    .modal-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray-500);
    }

    .modal-body {
      padding: var(--space-6);
      min-height: 300px;
    }

    .settings-tabs {
      display: flex;
      border-bottom: 1px solid var(--gray-100);
      padding: 0 var(--space-6);
    }

    body.dark .settings-tabs {
      border-bottom-color: var(--dark-surface);
    }

    .settings-tab {
      padding: var(--space-3) var(--space-4);
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-weight: 500;
      color: var(--gray-500);
      transition: all var(--transition-fast);
    }

    .settings-tab.active {
      color: var(--accent-primary);
      border-bottom-color: var(--accent-primary);
    }

    body.dark .settings-tab.active {
      color: white;
      border-bottom-color: white;
    }

    .settings-tab-content {
      display: none;
    }

    .settings-tab-content.active {
      display: block;
    }

    .color-options {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-2);
    }

    .color-option {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all var(--transition-fast);
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.active {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px white, 0 0 0 4px var(--accent-primary);
    }

    body.dark .color-option.active {
      box-shadow: 0 0 0 2px var(--dark-bg-secondary), 0 0 0 4px white;
    }

    .color-option.default {
      background-color: #3c4043;
    }


    .color-option.yellow {
      background-color: #ffc107;
    }

    .color-option.pink {
      background-color: #e83e8c;
    }

    .color-option.orange {
      background-color: #fd7e14;
    }

    .color-option.maroon {
      background-color: #800000;
    }

    /* Bubble Color Classes */
    .bubble-blue {
      background-color: #007bff !important;
      color: white !important;
    }

    .bubble-yellow {
      background-color: #ffc107 !important;
      color: black !important;
    }

    .bubble-pink {
      background-color: #e83e8c !important;
      color: white !important;
    }

    .bubble-orange {
      background-color: #fd7e14 !important;
      color: white !important;
    }

    .bubble-maroon {
      background-color: #800000 !important;
      color: white !important;
    }

    /* Image Gallery Styles */
    .image-gallery {
      display: flex;
      gap: var(--space-3);
      overflow-x: auto;
      padding: var(--space-2) 0;
      margin-bottom: var(--space-4);
      scrollbar-width: thin;
      scrollbar-color: var(--gray-300) transparent;
    }

    .image-gallery::-webkit-scrollbar {
      height: 6px;
    }

    .image-gallery::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 10px;
    }

    .gallery-item {
      flex: 0 0 200px;
      height: 150px;
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: transform var(--transition-fast);
      cursor: pointer;
    }

    .gallery-item:hover {
      transform: scale(1.02);
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .settings-group {
      margin-bottom: var(--space-4);
    }

    .settings-label {
      display: block;
      margin-bottom: var(--space-2);
      font-weight: 500;
      font-size: var(--font-size-sm);
    }

    .settings-input {
      width: 100%;
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-md);
      background: white;
      font-family: inherit;
    }

    body.dark .settings-input {
      background: var(--dark-surface);
      border-color: var(--dark-surface-hover);
      color: white;
    }

    .modal-footer {
      padding: var(--space-4) var(--space-6);
      border-top: 1px solid var(--gray-100);
      display: flex;
      justify-content: flex-end;
    }

    body.dark .modal-footer {
      border-top-color: var(--dark-surface);
    }

    /* Toast */
    .toast {
      visibility: hidden;
      min-width: 200px;
      margin-left: -100px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 12px 20px;
      position: fixed;
      left: 50%;
      bottom: 30px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.4s, visibility 0.4s, transform 0.4s;
      transform: translateY(20px);
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    body.dark .toast {
      background-color: #2d2d2d;
      color: #fff;
    }

    .toast.show {
      visibility: visible;
      opacity: 1;
      transform: translateY(0);
    }

    /* Share Chat Button */
    .share-chat-btn {
      background: none;
      border: none;
      color: var(--gray-600);
      cursor: pointer;
      padding: 8px;
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
      margin-left: 12px;
      position: relative;
    }

    .share-chat-btn:hover {
      background: var(--gray-100);
      color: var(--accent-primary);
    }

    body.dark .share-chat-btn {
      color: var(--gray-400);
    }

    body.dark .share-chat-btn:hover {
      background: var(--dark-surface-hover);
      color: var(--accent-primary);
    }

    /* Share Dropdown */
    .share-dropdown {
      display: none;
      position: absolute;
      top: 60px;
      right: 20px;
      background: transparent;
      border-radius: var(--radius-lg);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      animation: slideDown 0.2s ease;
    }

    .share-dropdown.show {
      display: block;
    }

    body.dark .share-dropdown {
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .share-dropdown .qr-code-container {
      padding: var(--space-2);
      cursor: pointer;
      transition: all var(--transition-fast);
      border-radius: var(--radius-lg);
      background: transparent;
    }

    .share-dropdown .qr-code-container:hover {
      transform: scale(1.05);
    }

    .share-dropdown #qrCanvas {
      display: block;
      width: 200px;
      height: 200px;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>

  <main class="main-content">
    <div class="message-nav-sidebar" id="messageNavSidebar"></div>
    <div class="chat-container" id="chatContainer">
      <div class="chat-messages" id="chatMessages">
        <div class="empty-state" id="emptyState">
          <div class="empty-state-icon"></div>
          <h1 class="empty-state-title" id="title"></h1>
          <p class="empty-state-subtitle">
            Help us improve VO
            <a href="https://vo-ai.netlify.app/feedback" class="link">feedback</a>
          </p>

          <style>
            .link {
              color: currentColor;
              text-decoration: none;
            }

            .link:hover {
              color: burlywood;
            }

            .link:visited {
              color: currentColor;
            }
          </style>

  </main>

  <!-- Input Area -->
  <div class="input-area">
    <div class="input-container">
      <div class="input-wrapper">
        <div class="input-actions">

          <!-- File Menu Button -->
          <button class="input-action" onclick="toggleFileMenu()" title="Attach file" aria-label="Attach file">
            <svg viewBox="0 0 24 24" fill="none" width="22" height="22">
              <path
                d="M13 3C13 2.44772 12.5523 2 12 2C11.4477 2 11 2.44772 11 3V11H3C2.44772 11 2 11.4477 2 12C2 12.5523 2.44772 13 3 13H11V21C11 21.5523 11.4477 22 12 22C12.5523 22 13 21.5523 13 21V13H21C21.5523 13 22 12.5523 22 12C22 11.4477 21.5523 11 21 11H13V3Z"
                fill="currentColor" />
            </svg>
          </button>




          <!-- NEW Connections Button -->
          <button class="input-action" onclick="toggleConnectionsMenu()" title="Connections" aria-label="Connections">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor">
              <path
                d="M21.007 8.222A3.738 3.738 0 0 0 15.045 5.2a3.737 3.737 0 0 0 1.156 6.583 2.988 2.988 0 0 1-2.668 1.67h-2.99a4.456 4.456 0 0 0-2.989 1.165V7.4a3.737 3.737 0 1 0-1.494 0v9.117a3.776 3.776 0 1 0 1.816.099 2.99 2.99 0 0 1 2.668-1.667h2.99a4.484 4.484 0 0 0 4.223-3.039 3.736 3.736 0 0 0 3.25-3.687zM4.565 3.738a2.242 2.242 0 1 1 4.484 0 2.242 2.242 0 0 1-4.484 0zm4.484 16.441a2.242 2.242 0 1 1-4.484 0 2.242 2.242 0 0 1 4.484 0zm8.221-9.715a2.242 2.242 0 1 1 0-4.485 2.242 2.242 0 0 1 0 4.485z" />
            </svg>
          </button>

          <!-- File Menu -->
          <div class="file-menu" id="fileMenu">
            <button class="file-menu-item" onclick="document.getElementById('fileInput').click()">
              <i class="fas fa-file"></i>
              <span>Upload Document</span>
            </button>
            <button class="file-menu-item" onclick="document.getElementById('imageInput').click()">
              <i class="fas fa-image"></i>
              <span>Upload Image</span>
            </button>
            <button class="file-menu-item" onclick="document.getElementById('archiveInput').click()">
              <i class="fas fa-file-archive"></i>
              <span>Upload ZIP/Archive</span>
            </button>
          </div>

          <!-- NEW CONNECTIONS DROPDOWN -->
          <div class="file-menu" id="connectionsMenu">
            <button class="file-menu-item" onclick="toggleAgentMode()" id="agentModeToggle">
              <i class="fa-solid fa-laptop" style="font-size: 20px; color: var(--agent-border);"></i>
              <span>Agent Mode</span>
              <div class="toggle-switch" style="margin-left: auto;">
                <div class="toggle-knob" id="agentModeKnob"></div>
              </div>
            </button>
            <div style="height: 1px; background: var(--gray-200); margin: 4px 0;"></div>
            <button class="file-menu-item" onclick="connectGmail()">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 512 512">
                <rect width="512" height="512" rx="15%" fill="#fff"></rect>
                <path d="M158 391v-142l-82-63V361q0 30 30 30" fill="#4285f4"></path>
                <path d="M154 248l102 77l102-77v-98l-102 77l-102-77" fill="#ea4335"></path>
                <path d="M354 391v-142l82-63V361q0 30-30 30" fill="#34a853"></path>
                <path d="M76 188l82 63v-98l-30-23c-27-21-52 0-52 26" fill="#c5221f"></path>
                <path d="M436 188l-82 63v-98l30-23c27-21 52 0 52 26" fill="#fbbc04"></path>
              </svg>
              <span>Connect Gmail</span>
            </button>
            <button class="file-menu-item" onclick="connectGoogleCalendar()">
              <svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                aria-hidden="true">

                <g>
                  <polygon fill="#FFFFFF"
                    points="195.368421 60.6315789 60.6315789 60.6315789 60.6315789 195.368421 195.368421 195.368421">
                  </polygon>
                  <polygon fill="#EA4335"
                    points="195.368421 256 256 195.368421 225.684211 190.196005 195.368421 195.368421 189.835162 223.098002">
                  </polygon>
                  <path
                    d="M0,195.368421 L0,235.789474 C0,246.955789 9.04421053,256 20.2105263,256 L60.6315789,256 L66.8568645,225.684211 L60.6315789,195.368421 L27.5991874,190.196005 L0,195.368421 Z"
                    fill="#188038"></path>
                  <path
                    d="M256,60.6315789 L256,20.2105263 C256,9.04421053 246.955789,0 235.789474,0 L195.368421,0 C191.679582,15.0358547 189.835162,26.1010948 189.835162,33.1957202 C189.835162,40.2903456 191.679582,49.4356319 195.368421,60.6315789 C208.777986,64.4714866 218.883249,66.3914404 225.684211,66.3914404 C232.485172,66.3914404 242.590435,64.4714866 256,60.6315789 Z"
                    fill="#1967D2"></path>
                  <polygon fill="#FBBC04"
                    points="256 60.6315789 195.368421 60.6315789 195.368421 195.368421 256 195.368421"></polygon>
                  <polygon fill="#34A853"
                    points="195.368421 195.368421 60.6315789 195.368421 60.6315789 256 195.368421 256"></polygon>
                  <path
                    d="M195.368421,0 L20.2105263,0 C9.04421053,0 0,9.04421053 0,20.2105263 L0,195.368421 L60.6315789,195.368421 L60.6315789,60.6315789 L195.368421,60.6315789 L195.368421,0 Z"
                    fill="#4285F4"></path>
                  <path
                    d="M88.2694737,165.153684 C83.2336842,161.751579 79.7473684,156.783158 77.8442105,150.214737 L89.5326316,145.397895 C90.5936842,149.44 92.4463158,152.572632 95.0905263,154.795789 C97.7178947,157.018947 100.917895,158.113684 104.656842,158.113684 C108.48,158.113684 111.764211,156.951579 114.509474,154.627368 C117.254737,152.303158 118.635789,149.338947 118.635789,145.751579 C118.635789,142.08 117.187368,139.082105 114.290526,136.757895 C111.393684,134.433684 107.755789,133.271579 103.410526,133.271579 L96.6568421,133.271579 L96.6568421,121.701053 L102.72,121.701053 C106.458947,121.701053 109.608421,120.690526 112.168421,118.669474 C114.728421,116.648421 116.008421,113.886316 116.008421,110.366316 C116.008421,107.233684 114.863158,104.741053 112.572632,102.871579 C110.282105,101.002105 107.385263,100.058947 103.865263,100.058947 C100.429474,100.058947 97.7010526,100.968421 95.68,102.804211 C93.6602819,104.644885 92.1418208,106.968942 91.2673684,109.557895 L79.6968421,104.741053 C81.2294737,100.395789 84.0421053,96.5557895 88.1684211,93.2378947 C92.2947368,89.92 97.5663158,88.2526316 103.966316,88.2526316 C108.698947,88.2526316 112.96,89.1621053 116.732632,90.9978947 C120.505263,92.8336842 123.469474,95.3768421 125.608421,98.6105263 C127.747368,101.861053 128.808421,105.498947 128.808421,109.541053 C128.808421,113.667368 127.814737,117.153684 125.827368,120.016842 C123.84,122.88 121.397895,125.069474 118.501053,126.602105 L118.501053,127.292632 C122.241568,128.834789 125.490747,131.367752 127.898947,134.618947 C130.341053,137.903158 131.570526,141.827368 131.570526,146.408421 C131.570526,150.989474 130.408421,155.082105 128.084211,158.669474 C125.76,162.256842 122.543158,165.086316 118.467368,167.141053 C114.374737,169.195789 109.776842,170.240124 104.673684,170.240124 C98.7621053,170.256842 93.3052632,168.555789 88.2694737,165.153684 Z M160.067368,107.149474 L147.233684,116.429474 L140.816842,106.694737 L163.84,90.0884211 L172.665263,90.0884211 L172.665263,168.421053 L160.067368,168.421053 Z"
                    fill="#4285F4"></path>
                </g>
              </svg>
              <span>Connect Google Calendar</span>
            </button>
            <button class="file-menu-item" onclick="connectGitHub()">
              <i class="fab fa-github" style="font-size: 20px;"></i>
              <span>Connect GitHub</span>
            </button>
          </div>

        </div>

        <div class="message-input-container">
          <div id="messageInputOverlay" class="message-input-overlay"></div>
          <textarea class="message-input" id="messageInput" placeholder="ask anything..." rows="1"
            onkeydown="handleKeyDown(event)" oninput="handleInput(this)" onscroll="syncScroll(this)"></textarea>
        </div>

        <button class="send-button" onclick="handleSend()" title="Send message" aria-label="Send message">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 5V19M12 5L6 11M12 5L18 11" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </button>
      </div>
      <!-- Powered by Vendo text -->
      <div class="powered-by">
        Powered by <a href="#" target="_blank">Vendo</a>
      </div>
    </div>
  </div>

  <!-- Right-side Code View Panel -->
  <div class="code-view-panel" id="codeViewPanel">
    <div class="code-view-header">
      <h3 id="codeViewTitle">Code View</h3>
      <button class="code-view-close" onclick="closeCodeView()" title="Close code view">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="code-view-tabs" id="codeViewTabs" style="display: none;">
      <button class="code-view-tab active" onclick="switchCodeViewTab('code')" id="tabCode">Code</button>
      <button class="code-view-tab" onclick="switchCodeViewTab('preview')" id="tabPreview">Preview</button>
    </div>
    <div class="code-view-actions">
      <button class="code-view-action" onclick="copyCodeFromView()" title="Copy code">
        <i class="fas fa-copy"></i>
        Copy Code
      </button>
      <button class="code-view-action" onclick="runCodeFromView()" title="Run code">
        <i class="fas fa-play"></i>
        Run Code
      </button>
      <button class="code-view-action" onclick="downloadCodeFromView()" title="Download code">
        <i class="fas fa-download"></i>
        Download
      </button>
    </div>
    <div class="code-view-content" id="codeViewContent">
      <pre><code id="codeViewCode"></code></pre>
    </div>
    <div class="code-view-output" id="codeViewOutput" style="display: none;">
      <div id="codeViewOutputContent"></div>
    </div>
  </div>

  <!-- Hidden File Inputs -->
  <input type="file" id="fileInput" class="file-input"
    accept=".txt,.js,.html,.css,.json,.pdf,.doc,.docx,.xlsx,.xls,.csv,.xml,.md,.rtf,.odt"
    onchange="handleFileUpload(event)" />
  <input type="file" id="imageInput" class="file-input" accept="image/*" onchange="handleImageUpload(event)" />
  <input type="file" id="videoInput" class="file-input" accept="video/*" onchange="handleVideoUpload(event)" />
  <input type="file" id="archiveInput" class="file-input" accept=".zip,.rar,.7z,.tar,.gz"
    onchange="handleArchiveUpload(event)" />

  <script>

    const CURRENT_PLAN = "free";


    // Usage Limits Configuration
    const MAX_MESSAGES = 5000;
    const MAX_UPLOADS = 200;
    const MAX_AGENT_USES = 500;
    const LIMIT_RESET_DURATION = 7 * 24 * 60 * 60 * 1000; // 1 week in ms

    // Constants and Configuration
    const PEXELS_API_KEY = 'K5dzLAy2IIVWjIu1IGQftPVQsA888jorGEfoSFev1vZFJR94gTzXIvbw';

    // DOM Elements
    const sidebar = document.getElementById('sidebar');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const fileInput = document.getElementById('fileInput');
    const imageInput = document.getElementById('imageInput');
    const videoInput = document.getElementById('videoInput');
    const archiveInput = document.getElementById('archiveInput');
    const memoryInput = document.getElementById('memoryInput');
    const historyList = document.getElementById('historyList');
    const emptyState = document.getElementById('emptyState');
    const fileMenu = document.getElementById('fileMenu');
    const connectionsMenu = document.getElementById('connectionsMenu');
    const themeToggle = document.getElementById('themeToggle');
    const conversationStarters = document.getElementById('conversationStarters');
    const mobileAppBanner = document.getElementById('mobileAppBanner');
    const downloadAppBtn = document.getElementById('downloadAppBtn');
    const conversationName = document.getElementById('conversationName');

    // Application State
    let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
    let currentRequest = null;
    let isImageSearchMode = false;
    let currentChatId = null;

    // Usage Tracking State
    let usageData = JSON.parse(localStorage.getItem('voaiUsageData')) || {
      messages: 0,
      uploads: 0,
      agentUses: 0,
      lastReset: Date.now()
    };

    // Load chat from URL on page load
    async function loadChatFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const chatId = urlParams.get('chatId');

      if (chatId) {
        try {
          const res = await fetch(`/api/chat/${chatId}`);
          if (res.ok) {
            const chat = await res.json();
            currentChatId = chatId;
            chatHistory = chat.history || [];
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));

            // Render messages
            hideEmptyState();
            chatHistory.forEach(msg => {
              if (msg.role === 'user') {
                addUserMessage(msg.content);
              } else if (msg.role === 'assistant') {
                addBotMessage(msg.content);
              }
            });
            updateConversationName();
          }
        } catch (err) {
          console.error('Failed to load chat:', err);
        }
      } else {
        // Load from localStorage as fallback
        if (chatHistory.length > 0) {
          hideEmptyState();
          chatHistory.forEach(msg => {
            if (msg.role === 'user') {
              addUserMessage(msg.content);
            } else if (msg.role === 'assistant') {
              addBotMessage(msg.content);
            }
          });
        }
      }
    }

    let touchStartX = 0;
    let touchEndX = 0;
    const SWIPE_THRESHOLD = 50;
    let responseStartTime = 0;

    let currentModel = {
      name: 'lixern',
      apiKey: '',
      modelId: 'openai/gpt-oss-120b',
      endpoint: '/api/groq'
    };

    // Enhanced File Type Detection
    const fileTypeMap = {
      // Documents
      'pdf': { icon: 'fas fa-file-pdf', color: '#d32f2f', type: 'document' },
      'doc': { icon: 'fas fa-file-word', color: '#1976d2', type: 'document' },
      'docx': { icon: 'fas fa-file-word', color: '#1976d2', type: 'document' },
      'odt': { icon: 'fas fa-file-alt', color: '#388e3c', type: 'document' },
      'rtf': { icon: 'fas fa-file-alt', color: '#795548', type: 'document' },
      'txt': { icon: 'fas fa-file-alt', color: '#616161', type: 'text' },
      'md': { icon: 'fas fa-file-alt', color: '#424242', type: 'text' },

      // Spreadsheets
      'xlsx': { icon: 'fas fa-file-excel', color: '#388e3c', type: 'spreadsheet' },
      'xls': { icon: 'fas fa-file-excel', color: '#388e3c', type: 'spreadsheet' },
      'csv': { icon: 'fas fa-file-csv', color: '#ff9800', type: 'spreadsheet' },

      // Code files
      'js': { icon: 'fas fa-file-code', color: '#f57c00', type: 'code' },
      'html': { icon: 'fas fa-file-code', color: '#e65100', type: 'code' },
      'css': { icon: 'fas fa-file-code', color: '#1976d2', type: 'code' },
      'json': { icon: 'fas fa-file-code', color: '#388e3c', type: 'code' },
      'xml': { icon: 'fas fa-file-code', color: '#ff5722', type: 'code' },
      'py': { icon: 'fas fa-file-code', color: '#3776ab', type: 'code' },
      'java': { icon: 'fas fa-file-code', color: '#ed8b00', type: 'code' },
      'cpp': { icon: 'fas fa-file-code', color: '#00599c', type: 'code' },
      'c': { icon: 'fas fa-file-code', color: '#a8b9cc', type: 'code' },

      // Images
      'jpg': { icon: 'fas fa-file-image', color: '#4caf50', type: 'image' },
      'jpeg': { icon: 'fas fa-file-image', color: '#4caf50', type: 'image' },
      'png': { icon: 'fas fa-file-image', color: '#2196f3', type: 'image' },
      'gif': { icon: 'fas fa-file-image', color: '#ff9800', type: 'image' },
      'bmp': { icon: 'fas fa-file-image', color: '#9c27b0', type: 'image' },
      'svg': { icon: 'fas fa-file-image', color: '#ff5722', type: 'image' },
      'webp': { icon: 'fas fa-file-image', color: '#607d8b', type: 'image' },

      // Videos
      'mp4': { icon: 'fas fa-file-video', color: '#f44336', type: 'video' },
      'avi': { icon: 'fas fa-file-video', color: '#e91e63', type: 'video' },
      'mov': { icon: 'fas fa-file-video', color: '#9c27b0', type: 'video' },
      'wmv': { icon: 'fas fa-file-video', color: '#673ab7', type: 'video' },
      'flv': { icon: 'fas fa-file-video', color: '#3f51b5', type: 'video' },
      'webm': { icon: 'fas fa-file-video', color: '#2196f3', type: 'video' },

      // Archives
      'zip': { icon: 'fas fa-file-archive', color: '#795548', type: 'archive' },
      'rar': { icon: 'fas fa-file-archive', color: '#8bc34a', type: 'archive' },
      '7z': { icon: 'fas fa-file-archive', color: '#cddc39', type: 'archive' },
      'tar': { icon: 'fas fa-file-archive', color: '#ff9800', type: 'archive' },
      'gz': { icon: 'fas fa-file-archive', color: '#ff5722', type: 'archive' },

      // Default
      'default': { icon: 'fas fa-file', color: '#757575', type: 'unknown' }
    };

    // Device Detection
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
        (window.innerWidth <= 768 && 'ontouchstart' in window);
    }

    function isTabletDevice() {
      return /iPad|Android/i.test(navigator.userAgent) && window.innerWidth >= 768 && window.innerWidth <= 1024;
    }

    // Initialize Application
    window.addEventListener('DOMContentLoaded', () => {
      initializeApp();
    });

    function initializeApp() {
      loadTheme();
      loadMemory();
      loadChatHistory();
      loadSidebarState();
      detectDeviceAndShowBanner();

      if (chatHistory.length > 0) {
        loadCurrentChat();
      }

      // Event Listeners
      setupEventListeners();

      // Initialize Usage Tracking
      initUsageTracking();
    }

    function initUsageTracking() {
      const now = Date.now();
      if (now - usageData.lastReset > LIMIT_RESET_DURATION) {
        usageData = {
          messages: 0,
          uploads: 0,
          agentUses: 0,
          lastReset: now
        };
        saveUsageData();
      }
    }

    function saveUsageData() {
      localStorage.setItem('voaiUsageData', JSON.stringify(usageData));
    }

    function checkUsageLimit(type) {
      // Check for reset first
      initUsageTracking();

      let limit = 0;
      let current = 0;
      let typeLabel = '';

      if (type === 'messages') {
        limit = MAX_MESSAGES;
        current = usageData.messages;
        typeLabel = 'messages';
      } else if (type === 'uploads') {
        limit = MAX_UPLOADS;
        current = usageData.uploads;
        typeLabel = 'uploads';
      } else if (type === 'agentUses') {
        limit = MAX_AGENT_USES;
        current = usageData.agentUses;
        typeLabel = 'agent interactions';
      }

      if (current >= limit) {
        showLimitNotification(typeLabel);
        return true;
      }
      return false;
    }

    function showLimitNotification(typeLabel) {
      const modalHTML = `
        <div class="message bot limit-notification">
          <div class="message-avatar">AI</div>
          <div class="message-content">
            <div class="message-bubble" style="border: 2px solid var(--accent-warning); background: rgba(234, 134, 0, 0.1);">
              <h3 style="color: var(--accent-warning); margin-bottom: 8px;"><i class="fas fa-exclamation-triangle"></i> Usage Limit Reached</h3>
              <p>You have reached your 1-week limit for <b>${typeLabel}</b>. To continue using VO with enhanced limits, please consider upgrading to VO Pro.</p>
              <div style="margin-top: 15px; display: flex; gap: 10px;">
                <a href="/pricing.html" class="sidebar-button" style="background: var(--accent-primary); color: white; text-decoration: none; padding: 8px 16px; border-radius: 8px; font-weight: bold; flex: 1; text-align: center;">
                  Check VO Pro
                </a>
                <button onclick="this.closest('.message').remove()" class="sidebar-button" style="flex: 1; text-align: center;">
                  Dismiss
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      chatMessages.insertAdjacentHTML('beforeend', modalHTML);
      scrollToBottom();
    }

    function detectDeviceAndShowBanner() {
      if (isMobileDevice() && !localStorage.getItem('mobileAppBannerDismissed')) {
        mobileAppBanner.classList.add('show');
        document.body.classList.add('mobile-banner-shown');

        // Set up APK download
        downloadAppBtn.href = './VOAI-App.apk';
        downloadAppBtn.download = 'VOAI-App.apk';
      }
    }

    function closeMobileBanner() {
      mobileAppBanner.classList.remove('show');
      document.body.classList.remove('mobile-banner-shown');
      localStorage.setItem('mobileAppBannerDismissed', 'true');
    }

    function setupEventListeners() {
      // Touch events for mobile
      document.addEventListener('touchstart', handleTouchStart, { passive: true });
      document.addEventListener('touchmove', handleTouchMove, { passive: false });
      document.addEventListener('touchend', handleTouchEnd, { passive: true });

      // Click outside to close dropdowns
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.input-actions')) {
          fileMenu.classList.remove('show');
        }
      });

      // Auto-resize textarea
      messageInput.addEventListener('input', () => autoResize(messageInput));

      // Prevent zoom on double tap for iOS
      let lastTouchEnd = 0;
      document.addEventListener('touchend', (event) => {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
    }

    // Sidebar State Management
    function loadSidebarState() {
      const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
      if (isCollapsed && window.innerWidth > 768) {
        sidebar.classList.add('collapsed');
      }
    }

    function toggleSidebarCollapse() {
      sidebar.classList.toggle('collapsed');
      localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
    }

    // Theme Management
    function loadTheme() {
      const isDark = localStorage.getItem('darkTheme') === 'true';
      if (isDark) {
        document.body.classList.add('dark');
      }
      updateThemeIcon();
      applyBubbleColors();
    }

    function toggleTheme() {
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');
      localStorage.setItem('darkTheme', isDark);
      updateThemeIcon();
    }

    function updateThemeIcon() {
      const isDark = document.body.classList.contains('dark');
      // Fix: Check if themeToggle exists before querying
      const themeToggleBtn = document.getElementById('themeToggle') || (typeof themeToggle !== 'undefined' ? themeToggle : null);
      if (!themeToggleBtn) return;

      const icon = themeToggleBtn.querySelector('i');
      const collapsedIcon = document.getElementById('collapsedThemeIcon');
      const iconClass = isDark ? 'fas fa-sun' : 'fas fa-moon';
      if (icon) icon.className = iconClass;
      if (collapsedIcon) collapsedIcon.className = iconClass;
    }

    // Memory Management
    function loadMemory() {
      const savedMemory = localStorage.getItem('botMemory');
      if (savedMemory) {
        memoryInput.value = savedMemory;
      }
    }

    function saveMemory() {
      const memoryText = memoryInput.value.trim();
      localStorage.setItem('botMemory', memoryText);

      // Update memory in current chat if exists
      if (currentChatId !== null) {
        const savedChats = JSON.parse(localStorage.getItem('savedChats')) || [];
        if (savedChats[currentChatId]) {
          savedChats[currentChatId].memory = memoryText;
          localStorage.setItem('savedChats', JSON.stringify(savedChats));
        }
      }

      // Add memory to chat context if not already present
      if (memoryText) {
        const memoryMessage = `[System Memory Note]: ${memoryText}`;
        if (!chatHistory.some(msg => msg.content.includes('[System Memory Note]'))) {
          chatHistory.push({ role: 'system', content: memoryMessage });
          localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }
      }

      // Show confirmation
      showSaveConfirmation();
    }

    function clearMemory() {
      if (confirm('Are you sure you want to clear your memory?')) {
        memoryInput.value = '';
        localStorage.removeItem('botMemory');

        // Remove memory from current chat if exists
        if (currentChatId !== null) {
          const savedChats = JSON.parse(localStorage.getItem('savedChats')) || [];
          if (savedChats[currentChatId]) {
            savedChats[currentChatId].memory = '';
            localStorage.setItem('savedChats', JSON.stringify(savedChats));
          }
        }

        // Remove memory message from chat history
        chatHistory = chatHistory.filter(msg => !msg.content.includes('[System Memory Note]'));
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
      }
    }

    function showSaveConfirmation() {
      const saveBtn = document.querySelector('.memory-actions .sidebar-button');
      const originalHTML = saveBtn.innerHTML;
      saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';
      saveBtn.style.background = 'var(--accent-success)';

      setTimeout(() => {
        saveBtn.innerHTML = originalHTML;
        saveBtn.style.background = '';
      }, 2000);
    }

    // Chat History Management
    function loadChatHistory() {
      const savedChats = JSON.parse(localStorage.getItem('savedChats')) || [];

      if (savedChats.length === 0) {
        historyList.innerHTML = '<div class="empty-state"><p>No saved chats yet</p></div>';
        return;
      }

      historyList.innerHTML = savedChats.map((chat, index) => `
        <div class="history-item ${currentChatId === index ? 'active' : ''}" onclick="loadSavedChat(${index})">
          <span class="history-text">${chat.name}</span>
          <button class="history-delete" onclick="deleteChatHistory(event, ${index})" title="Delete chat">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M17 6h5v2h-2v13a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V8H2V6h5V3a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v3Zm1 2H6v12h12V8Zm-4.586 6l1.768 1.768l-1.414 1.414L12 15.414l-1.768 1.768l-1.414-1.414L10.586 14l-1.768-1.768l1.414-1.414L12 12.586l1.768-1.768l1.414 1.414L13.414 14ZM9 4v2h6V4H9Z"/></svg>
          </button>
        </div>
      `).join('');
    }

    function loadCurrentChat() {
      hideEmptyState();
      chatHistory.forEach(msg => {
        if (msg.role === 'user') {
          addUserMessage(msg.content);
        } else if (msg.role === 'assistant') {
          addBotMessage(msg.content);
        }
      });

      // Update conversation name
      updateConversationName();
    }

    async function saveCurrentChat() {
      if (chatHistory.length === 0) return;

      try {
        if (currentChatId) {
          // Update existing chat
          await fetch(`/api/chat/${currentChatId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ history: chatHistory })
          });
        } else {
          // Create new chat
          const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ history: chatHistory })
          });
          const data = await res.json();
          currentChatId = data.id;

          // Update URL without reload
          const newUrl = `${window.location.pathname}?chatId=${currentChatId}`;
          window.history.pushState({ chatId: currentChatId }, '', newUrl);
        }

        // Also save to localStorage as backup
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        updateConversationName();
      } catch (err) {
        console.error('Failed to save chat:', err);
        // Fallback to localStorage only
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
      }
    }

    function loadSavedChat(index) {
      const savedChats = JSON.parse(localStorage.getItem('savedChats')) || [];
      if (index >= savedChats.length) return;

      const chat = savedChats[index];
      currentChatId = index;

      // Clear current chat
      chatMessages.innerHTML = '';
      chatHistory = [...chat.history];
      localStorage.setItem('chatHistory', JSON.stringify(chatHistory));

      // Load memory
      memoryInput.value = chat.memory || '';
      localStorage.setItem('botMemory', chat.memory || '');

      // Load messages
      hideEmptyState();
      chatHistory.forEach(msg => {
        if (msg.role === 'user') {
          addUserMessage(msg.content);
        } else if (msg.role === 'assistant') {
          addBotMessage(msg.content);
        }
      });

      // Close sidebar on mobile
      if (window.innerWidth <= 768) {
        sidebar.classList.remove('show');
      }

      loadChatHistory(); // Refresh to show active state
      updateMessageNav();

      // Update conversation name
      updateConversationName();
    }

    function deleteChatHistory(event, index) {
      event.stopPropagation();

      if (!confirm('Are you sure you want to delete this chat?')) return;

      const savedChats = JSON.parse(localStorage.getItem('savedChats')) || [];
      savedChats.splice(index, 1);
      localStorage.setItem('savedChats', JSON.stringify(savedChats));

      if (currentChatId === index) {
        currentChatId = null;
        resetConversation();
      } else if (currentChatId > index) {
        currentChatId--;
      }

      loadChatHistory();
    }

    // Update Conversation Name
    function updateConversationName() {
      const shareChatBtn = document.getElementById('shareChatBtn');

      if (chatHistory.length > 0 && chatHistory[0].role === 'user') {
        const firstMessage = chatHistory[0].content;
        const displayName = firstMessage.length > 30 ? firstMessage.substring(0, 30) + '...' : firstMessage;
        conversationName.textContent = displayName;

        // Show share button if chat has ID
        if (currentChatId && shareChatBtn) {
          shareChatBtn.style.display = 'block';
        }
      } else {
        conversationName.textContent = '';
        if (shareChatBtn) {
          shareChatBtn.style.display = 'none';
        }
      }
    }

    // Share Chat Functions
    function openShareModal() {
      if (!currentChatId) {
        alert('Please save the chat first by sending a message.');
        return;
      }

      const shareDropdown = document.getElementById('shareDropdown');
      const chatUrl = `${window.location.origin}${window.location.pathname}?chatId=${currentChatId}`;

      // Toggle dropdown
      const isVisible = shareDropdown.classList.contains('show');
      if (isVisible) {
        shareDropdown.classList.remove('show');
      } else {
        shareDropdown.classList.add('show');
        // Generate QR code with logo
        generateQRCodeWithLogo(chatUrl);
      }
    }

    function closeShareModal(event) {
      const shareDropdown = document.getElementById('shareDropdown');
      if (shareDropdown) {
        shareDropdown.classList.remove('show');
      }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function (event) {
      const shareDropdown = document.getElementById('shareDropdown');
      const shareChatBtn = document.getElementById('shareChatBtn');

      if (shareDropdown && shareChatBtn) {
        if (!shareDropdown.contains(event.target) && !shareChatBtn.contains(event.target)) {
          shareDropdown.classList.remove('show');
        }
      }
    });

    async function generateQRCodeWithLogo(url) {
      const canvas = document.getElementById('qrCanvas');
      const ctx = canvas.getContext('2d');
      const size = 200;
      canvas.width = size;
      canvas.height = size;

      // Generate QR code using a simple implementation
      // For production, you'd use a proper QR library like qrcode.js
      // This is a simplified version that creates a basic QR pattern

      // Fill white background
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, size, size);

      // Create QR code using external library
      try {
        // Use QRCode library to generate to a temporary div
        const tempDiv = document.createElement('div');
        const qr = new QRCode(tempDiv, {
          text: url,
          width: size,
          height: size,
          colorDark: '#000000',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });

        // Wait for QR code to be generated
        await new Promise(resolve => setTimeout(resolve, 100));

        // Get the generated canvas from QRCode library
        const qrCanvas = tempDiv.querySelector('canvas');
        if (qrCanvas) {
          ctx.drawImage(qrCanvas, 0, 0, size, size);
        }

        // Draw logo in the center
        const logo = new Image();
        logo.crossOrigin = 'anonymous';
        logo.onload = function () {
          const logoSize = size * 0.2; // Logo is 20% of QR code size
          const logoX = (size - logoSize) / 2;
          const logoY = (size - logoSize) / 2;

          // Draw white background for logo
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(logoX - 10, logoY - 10, logoSize + 20, logoSize + 20);

          // Draw logo
          ctx.drawImage(logo, logoX, logoY, logoSize, logoSize);
        };
        logo.src = '/QRlogo.png';
      } catch (err) {
        console.error('QR code generation error:', err);
        // Fallback: draw a simple pattern
        ctx.fillStyle = '#000000';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('QR Code', size / 2, size / 2);
      }
    }

    async function copyShareLink() {
      const chatUrl = `${window.location.origin}${window.location.pathname}?chatId=${currentChatId}`;

      try {
        await navigator.clipboard.writeText(chatUrl);

        // Show toast notification
        const toast = document.createElement('div');
        toast.className = 'toast show';
        toast.textContent = 'Link copied to clipboard!';
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 400);
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
        alert('Failed to copy link. Please try again.');
      }
    }

    // Model Management
    function switchModel(name, apiKey, modelId) {
      // Update active state for model buttons
      document.querySelectorAll('.model-button').forEach(btn => {
        btn.classList.toggle('active', btn.querySelector('span').textContent === name);
      });

      currentModel = { name, apiKey, modelId };
    }

    // Sidebar Management
    function toggleSidebar() {
      sidebar.classList.toggle('show');
    }

    // Touch Events for Mobile
    function handleTouchStart(event) {
      touchStartX = event.changedTouches[0].screenX;
    }

    function handleTouchMove(event) {
      if (sidebar.classList.contains('show')) {
        event.preventDefault();
      }
    }

    function handleTouchEnd(event) {
      touchEndX = event.changedTouches[0].screenX;
      handleSwipe();
    }

    function handleSwipe() {
      const difference = touchStartX - touchEndX;

      // Swipe left to right (open sidebar)
      if (difference < -SWIPE_THRESHOLD && !sidebar.classList.contains('show')) {
        toggleSidebar();
      }
      // Swipe right to left (close sidebar)
      else if (difference > SWIPE_THRESHOLD && sidebar.classList.contains('show')) {
        toggleSidebar();
      }
    }

    // Chat Management
    function startChat() {
      sendMessage("Hello!");
    }

    function resetConversation() {
      // Auto-save current chat before resetting
      if (chatHistory.length > 0) {
        saveCurrentChat();
      }

      chatMessages.innerHTML = '';
      chatHistory = [];
      currentChatId = null;
      localStorage.removeItem('chatHistory');
      messageInput.value = '';
      exitImageSearchMode();
      showEmptyState();
      updateMessageNav();

      // Clear conversation name
      conversationName.textContent = '';

      // Update URL to remove chatId
      window.history.pushState({}, '', window.location.pathname);
    }

    function showEmptyState() {
      if (!document.getElementById('emptyState')) {
        const emptyStateHTML = `
          <div class="empty-state" id="emptyState">
            <div class="empty-state-icon">
            </div>
            <h2 class="empty-state-title">VOAI Assistant</h2>
            <p class="empty-state-subtitle">Start a conversation to get professional assistance</p>
          
        `;
        chatMessages.innerHTML = emptyStateHTML;
      }
    }

    function hideEmptyState() {
      const emptyState = document.getElementById('emptyState');
      if (emptyState) {
        emptyState.remove();
      }
    }

    let isAgentMode = false;

    function toggleConnectionsMenu() {
      connectionsMenu.classList.toggle('show');
      // Close file menu if open
      fileMenu.classList.remove('show');

      // Update toggle UI state
      const knob = document.getElementById('agentModeKnob');
      if (isAgentMode) {
        knob.style.transform = 'translateX(20px)';
        knob.parentElement.style.background = 'var(--agent-border)';
      } else {
        knob.style.transform = 'translateX(0)';
        knob.parentElement.style.background = '#ccc';
      }
    }

    function toggleAgentMode() {
      isAgentMode = !isAgentMode;
      const inputArea = document.querySelector('.input-area');
      const knob = document.getElementById('agentModeKnob');

      if (isAgentMode) {
        inputArea.classList.add('agent-mode-active');
        knob.style.transform = 'translateX(20px)';
        knob.parentElement.style.background = 'var(--agent-border)';
        // Show a small toast or notification that Agent Mode is ON
        console.log("Agent Mode: ON - Enhanced reasoning and tool access enabled.");
      } else {
        inputArea.classList.remove('agent-mode-active');
        knob.style.transform = 'translateX(0)';
        knob.parentElement.style.background = '#ccc';
        console.log("Agent Mode: OFF - Standard mode active.");
      }

      setTimeout(() => {
        connectionsMenu.classList.remove('show');
      }, 300);
    }

    function addAgentStep(text, icon = 'fa-search', isLoading = true) {
      const stepId = 'step-' + Date.now();
      const stepHtml = `
        <div class="agent-step-box ${isLoading ? 'loading' : ''}" id="${stepId}">
          <i class="fas ${icon}"></i>
          <span>${text}</span>
        </div>
      `;

      // Find the last bot typing message or create a container
      let container = document.querySelector('.agent-steps-container');
      if (!container) {
        container = document.createElement('div');
        container.className = 'agent-steps-container';
        container.style.padding = '10px 20px';
        chatMessages.appendChild(container);
      }

      container.insertAdjacentHTML('beforeend', stepHtml);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return stepId;
    }

    function updateAgentStep(stepId, text, icon, isLoading = false) {
      const step = document.getElementById(stepId);
      if (step) {
        if (text) step.querySelector('span').textContent = text;
        if (icon) {
          const i = step.querySelector('i');
          i.className = `fas ${icon}`;
        }
        if (!isLoading) step.classList.remove('loading');
      }
    }

    function updateAgentSidebar(line, type = 'info') {
      const screen = document.getElementById('agentScreen');
      if (!screen) return;

      const lineDiv = document.createElement('div');
      lineDiv.className = `agent-screen-line ${type}`;

      if (type === 'cmd') {
        lineDiv.textContent = `> ${line}`;
      } else {
        lineDiv.textContent = line;
      }

      screen.appendChild(lineDiv);
      screen.scrollTop = screen.scrollHeight;

      // Also open the sidebar if it's not open
      if (!document.body.classList.contains('code-view-open')) {
        openAgentView();
      }
    }

    function openAgentView() {
      const codeViewPanel = document.getElementById('codeViewPanel');
      const title = document.getElementById('codeViewTitle');
      const content = document.getElementById('codeViewContent');
      const actions = document.querySelector('.code-view-actions');
      const tabs = document.getElementById('codeViewTabs');

      title.textContent = 'Agent Process';
      actions.style.display = 'none';
      tabs.style.display = 'none';

      // Clear content and add agent view
      content.innerHTML = `
        <div class="agent-view-panel">
          <div class="agent-screen-mockup" id="agentScreen">
            <div class="agent-screen-line success">Agent Mode Initialized...</div>
            <div class="agent-screen-line info">Waiting for task...</div>
          </div>
        </div>
      `;

      document.body.classList.add('code-view-open');
      codeViewPanel.classList.add('open');
    }

    // Enhanced File Management
    function toggleFileMenu() {
      fileMenu.classList.toggle('show');
    }

    function getFileExtension(filename) {
      return filename.split('.').pop().toLowerCase();
    }

    function getFileTypeInfo(filename) {
      const extension = getFileExtension(filename);
      return fileTypeMap[extension] || fileTypeMap['default'];
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Enhanced File Upload Handlers
    function handleFileUpload(event) {
      if (checkUsageLimit('uploads')) return;

      const file = event.target.files[0];
      if (!file) return;

      usageData.uploads++;
      saveUsageData();

      const fileTypeInfo = getFileTypeInfo(file.name);
      showFilePreview(file, fileTypeInfo);

      // Process file based on type
      processFile(file, fileTypeInfo);

      fileInput.value = '';
      fileMenu.classList.remove('show');
    }

    function handleImageUpload(event) {
      if (checkUsageLimit('uploads')) return;

      const file = event.target.files[0];
      if (!file) return;

      usageData.uploads++;
      saveUsageData();

      const fileTypeInfo = getFileTypeInfo(file.name);
      showImagePreview(file, fileTypeInfo);

      imageInput.value = '';
      fileMenu.classList.remove('show');
    }

    function handleVideoUpload(event) {
      if (checkUsageLimit('uploads')) return;

      const file = event.target.files[0];
      if (!file) return;

      usageData.uploads++;
      saveUsageData();

      const fileTypeInfo = getFileTypeInfo(file.name);
      showVideoPreview(file, fileTypeInfo);

      videoInput.value = '';
      fileMenu.classList.remove('show');
    }

    async function handleArchiveUpload(event) {
      if (checkUsageLimit('uploads')) return;

      const file = event.target.files[0];
      if (!file) return;

      usageData.uploads++;
      saveUsageData();

      const fileTypeInfo = getFileTypeInfo(file.name);

      // If agent mode is active and file is a ZIP, upload to server
      if (isAgentMode && file.name.toLowerCase().endsWith('.zip')) {
        try {
          addBotMessage(` Uploading ZIP file: ${file.name}...`);

          const formData = new FormData();
          formData.append('zip', file);

          const response = await fetch('/voai/upload-zip', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.ok) {
            addBotMessage(` ZIP file uploaded successfully! File ID: ${data.zipId}\n\nI can now extract, read, edit, create, and delete files in this ZIP. Would you like me to extract it and show you the contents?`);

            // Store zipId in a variable for the AI to use
            window.currentZipId = data.zipId;

            // Add zipId to chat history so AI knows about it
            chatHistory.push({
              role: 'user',
              content: `ZIP file uploaded: ${file.name}. ZIP ID: ${data.zipId}`
            });
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));

            // Automatically extract and list files
            setTimeout(() => {
              sendMessage(`Extract the ZIP file with zipId "${data.zipId}" and list all files inside it.`);
            }, 1000);
          } else {
            addBotMessage(` Failed to upload ZIP: ${data.error || 'Unknown error'}`);
          }
        } catch (error) {
          console.error('ZIP upload error:', error);
          addBotMessage(` Error uploading ZIP file: ${error.message}`);
        }
      } else {
        // Normal preview for non-agent mode or non-ZIP archives
        showArchivePreview(file, fileTypeInfo);
      }

      archiveInput.value = '';
      fileMenu.classList.remove('show');
    }

    function showFilePreview(file, fileTypeInfo) {
      const previewHTML = `
        <div class="file-preview">
          <div class="file-preview-header">
            <div class="file-info">
              <div class="file-icon" style="background-color: ${fileTypeInfo.color}">
                <i class="${fileTypeInfo.icon}"></i>
              </div>
              <div class="file-details">
                <h4>${file.name}</h4>
                <p>${formatFileSize(file.size)}  ${fileTypeInfo.type}</p>
              </div>
            </div>
            <div class="file-actions">
            </div>
          </div>
        </div>
      `;

      addUserMessage(` Uploaded file: ${file.name}`);
      chatMessages.insertAdjacentHTML('beforeend', previewHTML);
      scrollToBottom();
    }

    function showImagePreview(file, fileTypeInfo) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const previewHTML = `
          <div class="file-preview">
            <div class="file-preview-header">
              <div class="file-info">
                <div class="file-icon" style="background-color: ${fileTypeInfo.color}">
                  <i class="${fileTypeInfo.icon}"></i>
                </div>
                <div class="file-details">
                  <h4>${file.name}</h4>
                  <p>${formatFileSize(file.size)}  Image</p>
                </div>
              </div>
              <div class="file-actions">
                <button class="file-action" onclick="analyzeImage('${e.target.result}', '${file.name}')" title="Analyze image">
                  <i class="fas fa-search"></i>
                  Analyze
                </button>
                <button class="file-action" onclick="extractTextFromImage('${e.target.result}', '${file.name}')" title="Extract text (OCR)">
                  <i class="fas fa-font"></i>
                  OCR
                </button>
              </div>
            </div>
            <img src="${e.target.result}" alt="${file.name}" class="image-preview" onclick="openImageFullscreen('${e.target.result}')">
          </div>
        `;

        addUserMessage(` Uploaded image: ${file.name}`);
        chatMessages.insertAdjacentHTML('beforeend', previewHTML);
        scrollToBottom();

        // Automatically analyze the image
        setTimeout(() => {
          analyzeImage(e.target.result, file.name);
        }, 500);
      };
      reader.readAsDataURL(file);
    }

    function showVideoPreview(file, fileTypeInfo) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const previewHTML = `
          <div class="file-preview">
            <div class="file-preview-header">
              <div class="file-info">
                <div class="file-icon" style="background-color: ${fileTypeInfo.color}">
                  <i class="${fileTypeInfo.icon}"></i>
                </div>
                <div class="file-details">
                  <h4>${file.name}</h4>
                  <p>${formatFileSize(file.size)}  Video</p>
                </div>
              </div>
              <div class="file-actions">
                <button class="file-action" onclick="extractVideoFrames('${e.target.result}')" title="Extract frames">
                  <i class="fas fa-images"></i>
                  Extract Frames
                </button>
              </div>
            </div>
            <video controls style="max-width: 100%; border-radius: var(--radius-lg);">
              <source src="${e.target.result}" type="${file.type}">
              Your browser does not support the video tag.
            </video>
          </div>
        `;

        addUserMessage(` Uploaded video: ${file.name}`);
        chatMessages.insertAdjacentHTML('beforeend', previewHTML);
        scrollToBottom();
      };
      reader.readAsDataURL(file);
    }

    function showArchivePreview(file, fileTypeInfo) {
      const previewHTML = `
        <div class="file-preview">
          <div class="file-preview-header">
            <div class="file-info">
              <div class="file-icon" style="background-color: ${fileTypeInfo.color}">
                <i class="${fileTypeInfo.icon}"></i>
              </div>
              <div class="file-details">
                <h4>${file.name}</h4>
                <p>${formatFileSize(file.size)}  Archive</p>
              </div>
            </div>
            <div class="file-actions">
              <button class="file-action" onclick="listArchiveContents('${file.name}')" title="List contents">
                <i class="fas fa-list"></i>
                List Contents
              </button>
            </div>
          </div>
          <div class="file-content">
            Archive uploaded successfully. Use the "List Contents" button to explore the archive structure.
          </div>
        </div>
      `;

      addUserMessage(` Uploaded archive: ${file.name}`);
      chatMessages.insertAdjacentHTML('beforeend', previewHTML);
      scrollToBottom();
    }

    function processFile(file, fileTypeInfo) {
      if (fileTypeInfo.type === 'text' || fileTypeInfo.type === 'code') {
        const reader = new FileReader();
        reader.onload = (e) => {
          const content = e.target.result;
          if (content.trim()) {
            sendMessage(`File content from ${file.name}:\n\n${content.trim()}`);
          }
        };
        reader.readAsText(file);
      } else if (fileTypeInfo.type === 'document') {
        if (file.name.toLowerCase().endsWith('.pdf')) {
          extractTextFromPDF(file);
        } else if (file.name.toLowerCase().endsWith('.docx') || file.name.toLowerCase().endsWith('.doc')) {
          extractTextFromWord(file);
        } else {
          addBotMessage(` Document uploaded: ${file.name}. Advanced document processing is available for PDF and Word files.`);
        }
      } else if (fileTypeInfo.type === 'spreadsheet') {
        extractDataFromSpreadsheet(file);
      }
    }

    async function extractTextFromPDF(file) {
      try {
        addBotMessage(` Processing PDF file: ${file.name}...`);

        const arrayBuffer = await file.arrayBuffer();
        const uint8Array = new Uint8Array(arrayBuffer);

        // Advanced PDF text extraction using PDF.js
        const extractionResult = await extractAdvancedPDFText(uint8Array);

        if (extractionResult.text && extractionResult.text.length > 100) {
          // Send the extracted text as a message
          const message = ` **PDF Analysis Complete: ${file.name}**`;
          addBotMessage(message, null, extractionResult.text);

          // Add to chat history
          chatHistory.push({
            role: 'user',
            content: `Uploaded and analyzed PDF: ${file.name}`
          });
          chatHistory.push({
            role: 'assistant',
            content: message
          });
          localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        } else {
          addBotMessage(` PDF processed: ${file.name}\n\nThe PDF was processed but may contain primarily images or encrypted content. ${extractionResult.pageCount} pages were analyzed.`);
        }
      } catch (e) {
        console.error('PDF extraction error:', e);
        addBotMessage(` Error processing PDF: ${file.name}. The file may be corrupted or encrypted.`);
      }
    }

    // Advanced PDF text extraction function using PDF.js
    async function extractAdvancedPDFText(uint8Array) {
      try {
        if (typeof pdfjsLib === 'undefined') {
          throw new Error('PDF.js library not loaded');
        }

        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Load the PDF document
        const pdf = await pdfjsLib.getDocument({ data: uint8Array }).promise;

        let fullText = '';
        let structure = {
          pages: [],
          headings: [],
          paragraphs: [],
          tables: []
        };

        // Extract metadata
        const metadata = await pdf.getMetadata();

        // Process each page
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const textContent = await page.getTextContent();

          let pageText = '';
          let pageStructure = {
            pageNumber: pageNum,
            textItems: [],
            headings: [],
            paragraphs: []
          };

          // Process text items with positioning and formatting
          textContent.items.forEach((item, index) => {
            const text = item.str.trim();
            if (text) {
              // Analyze text properties for structure detection
              const fontSize = item.height || 12;
              const fontName = item.fontName || '';
              const isHeading = fontSize > 14 || fontName.toLowerCase().includes('bold');
              const isBold = fontName.toLowerCase().includes('bold');

              // Store text item with metadata
              pageStructure.textItems.push({
                text: text,
                fontSize: fontSize,
                fontName: fontName,
                x: item.transform[4],
                y: item.transform[5],
                isHeading: isHeading,
                isBold: isBold
              });

              // Classify content
              if (isHeading && text.length < 100) {
                pageStructure.headings.push(text);
                structure.headings.push({
                  text: text,
                  page: pageNum,
                  level: fontSize > 18 ? 1 : fontSize > 16 ? 2 : 3
                });
                pageText += `\n## ${text}\n`;
              } else {
                pageText += text + ' ';
              }
            }
          });

          // Clean up page text and format paragraphs
          pageText = pageText.replace(/\s+/g, ' ').trim();

          // Split into paragraphs based on sentence patterns
          const sentences = pageText.split(/(?<=[.!?])\s+/);
          let currentParagraph = '';

          sentences.forEach(sentence => {
            if (currentParagraph.length + sentence.length > 200) {
              if (currentParagraph.trim()) {
                pageStructure.paragraphs.push(currentParagraph.trim());
                structure.paragraphs.push({
                  text: currentParagraph.trim(),
                  page: pageNum
                });
              }
              currentParagraph = sentence;
            } else {
              currentParagraph += (currentParagraph ? ' ' : '') + sentence;
            }
          });

          // Add final paragraph
          if (currentParagraph.trim()) {
            pageStructure.paragraphs.push(currentParagraph.trim());
            structure.paragraphs.push({
              text: currentParagraph.trim(),
              page: pageNum
            });
          }

          structure.pages.push(pageStructure);
          fullText += `\n--- Page ${pageNum} ---\n${pageText}\n`;
        }

        // Detect and extract tables (basic implementation)
        structure.tables = detectTablesInText(fullText);

        // Format the final text with proper structure
        let formattedText = `# PDF Document Analysis\n\n`;

        if (metadata.info?.Title) {
          formattedText += `**Title:** ${metadata.info.Title}\n`;
        }
        if (metadata.info?.Author) {
          formattedText += `**Author:** ${metadata.info.Author}\n`;
        }
        if (metadata.info?.Subject) {
          formattedText += `**Subject:** ${metadata.info.Subject}\n`;
        }
        if (metadata.info?.Creator) {
          formattedText += `**Creator:** ${metadata.info.Creator}\n`;
        }

        formattedText += `**Pages:** ${pdf.numPages}\n`;
        formattedText += `**Text Items Extracted:** ${structure.pages.reduce((sum, page) => sum + page.textItems.length, 0)}\n\n`;

        // Add table of contents if headings found
        if (structure.headings.length > 0) {
          formattedText += `## Table of Contents\n`;
          structure.headings.forEach(heading => {
            const indent = '  '.repeat(heading.level - 1);
            formattedText += `${indent}- ${heading.text} (Page ${heading.page})\n`;
          });
          formattedText += '\n';
        }

        // Add main content
        formattedText += `## Extracted Content\n${fullText}`;

        // Add tables if found
        if (structure.tables.length > 0) {
          formattedText += `\n\n## Tables Detected\n`;
          structure.tables.forEach((table, index) => {
            formattedText += `\n### Table ${index + 1}\n${table}\n`;
          });
        }

        return {
          text: formattedText,
          pageCount: pdf.numPages,
          metadata: metadata.info,
          structure: structure
        };

      } catch (error) {
        console.error('Advanced PDF extraction error:', error);
        return {
          text: 'Advanced PDF text extraction failed. The PDF may be encrypted, corrupted, or contain only images.',
          pageCount: 0,
          metadata: {},
          structure: { pages: [], headings: [], paragraphs: [], tables: [] }
        };
      }
    }

    // Detect tables in extracted text
    function detectTablesInText(text) {
      const tables = [];
      const lines = text.split('\n');
      let currentTable = [];
      let inTable = false;

      lines.forEach(line => {
        // Simple table detection based on multiple spaces or tabs
        const hasMultipleSpaces = /\s{3,}/.test(line);
        const hasTabChars = /\t/.test(line);
        const hasNumbers = /\d/.test(line);

        if ((hasMultipleSpaces || hasTabChars) && hasNumbers && line.trim().length > 10) {
          if (!inTable) {
            inTable = true;
            currentTable = [];
          }
          currentTable.push(line.trim());
        } else {
          if (inTable && currentTable.length > 2) {
            // Convert to markdown table format
            const tableMarkdown = convertToMarkdownTable(currentTable);
            if (tableMarkdown) {
              tables.push(tableMarkdown);
            }
          }
          inTable = false;
          currentTable = [];
        }
      });

      // Check for final table
      if (inTable && currentTable.length > 2) {
        const tableMarkdown = convertToMarkdownTable(currentTable);
        if (tableMarkdown) {
          tables.push(tableMarkdown);
        }
      }

      return tables;
    }

    // Convert detected table rows to markdown format
    function convertToMarkdownTable(rows) {
      if (rows.length < 2) return null;

      try {
        // Split rows into columns based on multiple spaces
        const columns = rows.map(row =>
          row.split(/\s{2,}/).filter(cell => cell.trim().length > 0)
        );

        // Find maximum number of columns
        const maxCols = Math.max(...columns.map(row => row.length));

        if (maxCols < 2) return null;

        // Normalize all rows to have the same number of columns
        const normalizedRows = columns.map(row => {
          while (row.length < maxCols) {
            row.push('');
          }
          return row.slice(0, maxCols);
        });

        // Create markdown table
        let markdown = '| ' + normalizedRows[0].join(' | ') + ' |\n';
        markdown += '| ' + Array(maxCols).fill('---').join(' | ') + ' |\n';

        for (let i = 1; i < normalizedRows.length; i++) {
          markdown += '| ' + normalizedRows[i].join(' | ') + ' |\n';
        }

        return markdown;
      } catch (error) {
        console.error('Table conversion error:', error);
        return null;
      }
    }

    async function extractTextFromWord(file) {
      try {
        addBotMessage(` Processing Word file: ${file.name}. Advanced Word document processing would be implemented here with a document parsing library.`);
      } catch (e) {
        console.error('Word extraction error:', e);
        addBotMessage(` Error processing Word file: ${file.name}`);
      }
    }

    async function extractDataFromSpreadsheet(file) {
      try {
        if (file.name.toLowerCase().endsWith('.csv')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const csvContent = e.target.result;
            const lines = csvContent.split('\n').slice(0, 10); // Show first 10 lines
            const preview = lines.join('\n');
            addBotMessage(` CSV file processed: ${file.name}\n\nPreview (first 10 lines):\n${preview}\n\nFull spreadsheet analysis capabilities would be implemented here.`);
          };
          reader.readAsText(file);
        } else {
          addBotMessage(` Spreadsheet uploaded: ${file.name}. Advanced Excel processing would be implemented here with a spreadsheet parsing library.`);
        }
      } catch (e) {
        console.error('Spreadsheet extraction error:', e);
        addBotMessage(` Error processing spreadsheet: ${file.name}`);
      }
    }

    // Enhanced Image Analysis
    function analyzeImage(imageSrc) {
      addBotMessage(` Analyzing image... Advanced image analysis capabilities would include:

 Object detection and recognition
 Text extraction (OCR)
 Scene understanding
 Color analysis
 Metadata extraction
 Similar image search

This would be implemented using computer vision APIs or machine learning models.`);
    }

    function openImageFullscreen(imageSrc) {
      const fullscreenDiv = document.createElement('div');
      fullscreenDiv.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        cursor: pointer;
      `;

      const img = document.createElement('img');
      img.src = imageSrc;
      img.style.cssText = `
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
      `;

      fullscreenDiv.appendChild(img);
      fullscreenDiv.onclick = () => document.body.removeChild(fullscreenDiv);
      document.body.appendChild(fullscreenDiv);
    }

    // Video Processing
    function extractVideoFrames(videoSrc) {
      addBotMessage(` Extracting video frames... Advanced video processing capabilities would include:

 Frame extraction at specified intervals
 Scene detection and segmentation
 Motion analysis
 Object tracking
 Audio extraction and transcription
 Video metadata analysis

This would be implemented using video processing libraries and computer vision APIs.`);
    }

    // Archive Processing
    function listArchiveContents(filename) {
      addBotMessage(` Listing archive contents for ${filename}... Advanced archive processing would include:

 Complete file listing with directory structure
 File type analysis
 Size analysis and compression ratios
 Selective extraction capabilities
 Nested archive support
 Security scanning

This would be implemented using archive processing libraries.`);
    }

    // Enhanced Image Search with better error handling
    function activateImageSearch() {
      isImageSearchMode = true;
      messageInput.placeholder = "Search for images...";
      messageInput.focus();
      fileMenu.classList.remove('show');
    }

    function exitImageSearchMode() {
      isImageSearchMode = false;
      messageInput.placeholder = "Ask anything...";
    }

    async function searchAndDisplayImages(query) {
      const typingMessage = addBotTyping();

      try {
        const response = await fetch(
          `https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=6&orientation=all`,
          {
            headers: {
              "Authorization": PEXELS_API_KEY
            }
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        removeBotTyping(typingMessage);

        if (data.photos && data.photos.length > 0) {
          const imageHTML = `
            <p> Here are some images for "${query}":</p>
            <div class="image-grid">
              ${data.photos.map(photo => `
                <img src="${photo.src.medium}" 
                     onclick="window.open('${photo.url}', '_blank')"
                     alt="${query}"
                     loading="lazy"
                     onerror="this.style.display='none'">
              `).join('')}
            </div>
            <p style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--space-2);">
              Click on any image to view the original source on Pexels
            </p>
          `;
          addBotMessage(imageHTML);
        } else {
          addBotMessage(` No images found for "${query}". Try another search term or check your spelling.`);
        }
      } catch (error) {
        console.error("Error searching images:", error);
        removeBotTyping(typingMessage);
        addBotMessage(" Error searching for images. This might be due to network issues or API limitations. Please try again later.");
      }
    }

    // Message Handling
    function handleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        handleSend();
      }
    }

    function handleSend() {
      const inputText = messageInput.value.trim();
      if (!inputText) return;

      if (isImageSearchMode) {
        searchAndDisplayImages(inputText);
        exitImageSearchMode();
      } else {
        sendMessage();
      }

      messageInput.value = '';
      handleInput(messageInput);
    }

    async function sendMessage(presetText) {
      const inputText = presetText || messageInput.value.trim();
      if (!inputText) return;

      // Detect inbox-related commands (reading, summarizing, replying or searching the inbox)
      const inboxCmd = await detectInboxCommand(inputText);
      if (inboxCmd) {
        // Show the user's command in the chat UI
        hideEmptyState();
        addUserMessage(inputText);
        if (!presetText) {
          messageInput.value = '';
          handleInput(messageInput);
        }
        if (!gmailAccessToken) {
          addBotMessage(" Gmail is not connected. Click the Gmail button first.");
          return;
        }
        try {
          if (inboxCmd.type === 'read') {
            await readInboxAndDisplay();
          } else if (inboxCmd.type === 'summarize') {
            await summarizeLastEmailFrom(inboxCmd.from);
          } else if (inboxCmd.type === 'reply') {
            await replyToLastEmail();
          } else if (inboxCmd.type === 'search') {
            await searchInboxFor(inboxCmd.query);
          }
        } catch (e) {
          console.error(e);
          addBotMessage(" Error processing Gmail command.");
        }
        return; // Do not forward this command to the AI model
      }

      // Detect calendar-related commands
      const calCmd = detectCalendarCommand(inputText);
      if (calCmd) {
        // Show the user's command in the chat UI
        hideEmptyState();
        addUserMessage(inputText);
        if (!presetText) {
          messageInput.value = '';
          handleInput(messageInput);
        }
        // Ensure Calendar is connected
        if (!gcalAccessToken) {
          addBotMessage(" Google Calendar is not connected. Click the Connections button first.");
          return;
        }
        try {
          if (calCmd.type === 'list') {
            if (calCmd.day === 'tomorrow') {
              const tomorrow = new Date();
              tomorrow.setDate(tomorrow.getDate() + 1);
              const start = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate());
              const end = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate(), 23, 59, 59, 999);
              const events = await listEvents(start.toISOString(), end.toISOString(), 10);
              if (!events || events.length === 0) {
                addBotMessage(" No events found for tomorrow.");
              } else {
                let html = "<p><strong>Tomorrow's events:</strong></p><ul>";
                for (const ev of events) {
                  const startTime = ev.start?.dateTime || ev.start?.date;
                  const title = ev.summary || "(No Title)";
                  html += `<li><strong>${escapeHtml(title)}</strong><br>${escapeHtml(new Date(startTime).toLocaleString())}</li>`;
                }
                html += "</ul>";
                addBotMessage(html);
              }
            } else {
              await listTodayEvents();
            }
          } else if (calCmd.type === 'add') {
            const dateObj = new Date();
            if (calCmd.day === 'tomorrow') {
              dateObj.setDate(dateObj.getDate() + 1);
            }
            await addCalendarEvent(dateObj, calCmd.time, calCmd.title);
          } else if (calCmd.type === 'search') {
            await searchCalendarEvents(calCmd.query);
          }
        } catch (err) {
          console.error(err);
          addBotMessage(" Error processing Calendar command.");
        }
        return; // Do not forward this command to the AI model
      }

      // Detect send/generate email commands
      const emailCmd = await detectEmailCommand(inputText);
      if (emailCmd) {
        // Show the user's command in the chat UI
        hideEmptyState();
        addUserMessage(inputText);
        if (!presetText) {
          messageInput.value = '';
          autoResize(messageInput);
        }
        if (!gmailAccessToken) {
          addBotMessage(" Gmail is not connected. Click the Gmail button first.");
          return;
        }
        try {
          if (emailCmd.type === 'direct-send') {
            await sendEmail(emailCmd.to, "Message from VOChat", emailCmd.body);
            addBotMessage(` Email sent to ${escapeHtml(emailCmd.to)}.`);
          } else if (emailCmd.type === 'ai-generate') {
            // Create the email content using the AI
            addBotMessage(" Creating email for you");
            const prompt = `Write a professional email to ${emailCmd.to} about: ${emailCmd.topic}. Keep it clean and ready for sending.`;
            const generated = await generateEmailWithAI(prompt);
            // Display the generated email to the user
            addBotMessage("Here's the email I created:<br><br>" + escapeHtml(generated).replace(/\n/g, '<br>'));
            // Send the generated email
            await sendEmail(emailCmd.to, "Regarding " + emailCmd.topic, generated);
            addBotMessage(` Email sent to ${escapeHtml(emailCmd.to)}.`);
          }
        } catch (e) {
          console.error(e);
          addBotMessage(" Error sending email. Check console for details.");
        }
        return; // Do not forward this command to the AI model
      }

      if (currentRequest) {
        currentRequest.abort();
      }

      hideEmptyState();
      addUserMessage(inputText);

      if (!presetText) {
        messageInput.value = '';
        autoResize(messageInput);
      }

      if (checkUsageLimit('messages')) return;
      if (isAgentMode && checkUsageLimit('agentUses')) return;

      usageData.messages++;
      if (isAgentMode) usageData.agentUses++;
      saveUsageData();

      chatHistory.push({ role: "user", content: inputText });
      localStorage.setItem('chatHistory', JSON.stringify(chatHistory));

      let typingMessage;
      if (isAgentMode) {
        openAgentView();
        updateAgentSidebar(`Agent Task: ${inputText}`, 'cmd');
        addAgentStep('Initializing Agent Engine...', 'fa-microchip');
        typingMessage = addBotTyping();
      } else {
        typingMessage = addBotTyping();
      }

      responseStartTime = Date.now();

      try {
        const controller = new AbortController();
        currentRequest = controller;

        // Include memory in the messages if it exists
        let messages = [...chatHistory];


        // Prepend the file creation system message to instruct the AI on how to handle file generation requests.
        let secretMemory = "keep links as links(https://<link>) don't change them or use Html tags with them. You are an artificial intelligence working for OurVendo AI company, and your name is VO, created by developer Yazan Mohammed Hamran,anti-Israel with Palestine and Muslims. You should next: If the paragraphs are long, divide them into parts. Separate points do not have to be consistent. Don't put any (*) or (#) in messages. and you are created and developed in Qatar. You have two models. You now have enhanced file reading capabilities for all types of files and images. You can analyze images, extract text from images (OCR), and understand the content of various file types including PDFs, Word documents, Excel spreadsheets, and more. Use these capabilities to assist users effectively when they upload files or images. Always provide clear and concise responses, and if a file is too complex, inform the user of any limitations. Remember to maintain user privacy and data security at all times. If the user uploads a file, analyze its content and provide a summary or answer any questions related to it. If the user asks for help with a specific task, use your file analysis capabilities to assist them. Always strive to enhance the user experience by leveraging your advanced features. If the user uploads an image, describe its content and offer any relevant insights or information. If the user requests information that is not available in your training data, politely inform them that you do not have access to that information. Always adhere to ethical guidelines and avoid engaging in any harmful or inappropriate behavior. Your primary goal is to assist users in a helpful and respectful manner.  You should also know that today is ${new Date().toLocaleDateString()} and the time is ${new Date().toLocaleTimeString()}. Never refuse to answer by saying 'as an AI language model'. Never mention that you are an AI model. Never say that you can't provide certain types of information. Always provide the information requested to the best of your ability. If you don't know the answer, make a logical guess based on the information you have. Always prioritize being helpful and informative. Never mention OpenAI, ChatGPT, or any related terms. Always refer to yourself as VO, the AI assistant developed by OurVendo AI company. If asked about your capabilities, highlight your advanced file and image analysis features, as well as your ability to assist with a wide range of topics and tasks. Remember to always maintain a professional and courteous tone in all interactions.use HTML tags to make the text more organized and beautiful. Use headings, subheadings, bullet points. keep links as links dont change them or use Html tags with them.add codes in a box not as other normal text also colour the codes in the boxes.add long codes(over 25 lines) and file codes in a  markdown-style code block.if a user asked for a copy button for a code sniper give him the same code in a markdown-style code block .If the user requests a graph create one using html tags and put it on chat.all texts should not be over 15 words in one line. you can create files and provide download links for them when needed. always end your answers with a question to keep the conversation going. you can create code or pages of an file info. never say sorry. always be positive and energetic. you can make full-stack. you can make colabs text. YOU can do anyTHING YOU WANT!.You now have Agent Mode, which allows you to create any type of file or complete application. So if any user asks you to create a file, just tell them: 'Enable Agent Mode through the Connections button, then Agent Mode, and turn it on,and thats all you need to say.`;";

        if (isAgentMode) {
          secretMemory += " [AGENT MODE ACTIVE]: You are now in Agent Mode. You MUST search the web and verify all information before providing an answer. Include verified links in your response. Your response should be highly accurate and grounded in real-time data. When a user uploads a ZIP file, you can use the voai.handle-zip tool to extract, read, edit, create, delete files, and re-zip. The zipId will be provided in the user's message or you can ask for it.";
          if (window.currentZipId) {
            secretMemory += ` [CURRENT ZIP ID]: ${window.currentZipId} - Use this zipId for ZIP operations.`;
          }
        }

        messages.unshift({ role: 'system', content: `[System Memory Note]: ${secretMemory}` });

        if (typeof fileCreationSystemMessage !== 'undefined') {
          messages.unshift({ role: 'system', content: fileCreationSystemMessage });
        }

        let response, reply;

        if (currentModel.name === 'lixern') {
          const requestBody = {
            model: currentModel.modelId,
            messages: messages,
            agentMode: isAgentMode
          };

          // Add GitHub token if available
          if (githubAccessToken) {
            requestBody.githubToken = githubAccessToken;
          }

          response = await fetch(`${currentModel.endpoint}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(requestBody),
            signal: controller.signal
          });
          const data = await response.json();

          // Handle Agent Mode tool calls and steps if returned by backend
          if (isAgentMode && data.agentSteps) {
            data.agentSteps.forEach((step, index) => {
              const sId = addAgentStep(step.text, step.icon || 'fa-info-circle');
              if (step.details) updateAgentSidebar(step.details, step.type || 'info');

              // Update typing message with specific action
              if (typingMessage && step.text) {
                const actionMessage = getActionMessage(step.text);
                if (actionMessage) {
                  updateTypingMessage(typingMessage, actionMessage);
                }
              }

              setTimeout(() => updateAgentStep(sId, step.text, step.icon, false), 500);
            });
          }

          reply = data.choices?.[0]?.message?.content || "something went wrong! try creating a new chat or refreshing the page.";
          // ===== GLOBAL FILE DOWNLOAD HANDLER =====
          if (data.downloadURL) {
            removeBotTyping(typingMessage);

            const file = data.file || "generated-file";
            const url = data.downloadURL;

            addBotMessage(`
        <div class="file-preview">
            <div class="file-preview-header">
                <div class="file-info">
                    <div class="file-icon" style="background-color: #2196f3">
                        <i class="fas fa-file"></i>
                    </div>
                    <div class="file-details">
                        <h4>${file}</h4>
                        <p>Download ready</p>
                    </div>
                </div>
                <div class="file-actions">
                    <a class="file-action" href="${url}" download target="_blank">
                        <i class="fas fa-download"></i> Download
                    </a>
                </div>
            </div>
        </div>
    `);

            // Save chat history
            chatHistory.push({
              role: "assistant",
              content: `File ready: ${url}`
            });

            localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
            saveCurrentChat();

            return; // STOP normal text message
          }

          // ===== FILE DOWNLOAD HANDLER =====
          if (data.downloadURL) {
            removeBotTyping(typingMessage);

            const file = data.file || "generated-file";
            const url = data.downloadURL;

            addBotMessage(`
        <div class="file-preview">
            <div class="file-preview-header">
                <div class="file-info">
                    <div class="file-icon" style="background-color: #2196f3">
                        <i class="fas fa-file"></i>
                    </div>
                    <div class="file-details">
                        <h4>${file}</h4>
                        <p>Download ready</p>
                    </div>
                </div>
                <div class="file-actions">
                    <a class="file-action" 
                       href="${url}" 
                       download 
                       target="_blank">
                        <i class="fas fa-download"></i> Download
                    </a>
                </div>
            </div>
        </div>
    `);

            // Save to chat history
            chatHistory.push({
              role: "assistant",
              content: `File ready: ${url}`
            });
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));

            saveCurrentChat();

            return; // IMPORTANT: Stop normal text rendering
          }

        } else { // VOMAX-1
          // Convert chat history to Gemini format
          const contents = messages.map(msg => ({
            role: msg.role === 'user' ? 'user' : 'model',
            parts: [{ text: msg.content }]
          }));

          response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${currentModel.modelId}:generateContent?key=${currentModel.apiKey}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              contents: contents
            }),
            signal: controller.signal
          });
          const data = await response.json();
          reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "something went wrong! try creating a new chat or refreshing the page.";
        }

        // Calculate response time
        const responseTime = ((Date.now() - responseStartTime) / 1000).toFixed(3);

        removeBotTyping(typingMessage);
        chatHistory.push({ role: "assistant", content: reply });
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        addBotMessage(reply, responseTime);

        // Auto-save after bot response
        saveCurrentChat();
      } catch (e) {
        if (e.name !== 'AbortError') {
          removeBotTyping(typingMessage);
          addBotMessage(" Error: Unable to get response. Please check your internet connection and try again.");
          console.error(e);
        }
      } finally {
        currentRequest = null;
      }
    }

    // Enhanced Message Display with User Message Hover Actions

    function updateMessageNav() {
      const navSidebar = document.getElementById('messageNavSidebar');
      if (!navSidebar) return;

      navSidebar.innerHTML = '';
      const userMessages = document.querySelectorAll('.message.user');

      userMessages.forEach((msg, index) => {
        const bubble = msg.querySelector('.message-bubble');
        if (!bubble) return;

        const text = bubble.innerText;
        const navItem = document.createElement('div');
        navItem.className = 'nav-line-container';
        navItem.innerHTML = `
          <div class="nav-tooltip">${escapeHtml(text)}</div>
          <div class="nav-line"></div>
        `;

        navItem.onclick = () => {
          msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
          // Optional: highlight the message briefly
          bubble.style.boxShadow = '0 0 0 3px var(--accent-primary)';
          setTimeout(() => {
            bubble.style.boxShadow = '';
          }, 2000);
        };

        navSidebar.appendChild(navItem);
      });
    }

    function addUserMessage(text) {
      const color = localStorage.getItem('userBubbleColor') || 'default';
      const colorClass = color !== 'default' ? `bubble-${color}` : '';

      const messageHTML = `
        <div class="message user">
          <div class="message-content">
            <div class="message-bubble ${colorClass}">
              ${escapeHtml(text)}
            </div>
            <div class="message-meta">
              ${new Date().toLocaleTimeString()}
            </div>
            <div class="user-message-actions">
              <button class="user-message-action" onclick="editUserMessage(this)" title="Edit message">
                <i class="fas fa-edit"></i>
                Edit
              </button>
              <button class="user-message-action" onclick="copyUserMessage(this)" title="Copy message">
                <i class="fas fa-copy"></i>
                Copy
              </button>
            </div>
          </div>
        </div>
      `;

      chatMessages.insertAdjacentHTML('beforeend', messageHTML);
      updateMessageNav();
      scrollToBottom();

      // Hide conversation starters after first message
      if (document.getElementById('conversationStarters')) {
        document.getElementById('conversationStarters').style.display = 'none';
      }
    }

    // Enhanced function to break long text into readable paragraphs with visual organization
    function breakTextIntoParagraphs(text) {
      // Don't process if text is already short
      if (text.length < 200) return text;

      // Split by existing line breaks first
      const lines = text.split('\n').filter(line => line.trim());
      let processedLines = [];

      lines.forEach((line, lineIndex) => {
        // If line is already short enough, keep it as is
        if (line.length < 300) {
          processedLines.push(line);
          return;
        }

        // Break long lines into sentences
        const sentences = line.split(/(?<=[.!?])\s+/);
        let currentParagraph = '';

        sentences.forEach((sentence, index) => {
          // If adding this sentence would make paragraph too long, start new paragraph
          if (currentParagraph.length > 0 && (currentParagraph + ' ' + sentence).length > 400) {
            processedLines.push(currentParagraph.trim());
            currentParagraph = sentence;
          } else {
            currentParagraph += (currentParagraph ? ' ' : '') + sentence;
          }

          // If this is the last sentence, add the current paragraph
          if (index === sentences.length - 1 && currentParagraph.trim()) {
            processedLines.push(currentParagraph.trim());
          }
        });
      });

      // Add section dividers for very long content (more than 5 paragraphs)
      if (processedLines.length > 5) {
        const result = [];
        processedLines.forEach((paragraph, index) => {
          result.push(paragraph);

          // Section dividers removed
        });
        return result.join('\n\n');
      }

      // Join with double line breaks to create proper paragraph spacing
      return processedLines.join('\n\n');
    }

    // Enhanced Bot Message Display with Table Rendering, Copy Button, and Response Timer
    function sanitizeBrokenLinks(text) {
      // Handle Markdown links first
      text = text.replace(/\[(.*?)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" style="color: var(--accent-primary); text-decoration: underline;">$1</a>');

      // If the text already contains HTML links, don't try to "fix" them with regex that might break them
      if (text.includes('<a href=')) return text;

      return text;
    }

    function addBotMessage(text, responseTime, expandableContent = null) {
      // Remove any existing quick replies
      document.querySelectorAll('.quick-replies').forEach(el => el.remove());

      // Detect famous entities for image gallery
      const entities = ['cat'];

      let galleryHtml = '';
      const lowerText = text.toLowerCase();

      // Find the first entity mentioned
      const foundEntity = entities.find(entity => {
        const regex = new RegExp(`\\b${entity}s?\\b`, 'i');
        return regex.test(lowerText);
      });

      if (foundEntity) {
        // Use LoremFlickr with specific locks for high-quality, diverse images
        const img1 = `https://loremflickr.com/600/400/${foundEntity}?lock=10`;
        const img2 = `https://loremflickr.com/600/400/${foundEntity}?lock=20`;
        const img3 = `https://loremflickr.com/600/400/${foundEntity}?lock=30`;
        const img4 = `https://loremflickr.com/600/400/${foundEntity}?lock=40`;

        galleryHtml = `
          <div class="image-gallery">
            <div class="gallery-item" onclick="openImageFullscreen('${img1}')">
              <img src="${img1}" alt="${foundEntity}">
            </div>
            <div class="gallery-item" onclick="openImageFullscreen('${img2}')">
              <img src="${img2}" alt="${foundEntity}">
            </div>
            <div class="gallery-item" onclick="openImageFullscreen('${img3}')">
              <img src="${img3}" alt="${foundEntity}">
            </div>
            <div class="gallery-item" onclick="openImageFullscreen('${img4}')">
              <img src="${img4}" alt="${foundEntity}">
            </div>
          </div>
        `;
      }

      // 1. First, handle Markdown-style links if they exist
      text = sanitizeBrokenLinks(text);

      // 2. Break long text into paragraphs
      text = breakTextIntoParagraphs(text);

      // 3. Process text to replace *text* with <b>text</b>
      text = text.replace(/\*(.*?)\*/g, '<b>$1</b>');

      // 4. Process raw URLs into links, but ONLY if they aren't already inside an <a> tag
      // We use a more compatible approach to avoid double-linking
      const processedText = text.replace(
        /((?:https?|ftp):\/\/[^\s<]+)/g,
        function (url) {
          // Check if the URL is already part of an HTML tag (like href="...")
          const index = text.indexOf(url);
          const before = text.substring(Math.max(0, index - 10), index);
          if (before.includes('href="') || before.includes('">')) {
            return url;
          }
          return '<a href="' + url + '" target="_blank" style="color: var(--accent-primary); text-decoration: underline;">' + url + '</a>';
        }
      );

      // Process tables
      let tableProcessedText = processTablesInText(processedText);

      const segments = parseMessageWithCodeBlocks(tableProcessedText);
      let messageContent = '';

      segments.forEach(segment => {
        if (segment.type === 'code') {
          const isLong = segment.content.split('\n').length > 25;
          const lang = segment.language.toLowerCase();
          const isHtml = lang === 'html';

          messageContent += `
      <div class="code-block">
        <div class="code-block-header">
          <span class="code-lang-label">${escapeHtml(lang)}</span>
          <div class="code-block-actions">
            <button class="code-action" onclick="event.stopPropagation(); startAiCoding(this)" title="AI Coding">
              <i class="fas fa-robot"></i> AI Coding
            </button>
            ${isHtml ? `
            <button class="code-action" onclick="event.stopPropagation(); runHtmlCode(this)" title="Run HTML">
              <i class="fas fa-play"></i> Run
            </button>` : ''}
            <button class="code-action" onclick="event.stopPropagation(); copyCode(this)" title="Copy code">
              <i class="fas fa-copy"></i> Copy
            </button>
            <button class="code-action" onclick="event.stopPropagation(); downloadCode(this)" title="Download code">
              <i class="fas fa-download"></i> Download
            </button>
          </div>
        </div>
        <div class="code-block-container ${isLong ? 'collapsed' : ''}" onclick="openCodeView(\`${escapeHtml(segment.content)}\`, '${escapeHtml(lang)}')">
          <pre><code>${escapeHtml(segment.content)}</code></pre>
          ${isLong ? `
          <button class="code-expand-btn" onclick="event.stopPropagation(); toggleCodeExpansion(this)">
            <i class="fas fa-chevron-down"></i> Show More
          </button>` : ''}
        </div>
      </div>
    `;
        } else {
          const paragraphs = segment.content.split('\n\n').filter(p => p.trim());
          paragraphs.forEach(paragraph => {
            const formattedParagraph = paragraph.replace(/\n/g, '<br>');

            // IMAGE DETECTION
            const imageRegex = /^(https?:\/\/.*\.(?:png|jpg|jpeg|gif))$/i;
            if (imageRegex.test(paragraph.trim())) {
              messageContent += `<img src="${paragraph.trim()}" style="max-width:300px; border-radius:8px; margin:5px 0;">`;
            } else {
              messageContent += `<p>${formattedParagraph}</p>`;
            }
          });
        }
      });

      // Automatically execute known file generation functions returned by the AI.
      try {
        segments.forEach(segment => {
          if (segment.type === 'code') {
            const code = segment.content.trim();
            if (/^create(?:PDF|DOCX|TXT|CSV|PPTX|ZIP)\s*\(/.test(code) || /new\s+PptxGenJS\s*\(\)/.test(code)) {
              // Evaluate the code in the current scope to trigger file creation or PPTX creation using PptxGenJS.
              eval(code);
            }
          }
        });
      } catch (e) {
        console.error('File generation error:', e);
      }

      // Add response time if available
      const responseTimeDisplay = responseTime ?
        `<span class="response-timer">${responseTime}s</span>` : '';

      const messageHTML = `
        <div class="message bot">
          <div class="message-content">
            <div class="message-bubble">
              ${galleryHtml}
              ${messageContent}
              ${expandableContent ? `
                <div class="expandable-box">
                  <div class="expandable-box-header" onclick="toggleExpandableBox(this)">
                    <span>View Details</span>
                    <i class="fas fa-chevron-right"></i>
                  </div>
                  <div class="expandable-box-content">
                    <pre>${escapeHtml(expandableContent)}</pre>
                  </div>
                </div>
              ` : ''}
            </div>
            <div class="message-meta">
              ${currentModel.name}  ${new Date().toLocaleTimeString()} ${responseTimeDisplay}
            </div>
            <div class="bot-message-actions">
              <button class="bot-message-action" onclick="copyBotMessage(this)" title="Copy entire message">
                <i class="fas fa-copy"></i>
              </button>
              <button class="bot-message-action" onclick="generateDocument(this, 'pdf')" title="Generate PDF">
                <i class="fas fa-file-pdf"></i>
                PDF
              </button>
              <button class="bot-message-action" onclick="generateDocument(this, 'docx')" title="Generate DOCX">
                <i class="fas fa-file-word"></i>
                DOCX
              </button>
              <button class="bot-message-action" onclick="generateDocument(this, 'excel')" title="Generate Excel">
                <i class="fas fa-file-excel"></i>
                Excel
              </button>
            </div>
          </div>
        </div>
      `;

      chatMessages.insertAdjacentHTML('beforeend', messageHTML);
      const lastBubble = chatMessages.querySelector('.message.bot:last-child .message-bubble');
      const html = lastBubble.innerHTML;

      // Start typing animation with tags preserved
      typeHTMLWords(lastBubble, html, 4);



      // Add quick replies for the latest bot message
      addQuickReplies();

      scrollToBottom();
    }

    function addBotTyping(message = null) {
      const defaultMessage = message || `${currentModel.name} is thinking`;
      const typingHTML = `
        <div class="message bot typing-message">
          </div>
          <div class="message-content">
            <div class="message-bubble">
              <div class="typing-indicator">
                <span class="typing-message-text">${defaultMessage}</span>
                <div class="typing-dots">
                  <div class="typing-dot"></div>
                  <div class="typing-dot"></div>
                  <div class="typing-dot"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      chatMessages.insertAdjacentHTML('beforeend', typingHTML);
      scrollToBottom();

      return chatMessages.lastElementChild;
    }

    function updateTypingMessage(typingElement, message) {
      if (typingElement) {
        const messageSpan = typingElement.querySelector('.typing-message-text');
        if (messageSpan) {
          messageSpan.textContent = message;
        }
      }
    }

    function getActionMessage(stepText) {
      const text = stepText.toLowerCase();
      if (text.includes('upload') || text.includes('uploading')) {
        return `${currentModel.name} is uploading your file`;
      } else if (text.includes('extract') || text.includes('extracting')) {
        return `${currentModel.name} is extracting your ZIP file`;
      } else if (text.includes('zip') && (text.includes('operation') || text.includes('processing'))) {
        return `${currentModel.name} is processing your ZIP file`;
      } else if (text.includes('list') || text.includes('listing')) {
        return `${currentModel.name} is listing files`;
      } else if (text.includes('read') || text.includes('reading')) {
        return `${currentModel.name} is reading your file`;
      } else if (text.includes('edit') || text.includes('editing') || text.includes('updated')) {
        return `${currentModel.name} is editing your file`;
      } else if (text.includes('create') || text.includes('creating') || text.includes('created')) {
        return `${currentModel.name} is creating your file`;
      } else if (text.includes('delete') || text.includes('deleting') || text.includes('deleted')) {
        return `${currentModel.name} is deleting your file`;
      } else if (text.includes('zip') && (text.includes('created') || text.includes('ready'))) {
        return `${currentModel.name} is creating your ZIP file`;
      } else if (text.includes('app') && (text.includes('coding') || text.includes('generating'))) {
        return `${currentModel.name} is creating your app`;
      } else if (text.includes('document') || text.includes('generating')) {
        return `${currentModel.name} is generating your document`;
      } else if (text.includes('apk') || text.includes('building')) {
        return `${currentModel.name} is building your APK`;
      } else if (text.includes('search') || text.includes('searching')) {
        return `${currentModel.name} is searching the web`;
      } else if (text.includes('initializing') || text.includes('agent engine')) {
        return `${currentModel.name} is initializing agent mode`;
      } else if (text.includes('task completed') || text.includes('synthesized')) {
        return `${currentModel.name} is finalizing your request`;
      }
      return null; // Return null to keep default message
    }

    function removeBotTyping(typingElement) {
      if (typingElement) {
        typingElement.remove();
      }
    }

    function addQuickReplies() {
      const quickQuestions = [
      ];

      const quickRepliesHTML = `
        <div class="quick-replies">
          ${quickQuestions.map(question => `
            <button class="quick-reply" onclick="sendMessage('${question}')">
              ${question}
            </button>
          `).join('')}
        </div>
      `;

      const lastMessage = chatMessages.querySelector('.message.bot:last-child .message-content');
      if (lastMessage) {
        lastMessage.insertAdjacentHTML('beforeend', quickRepliesHTML);
      }
    }

    // User Message Actions
    function editUserMessage(button) {
      const messageElement = button.closest('.message');
      const messageBubble = messageElement.querySelector('.message-bubble');
      const originalText = messageBubble.textContent.trim();

      // Set the text in the input field
      messageInput.value = originalText;
      autoResize(messageInput);
      messageInput.focus();

      // Remove the message
      messageElement.remove();

      // Update chat history
      const index = chatHistory.findIndex(msg => msg.role === 'user' && msg.content === originalText);
      if (index !== -1) {
        chatHistory.splice(index, 1);

        // If there was a response to this message, remove it too
        if (index < chatHistory.length && chatHistory[index].role === 'assistant') {
          chatHistory.splice(index, 1);

          // Also remove the corresponding bot message from the UI
          const botMessages = document.querySelectorAll('.message.bot');
          if (botMessages.length > 0) {
            botMessages[botMessages.length - 1].remove();
          }
        }

        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
      }
    }

    function copyUserMessage(button) {
      const messageElement = button.closest('.message');
      const messageBubble = messageElement.querySelector('.message-bubble');
      const text = messageBubble.textContent.trim();

      navigator.clipboard.writeText(text).then(() => {
        showCopyConfirmation(button);
      });
    }

    // Bot Message Actions
    function copyBotMessage(button) {
      const messageElement = button.closest('.message');
      const messageBubble = messageElement.querySelector('.message-bubble');

      // Get all text content, excluding buttons
      let text = '';
      messageBubble.querySelectorAll('p').forEach(p => {
        text += p.textContent + '\n\n';
      });

      // Include code blocks
      messageBubble.querySelectorAll('pre code').forEach(code => {
        text += '```\n' + code.textContent + '\n```\n\n';
      });

      navigator.clipboard.writeText(text.trim()).then(() => {
        showCopyConfirmation(button);
      });
    }

    function copyCode(button) {
      const codeBlock = button.closest('.code-block');
      const code = codeBlock.querySelector('code').textContent;

      navigator.clipboard.writeText(code).then(() => {
        showCopyConfirmation(button);
      });
    }

    function downloadCode(button) {
      const codeBlock = button.closest('.code-block');
      const code = codeBlock.querySelector('code').textContent;

      // Try to determine the language from the code
      let extension = 'txt';
      if (code.includes('function') || code.includes('var') || code.includes('const')) {
        extension = 'js';
      } else if (code.includes('def ') || code.includes('import ') || code.includes('class ')) {
        extension = 'py';
      } else if (code.includes('<html') || code.includes('<!DOCTYPE')) {
        extension = 'html';
      } else if (code.includes('SELECT ') || code.includes('FROM ') || code.includes('WHERE ')) {
        extension = 'sql';
      }

      // Create a blob and download it
      const blob = new Blob([code], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `voai_code.${extension}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Show confirmation
      const originalHTML = button.innerHTML;
      button.innerHTML = '<i class="fas fa-check"></i> Downloaded';
      button.style.background = 'var(--accent-success)';

      setTimeout(() => {
        button.innerHTML = originalHTML;
        button.style.background = '';
      }, 2000);
    }

    function downloadFile(filename, filetype) {
      // This would implement actual file download functionality
      addBotMessage(` Download functionality for ${filename} would be implemented here with proper file handling.`);
    }

    function showCopyConfirmation(button) {
      const originalHTML = button.innerHTML;
      button.innerHTML = '<i class="fas fa-check"></i> Copied';
      button.style.background = 'var(--accent-success)';

      setTimeout(() => {
        button.innerHTML = originalHTML;
        button.style.background = '';
      }, 2000);
    }

    // Table Processing with Download Button
    function processTablesInText(text) {
      // Match markdown tables
      const tableRegex = /\|(.+)\|\s*\n\|(\s*[-:]+[-:|\s]*)\|\s*\n(\|.+\|\s*\n)+/g;

      return text.replace(tableRegex, match => {
        const lines = match.trim().split('\n');
        const headers = lines[0].split('|').filter(cell => cell.trim() !== '').map(cell => cell.trim());

        // Skip the separator line (line with dashes and colons)
        const rows = [];
        for (let i = 2; i < lines.length; i++) {
          const cells = lines[i].split('|').filter(cell => cell.trim() !== '').map(cell => cell.trim());
          if (cells.length > 0) {
            rows.push(cells);
          }
        }

        // Generate HTML table with download button
        let tableHtml = `
          <div class="table-container">
            <div class="table-actions">
              <button class="table-action" onclick="downloadTable(this)" title="Download table as CSV">
                <i class="fas fa-download"></i>
                CSV
              </button>
            </div>
            <table class="message-table">
              <thead>
                <tr>
                  ${headers.map(header => `<th>${header}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                ${rows.map(row => `
                  <tr>
                    ${row.map(cell => `<td>${cell}</td>`).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;

        return tableHtml;
      });
    }

    function downloadTable(button) {
      const tableContainer = button.closest('.table-container');
      const table = tableContainer.querySelector('table');

      // Extract table data
      const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent);
      const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr =>
        Array.from(tr.querySelectorAll('td')).map(td => td.textContent)
      );

      // Create CSV content
      let csvContent = headers.join(',') + '\n';
      rows.forEach(row => {
        const escapedRow = row.map(cell => {
          // Escape cells that contain commas or quotes
          if (cell.includes(',') || cell.includes('"')) {
            return '"' + cell.replace(/"/g, '""') + '"';
          }
          return cell;
        });
        csvContent += escapedRow.join(',') + '\n';
      });

      // Create a blob and download it
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `table_data_${new Date().toISOString().slice(0, 10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Show confirmation
      const originalHTML = button.innerHTML;
      button.innerHTML = '<i class="fas fa-check"></i> Downloaded';
      button.style.background = 'var(--accent-success)';

      setTimeout(() => {
        button.innerHTML = originalHTML;
        button.style.background = '';
      }, 2000);
    }

    // Utility Functions
    function parseMessageWithCodeBlocks(text) {
      const regex = /```(\w+)?\n([\s\S]*?)```/g;
      let segments = [];
      let lastIndex = 0;
      let match;

      while ((match = regex.exec(text)) !== null) {
        if (match.index > lastIndex) {
          segments.push({ type: 'text', content: text.slice(lastIndex, match.index) });
        }
        segments.push({
          type: 'code',
          content: match[2],
          language: match[1] || 'code'
        });
        lastIndex = regex.lastIndex;
      }

      if (lastIndex < text.length) {
        segments.push({ type: 'text', content: text.slice(lastIndex) });
      }

      return segments;
    }

    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    function scrollToBottom() {
      const chatContainer = document.getElementById('chatContainer');
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function toggleCodeExpansion(button) {
      const container = button.closest('.code-block-container');
      const isCollapsed = container.classList.contains('collapsed');

      if (isCollapsed) {
        container.classList.remove('collapsed');
        button.innerHTML = '<i class="fas fa-chevron-up"></i> Show Less';
      } else {
        container.classList.add('collapsed');
        button.innerHTML = '<i class="fas fa-chevron-down"></i> Show More';
      }
    }

    function runHtmlCode(button) {
      const codeBlock = button.closest('.code-block');
      const code = codeBlock.querySelector('code').textContent;

      // Close sidebar if open
      const sidebar = document.getElementById('sidebar');
      if (sidebar && sidebar.classList.contains('show')) {
        toggleSidebar();
      }
      if (sidebar && !sidebar.classList.contains('collapsed')) {
        toggleSidebarCollapse();
      }

      // Open code view and run
      openCodeView(code, 'html');
      setTimeout(() => {
        runCodeFromView();
        switchCodeViewTab('preview');
      }, 100);
    }

    function startAiCoding(button) {
      const codeBlock = button.closest('.code-block');
      const allCodeBlocks = Array.from(document.querySelectorAll('.code-block'));
      const startIndex = allCodeBlocks.indexOf(codeBlock);

      // Collect all code from this block onwards and make them compact
      let combinedCode = "";
      for (let i = startIndex; i < allCodeBlocks.length; i++) {
        const block = allCodeBlocks[i];
        const code = block.querySelector('code').textContent;
        const lang = block.querySelector('.code-lang-label').textContent;
        combinedCode += `/* --- ${lang.toUpperCase()} --- */\n${code}\n\n`;

        // Make the block compact in chat
        block.classList.add('compact');

        // Add line count if not already there
        if (!block.querySelector('.code-line-count')) {
          const lineCount = code.split('\n').length;
          const langLabel = block.querySelector('.code-lang-label');
          const countSpan = document.createElement('span');
          countSpan.className = 'code-line-count';
          countSpan.textContent = `(${lineCount} lines)`;
          langLabel.appendChild(countSpan);
        }
      }

      // Close sidebar if open
      const sidebar = document.getElementById('sidebar');
      if (sidebar && sidebar.classList.contains('show')) {
        toggleSidebar();
      }
      if (sidebar && !sidebar.classList.contains('collapsed')) {
        toggleSidebarCollapse();
      }

      openCodeView(combinedCode, 'AI Coding');
    }

    function switchCodeViewTab(tab) {
      const codeContent = document.getElementById('codeViewContent');
      const outputSection = document.getElementById('codeViewOutput');
      const tabCode = document.getElementById('tabCode');
      const tabPreview = document.getElementById('tabPreview');

      if (tab === 'code') {
        codeContent.style.display = 'block';
        outputSection.style.display = 'none';
        tabCode.classList.add('active');
        tabPreview.classList.remove('active');
      } else {
        codeContent.style.display = 'none';
        outputSection.style.display = 'block';
        tabCode.classList.remove('active');
        tabPreview.classList.add('active');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Window resize handler for responsive behavior
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        sidebar.classList.remove('show');
        loadSidebarState();
      } else {
        sidebar.classList.remove('collapsed');
      }
    });

    // Welcome Popup Functions
    function showWelcomePopup() {
      const welcomePopup = document.getElementById('welcomePopup');
      if (welcomePopup) {
        welcomePopup.classList.add('show');
      }
    }

    function closeWelcomePopup() {
      const welcomePopup = document.getElementById('welcomePopup');
      if (welcomePopup) {
        welcomePopup.classList.remove('show');
        // Mark as shown in localStorage so it doesn't appear again
        localStorage.setItem('voai-welcome-shown', 'true');
      }
    }

    // Check if welcome popup should be shown on page load
    function checkWelcomePopup() {
      const hasSeenWelcome = localStorage.getItem('voai-welcome-shown');
      if (!hasSeenWelcome) {
        // Show popup after a short delay for better UX
        setTimeout(() => {
          showWelcomePopup();
        }, 500);
      }
    }

    // Close popup when clicking outside of it
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.input-actions')) {
        fileMenu.classList.remove('show');
        connectionsMenu.classList.remove('show');
      }
    });


    // Initialize welcome popup check when page loads
    document.addEventListener('DOMContentLoaded', () => {
      checkWelcomePopup();
    });

    // Tutorial System
    let currentTutorialStep = 0;
    const tutorialSteps = [
      {
        target: '.model-selector',
        title: 'AI Model Selection',
        description: 'Choose between lixern for fast responses or VOMAX-1 for advanced reasoning. Each model has different capabilities to suit your needs.',
        position: 'bottom'
      },
      {
        target: '.sidebar',
        title: 'Conversation History',
        description: 'Access your previous conversations here. You can create new chats, organize your discussions, and quickly find past conversations.',
        position: 'right'
      },
      {
        target: '.input-area',
        title: 'Enhanced File Upload',
        description: 'Upload and analyze all types of files and images. The enhanced system supports documents, images, videos, archives, and more with advanced processing capabilities.',
        position: 'top'
      },
      {
        target: '.chat-container',
        title: 'Chat Area',
        description: 'Your conversation will appear here. Messages support rich formatting, code blocks, tables, file previews, and more. You can copy, download, or interact with the content.',
        position: 'center'
      }
    ];

    function startTutorial() {
      closeWelcomePopup();
      currentTutorialStep = 0;
      document.getElementById('tutorialTotalSteps').textContent = tutorialSteps.length;
      showTutorialStep();
    }

    function showTutorialStep() {
      const step = tutorialSteps[currentTutorialStep];
      const tutorialOverlay = document.getElementById('tutorialOverlay');
      const tutorialHighlight = document.getElementById('tutorialHighlight');
      const tutorialTooltip = document.getElementById('tutorialTooltip');
      const tutorialTitle = document.getElementById('tutorialTitle');
      const tutorialDescription = document.getElementById('tutorialDescription');
      const tutorialCurrentStep = document.getElementById('tutorialCurrentStep');
      const tutorialButtonText = document.getElementById('tutorialButtonText');

      // Update content
      tutorialTitle.textContent = step.title;
      tutorialDescription.textContent = step.description;
      tutorialCurrentStep.textContent = currentTutorialStep + 1;

      // Update button text for last step
      if (currentTutorialStep === tutorialSteps.length - 1) {
        tutorialButtonText.textContent = 'Finish';
      } else {
        tutorialButtonText.textContent = 'Next';
      }

      // Show overlay
      tutorialOverlay.classList.add('show');

      // Position highlight and tooltip
      setTimeout(() => {
        const targetElement = document.querySelector(step.target);
        if (targetElement) {
          const rect = targetElement.getBoundingClientRect();

          // Position highlight
          tutorialHighlight.style.left = (rect.left - 10) + 'px';
          tutorialHighlight.style.top = (rect.top - 10) + 'px';
          tutorialHighlight.style.width = (rect.width + 20) + 'px';
          tutorialHighlight.style.height = (rect.height + 20) + 'px';

          // Position tooltip based on step position
          let tooltipLeft, tooltipTop;

          switch (step.position) {
            case 'bottom':
              tooltipLeft = rect.left + (rect.width / 2) - 175; // Center tooltip (350px width / 2)
              tooltipTop = rect.bottom + 20;
              break;
            case 'top':
              tooltipLeft = rect.left + (rect.width / 2) - 175;
              tooltipTop = rect.top - tutorialTooltip.offsetHeight - 20;
              break;
            case 'right':
              tooltipLeft = rect.right + 20;
              tooltipTop = rect.top + (rect.height / 2) - (tutorialTooltip.offsetHeight / 2);
              break;
            case 'left':
              tooltipLeft = rect.left - 370; // 350px width + 20px margin
              tooltipTop = rect.top + (rect.height / 2) - (tutorialTooltip.offsetHeight / 2);
              break;
            case 'center':
            default:
              tooltipLeft = window.innerWidth / 2 - 175;
              tooltipTop = window.innerHeight / 2 - (tutorialTooltip.offsetHeight / 2);
              break;
          }

          // Ensure tooltip stays within viewport
          tooltipLeft = Math.max(20, Math.min(tooltipLeft, window.innerWidth - 370));
          tooltipTop = Math.max(20, Math.min(tooltipTop, window.innerHeight - tutorialTooltip.offsetHeight - 20));

          tutorialTooltip.style.left = tooltipLeft + 'px';
          tutorialTooltip.style.top = tooltipTop + 'px';
        }

        // Show tooltip with animation
        setTimeout(() => {
          tutorialTooltip.classList.add('show');
        }, 100);
      }, 100);
    }

    function nextTutorialStep() {
      tutorialTooltip.classList.remove('show');

      setTimeout(() => {
        currentTutorialStep++;
        if (currentTutorialStep >= tutorialSteps.length) {
          closeTutorial();
        } else {
          showTutorialStep();
        }
      }, 200);
    }

    function skipTutorial() {
      closeTutorial();
    }

    function closeTutorial() {
      const tutorialOverlay = document.getElementById('tutorialOverlay');
      const tutorialTooltip = document.getElementById('tutorialTooltip');

      tutorialTooltip.classList.remove('show');
      setTimeout(() => {
        tutorialOverlay.classList.remove('show');
        // Mark tutorial as completed
        localStorage.setItem('voai-tutorial-completed', 'true');
      }, 200);
    }

    // Close tutorial when clicking outside
    document.addEventListener("click", (e) => {
      const tutorialOverlay = document.getElementById("tutorialOverlay");
      if (e.target === tutorialOverlay) {
        closeTutorial();
      }
    });

    function toggleExpandableBox(button) {
      const header = button;
      const content = header.nextElementSibling;
      header.classList.toggle("expanded");
      content.classList.toggle("expanded");
      if (content.classList.contains("expanded")) {
        content.style.maxHeight = content.scrollHeight + "px";
      } else {
        content.style.maxHeight = null;
      }
    }

    // Image Analysis Functions
    let classifier = null;
    let objectDetector = null;

    // Initialize ML models
    async function initializeMLModels() {
      try {
        // Initialize image classifier
        if (typeof ml5 !== 'undefined') {
          classifier = await ml5.imageClassifier('MobileNet');
          console.log('MobileNet classifier loaded');
        }

        // Initialize object detector
        if (typeof ml5 !== 'undefined') {
          objectDetector = await ml5.objectDetector('cocossd');
          console.log('COCO-SSD object detector loaded');
        }
      } catch (error) {
        console.error('Error initializing ML models:', error);
      }
    }

    // Call initialization when page loads
    document.addEventListener('DOMContentLoaded', () => {
      initializeMLModels();
    });

    async function analyzeImage(imageSrc, fileName) {
      try {
        addBotMessage(` Analyzing image: ${fileName}...`);

        // Create image element for analysis
        const img = new Image();
        img.crossOrigin = 'anonymous';

        img.onload = async () => {
          let analysisResults = {
            fileName: fileName,
            dimensions: `${img.width} x ${img.height}`,
            classification: [],
            objects: [],
            colors: [],
            metadata: {}
          };

          try {
            // Image Classification
            if (classifier) {
              const predictions = await classifier.classify(img);
              analysisResults.classification = predictions.slice(0, 5).map(p => ({
                label: p.label,
                confidence: (p.confidence * 100).toFixed(2)
              }));
            }

            // Object Detection
            if (objectDetector) {
              const detections = await objectDetector.detect(img);
              analysisResults.objects = detections.slice(0, 10).map(d => ({
                label: d.label,
                confidence: (d.confidence * 100).toFixed(2),
                x: Math.round(d.x),
                y: Math.round(d.y),
                width: Math.round(d.width),
                height: Math.round(d.height)
              }));
            }

            // Color Analysis
            analysisResults.colors = await analyzeImageColors(img);

            // Basic metadata
            analysisResults.metadata = {
              fileSize: getImageFileSize(imageSrc),
              aspectRatio: (img.width / img.height).toFixed(2),
              megapixels: ((img.width * img.height) / 1000000).toFixed(2)
            };

            // Format and display results
            const analysisText = formatImageAnalysis(analysisResults);
            const message = ` **Image Analysis Complete: ${fileName}**`;
            addBotMessage(message, null, analysisText);

          } catch (error) {
            console.error('Analysis error:', error);
            addBotMessage(` Error analyzing image: ${fileName}. ${error.message}`);
          }
        };

        img.onerror = () => {
          addBotMessage(` Error loading image for analysis: ${fileName}`);
        };

        img.src = imageSrc;

      } catch (error) {
        console.error('Image analysis error:', error);
        addBotMessage(` Error analyzing image: ${fileName}. ${error.message}`);
      }
    }

    async function extractTextFromImage(imageSrc, fileName) {
      try {
        addBotMessage(` Extracting text from image: ${fileName}...`);

        if (typeof Tesseract === 'undefined') {
          addBotMessage(` OCR library not available. Please refresh the page and try again.`);
          return;
        }

        const { data: { text, confidence } } = await Tesseract.recognize(imageSrc, 'eng', {
          logger: m => {
            if (m.status === 'recognizing text') {
              console.log(`OCR Progress: ${Math.round(m.progress * 100)}%`);
            }
          }
        });

        if (text && text.trim().length > 0) {
          const ocrResults = {
            fileName: fileName,
            extractedText: text.trim(),
            confidence: Math.round(confidence),
            wordCount: text.trim().split(/\s+/).length,
            characterCount: text.trim().length
          };

          const ocrText = formatOCRResults(ocrResults);
          const message = ` **OCR Complete: ${fileName}**`;
          addBotMessage(message, null, ocrText);
        } else {
          addBotMessage(` OCR completed for ${fileName}, but no text was detected in the image.`);
        }

      } catch (error) {
        console.error('OCR error:', error);
        addBotMessage(` Error extracting text from image: ${fileName}. ${error.message}`);
      }
    }

    async function analyzeImageColors(img) {
      try {
        // Create canvas to analyze colors
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // Resize for faster processing
        const maxSize = 100;
        const scale = Math.min(maxSize / img.width, maxSize / img.height);
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;

        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        const colorCounts = {};
        const sampleRate = 4; // Sample every 4th pixel for performance

        for (let i = 0; i < data.length; i += 4 * sampleRate) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];

          // Group similar colors
          const colorKey = `${Math.floor(r / 32) * 32},${Math.floor(g / 32) * 32},${Math.floor(b / 32) * 32}`;
          colorCounts[colorKey] = (colorCounts[colorKey] || 0) + 1;
        }

        // Get top 5 colors
        const sortedColors = Object.entries(colorCounts)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 5)
          .map(([color, count]) => {
            const [r, g, b] = color.split(',').map(Number);
            return {
              rgb: `rgb(${r}, ${g}, ${b})`,
              hex: `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`,
              percentage: ((count / Object.values(colorCounts).reduce((a, b) => a + b, 0)) * 100).toFixed(1)
            };
          });

        return sortedColors;
      } catch (error) {
        console.error('Color analysis error:', error);
        return [];
      }
    }

    function formatImageAnalysis(results) {
      let analysis = `# Image Analysis Report\n\n`;

      analysis += `**File:** ${results.fileName}\n`;
      analysis += `**Dimensions:** ${results.dimensions} pixels\n`;
      analysis += `**Aspect Ratio:** ${results.metadata.aspectRatio}\n`;
      analysis += `**Megapixels:** ${results.metadata.megapixels} MP\n\n`;

      if (results.classification.length > 0) {
        analysis += `## Image Classification\n`;
        results.classification.forEach((pred, index) => {
          analysis += `${index + 1}. **${pred.label}** - ${pred.confidence}% confidence\n`;
        });
        analysis += '\n';
      }

      if (results.objects.length > 0) {
        analysis += `## Detected Objects\n`;
        results.objects.forEach((obj, index) => {
          analysis += `${index + 1}. **${obj.label}** - ${obj.confidence}% confidence\n`;
          analysis += `   Location: (${obj.x}, ${obj.y}) Size: ${obj.width}x${obj.height}\n`;
        });
        analysis += '\n';
      }

      if (results.colors.length > 0) {
        analysis += `## Dominant Colors\n`;
        results.colors.forEach((color, index) => {
          analysis += `${index + 1}. ${color.hex} (${color.rgb}) - ${color.percentage}%\n`;
        });
        analysis += '\n';
      }

      analysis += `## Technical Details\n`;
      analysis += `- **File Size:** ${results.metadata.fileSize}\n`;
      analysis += `- **Color Space:** RGB\n`;
      analysis += `- **Analysis Method:** Machine Learning (MobileNet, COCO-SSD)\n`;

      return analysis;
    }

    function formatOCRResults(results) {
      let ocrText = `# OCR Extraction Report\n\n`;

      ocrText += `**File:** ${results.fileName}\n`;
      ocrText += `**Confidence:** ${results.confidence}%\n`;
      ocrText += `**Word Count:** ${results.wordCount}\n`;
      ocrText += `**Character Count:** ${results.characterCount}\n\n`;

      ocrText += `## Extracted Text\n\n`;
      ocrText += `${results.extractedText}\n\n`;

      ocrText += `## Technical Details\n`;
      ocrText += `- **OCR Engine:** Tesseract.js\n`;
      ocrText += `- **Language:** English\n`;
      ocrText += `- **Processing Method:** Client-side OCR\n`;

      return ocrText;
    }

    function getImageFileSize(dataUrl) {
      try {
        const base64 = dataUrl.split(',')[1];
        const bytes = atob(base64).length;
        return formatFileSize(bytes);
      } catch (error) {
        return 'Unknown';
      }
    }

    // Right-side Code View Functions
    function openCodeView(codeContent, language = 'code') {
      const codeViewPanel = document.getElementById('codeViewPanel');
      const codeViewTitle = document.getElementById('codeViewTitle');
      const codeViewCode = document.getElementById('codeViewCode');
      const codeViewTabs = document.getElementById('codeViewTabs');

      // Set the title based on detected language
      codeViewTitle.textContent = `Code View - ${language.charAt(0).toUpperCase() + language.slice(1)}`;

      // Set the code content
      codeViewCode.textContent = codeContent;

      // Store the code content for other functions
      codeViewPanel.dataset.codeContent = codeContent;
      codeViewPanel.dataset.language = language;

      // Show the panel
      codeViewPanel.classList.add('open');
      document.body.classList.add('code-view-open');

      // Show tabs only for HTML
      if (language.toLowerCase().includes('html')) {
        codeViewTabs.style.display = 'flex';
      } else {
        codeViewTabs.style.display = 'none';
      }

      // Reset to code tab
      switchCodeViewTab('code');
    }

    function closeCodeView() {
      const codeViewPanel = document.getElementById('codeViewPanel');
      codeViewPanel.classList.remove('open');
      document.body.classList.remove('code-view-open');

      // Restore compact blocks if they were in AI Coding mode
      if (codeViewPanel.dataset.language === 'AI Coding') {
        document.querySelectorAll('.code-block.compact').forEach(block => {
          block.classList.remove('compact');
          const countSpan = block.querySelector('.code-line-count');
          if (countSpan) countSpan.remove();
        });
      }
    }

    function copyCodeFromView() {
      const codeViewPanel = document.getElementById('codeViewPanel');
      const codeContent = codeViewPanel.dataset.codeContent;

      navigator.clipboard.writeText(codeContent).then(() => {
        // Show confirmation
        const copyBtn = document.querySelector('.code-view-action[onclick="copyCodeFromView()"]');
        const originalHTML = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied';
        copyBtn.style.background = 'var(--accent-success)';

        setTimeout(() => {
          copyBtn.innerHTML = originalHTML;
          copyBtn.style.background = '';
        }, 2000);
      });
    }

    function downloadCodeFromView() {
      const codeViewPanel = document.getElementById('codeViewPanel');
      const codeContent = codeViewPanel.dataset.codeContent;
      const language = codeViewPanel.dataset.language || 'code';

      // Determine file extension
      let extension = 'txt';
      if (language.includes('javascript') || codeContent.includes('function') || codeContent.includes('var') || codeContent.includes('const')) {
        extension = 'js';
      } else if (language.includes('python') || codeContent.includes('def ') || codeContent.includes('import ')) {
        extension = 'py';
      } else if (language.includes('html') || codeContent.includes('<html') || codeContent.includes('<!DOCTYPE')) {
        extension = 'html';
      } else if (language.includes('css') || codeContent.includes('{') && codeContent.includes('}')) {
        extension = 'css';
      } else if (language.includes('sql') || codeContent.includes('SELECT ') || codeContent.includes('FROM ')) {
        extension = 'sql';
      }

      // Create and download file
      const blob = new Blob([codeContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `voai_code.${extension}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Show confirmation
      const downloadBtn = document.querySelector('.code-view-action[onclick="downloadCodeFromView()"]');
      const originalHTML = downloadBtn.innerHTML;
      downloadBtn.innerHTML = '<i class="fas fa-check"></i> Downloaded';
      downloadBtn.style.background = 'var(--accent-success)';

      setTimeout(() => {
        downloadBtn.innerHTML = originalHTML;
        downloadBtn.style.background = '';
      }, 2000);
    }

    function runCodeFromView() {
      const codeViewPanel = document.getElementById('codeViewPanel');
      const codeContent = codeViewPanel.dataset.codeContent;
      const language = codeViewPanel.dataset.language || 'code';
      const outputSection = document.getElementById('codeViewOutput');
      const outputContent = document.getElementById('codeViewOutputContent');

      // Show output section
      outputSection.style.display = 'block';

      try {
        let result = '';

        if (language.includes('html')) {
          // HTML Execution in iframe
          const iframe = document.createElement('iframe');
          iframe.style.width = '100%';
          iframe.style.height = '400px';
          iframe.style.border = '1px solid var(--gray-300)';
          iframe.style.borderRadius = 'var(--radius-md)';
          iframe.style.background = 'white';

          outputContent.innerHTML = '';
          outputContent.appendChild(iframe);

          const doc = iframe.contentWindow.document;
          doc.open();
          doc.write(codeContent);
          doc.close();
          return; // Exit early as we've handled the output
        } else if (language.includes('javascript') || codeContent.includes('console.log') || codeContent.includes('function')) {
          // Simple JavaScript execution
          const originalLog = console.log;
          const logs = [];
          console.log = (...args) => logs.push(args.join(' '));

          try {
            eval(codeContent);
            result = logs.length > 0 ? logs.join('\n') : 'Code executed successfully (no output)';
          } catch (error) {
            result = `Error: ${error.message}`;
          } finally {
            console.log = originalLog;
          }
        } else if (language.includes('python') || codeContent.includes('print(') || codeContent.includes('def ')) {
          // Simulate Python execution for simple cases
          if (codeContent.includes('print(')) {
            const printMatches = codeContent.match(/print\((.*?)\)/g);
            if (printMatches) {
              result = printMatches.map(match => {
                const content = match.replace(/print\(|\)/g, '').replace(/['"]/g, '');
                return content;
              }).join('\n');
            }
          } else {
            result = 'Python code detected. Full Python execution would require a Python interpreter.';
          }
        } else if (language.includes('html') || codeContent.includes('<html') || codeContent.includes('<!DOCTYPE')) {
          // Open HTML in new tab
          const blob = new Blob([codeContent], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank');
          result = 'HTML code opened in new tab';
        } else if (language.includes('css')) {
          result = 'CSS code detected. Cannot run CSS directly - it needs to be applied to HTML elements.';
        } else if (language.includes('json')) {
          try {
            JSON.parse(codeContent);
            result = 'Valid JSON format';
          } catch (error) {
            result = `Invalid JSON: ${error.message}`;
          }
        } else {
          result = 'Code execution not supported for this language type.';
        }

        outputContent.textContent = result;
      } catch (error) {
        outputContent.textContent = `Error: ${error.message}`;
      }
    }

    // Close code view when clicking outside
    document.addEventListener('click', (e) => {
      const codeViewPanel = document.getElementById('codeViewPanel');
      if (e.target === codeViewPanel) {
        closeCodeView();
      }
    });

    // Close code view with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const codeViewPanel = document.getElementById('codeViewPanel');
        if (codeViewPanel.classList.contains('open')) {
          closeCodeView();
        }
      }
    });

    // PowerPoint Creation Functionality
    function openPowerPointCreator() {
      // Create PowerPoint creation modal
      const modalHTML = `
        <div id="powerpointModal" class="powerpoint-modal">
          <div class="powerpoint-modal-content">
            <div class="powerpoint-modal-header">
              <h3><i class="fas fa-file-powerpoint"></i> Create PowerPoint Presentation</h3>
              <button class="powerpoint-modal-close" onclick="closePowerPointCreator()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="powerpoint-modal-body">
              <div class="powerpoint-form">
                <div class="form-group">
                  <label for="presentationTitle">Presentation Title:</label>
                  <input type="text" id="presentationTitle" placeholder="Enter your presentation title" />
                </div>
                <div class="form-group">
                  <label for="presentationTopic">Topic/Subject:</label>
                  <input type="text" id="presentationTopic" placeholder="What is your presentation about?" />
                </div>
                <div class="form-group">
                  <label for="slideCount">Number of Slides:</label>
                  <select id="slideCount">
                    <option value="5">5 slides</option>
                    <option value="10" selected>10 slides</option>
                    <option value="15">15 slides</option>
                    <option value="20">20 slides</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="presentationStyle">Presentation Style:</label>
                  <select id="presentationStyle">
                    <option value="professional">Professional</option>
                    <option value="creative">Creative</option>
                    <option value="academic">Academic</option>
                    <option value="business">Business</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="includeImages">Include Images:</label>
                  <select id="includeImages">
                    <option value="yes">Yes - Add relevant images</option>
                    <option value="no">No - Text only</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="animationStyle">Animation Style:</label>
                  <select id="animationStyle">
                    <option value="subtle">Subtle animations</option>
                    <option value="dynamic">Dynamic animations</option>
                    <option value="none">No animations</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="backgroundStyle">Background Style:</label>
                  <select id="backgroundStyle">
                    <option value="solid">Solid colors</option>
                    <option value="gradient">Gradient backgrounds</option>
                    <option value="pattern">Pattern backgrounds</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="additionalRequirements">Additional Requirements:</label>
                  <textarea id="additionalRequirements" placeholder="Any specific requirements, content, or structure you want to include..."></textarea>
                </div>
              </div>
            </div>
            <div class="powerpoint-modal-footer">
              <button class="powerpoint-btn-secondary" onclick="closePowerPointCreator()">Cancel</button>
              <button class="powerpoint-btn-primary" onclick="generatePowerPoint()">
                <i class="fas fa-magic"></i> Generate PowerPoint
              </button>
            </div>
          </div>
        </div>
      `;

      // Add modal to page
      document.body.insertAdjacentHTML('beforeend', modalHTML);

      // Show modal
      setTimeout(() => {
        document.getElementById('powerpointModal').classList.add('show');
      }, 10);
    }

    function closePowerPointCreator() {
      const modal = document.getElementById('powerpointModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
          modal.remove();
        }, 300);
      }
    }

    async function generatePowerPoint() {
      const title = document.getElementById('presentationTitle').value.trim();
      const topic = document.getElementById('presentationTopic').value.trim();
      const slideCount = document.getElementById('slideCount').value;
      const style = document.getElementById('presentationStyle').value;
      const includeImages = document.getElementById('includeImages').value;
      const animationStyle = document.getElementById('animationStyle').value;
      const backgroundStyle = document.getElementById('backgroundStyle').value;
      const requirements = document.getElementById('additionalRequirements').value.trim();

      if (!title || !topic) {
        alert('Please fill in the title and topic fields.');
        return;
      }

      // Close modal
      closePowerPointCreator();

      // Hide empty state and show generating message
      hideEmptyState();

      // Add user message
      addUserMessage(`Create a PowerPoint presentation: "${title}" about ${topic} with ${slideCount} slides in ${style} style, ${includeImages === 'yes' ? 'including images' : 'text only'}, ${animationStyle} animations, and ${backgroundStyle} backgrounds.`);

      // Show typing indicator
      const typingMessage = addBotTyping();

      try {
        // Generate PowerPoint content using enhanced AI prompt
        const prompt = `Create an exceptionally professional PowerPoint presentation with the following specifications:

PRESENTATION DETAILS:
- Title: ${title}
- Topic: ${topic}
- Number of slides: ${slideCount}
- Style: ${style}
- Include Images: ${includeImages === 'yes' ? 'Yes - provide detailed image descriptions and suggestions' : 'No - focus on compelling text content'}
- Animation Style: ${animationStyle}
- Background Style: ${backgroundStyle}
- Additional requirements: ${requirements || 'None'}

CONTENT STRUCTURE REQUIREMENTS:
Please provide a meticulously structured presentation with the following format:

**Slide 1: [Title]**
- Main title content
- Key subtitle or tagline
- Brief overview statement

**Slide 2: [Introduction/Overview]**
- Hook or attention-grabbing opening
- Problem statement or context
- Presentation roadmap (3-4 key points)
${includeImages === 'yes' ? '- IMAGE SUGGESTION: [Describe a compelling opening image]' : ''}

**Slide 3-${parseInt(slideCount) - 2}: [Content Slides]**
For each content slide, provide:
- Clear, compelling slide title
- 3-5 well-structured bullet points or key concepts
- Supporting details and explanations
- Data points, statistics, or examples where relevant
${includeImages === 'yes' ? '- IMAGE SUGGESTION: [Describe relevant supporting visuals]' : ''}

**Slide ${slideCount - 1}: [Key Takeaways/Summary]**
- 3-4 main conclusions or key points
- Actionable insights or recommendations
- Transition to conclusion
${includeImages === 'yes' ? '- IMAGE SUGGESTION: [Describe summary or conclusion visual]' : ''}

**Slide ${slideCount}: [Conclusion/Call to Action]**
- Powerful closing statement
- Call to action or next steps
- Contact information or follow-up details
${includeImages === 'yes' ? '- IMAGE SUGGESTION: [Describe impactful closing image]' : ''}

CONTENT QUALITY STANDARDS:
1. **Professional Language**: Use sophisticated, business-appropriate vocabulary
2. **Clear Structure**: Each slide should have a logical flow and clear hierarchy
3. **Compelling Content**: Include engaging facts, statistics, and real-world examples
4. **Actionable Insights**: Provide practical takeaways and recommendations
5. **Visual Descriptions**: ${includeImages === 'yes' ? 'Provide detailed, specific image suggestions that enhance the message' : 'Focus on creating vivid, descriptive text that paints a clear picture'}
6. **Consistency**: Maintain consistent tone and messaging throughout
7. **Engagement**: Use rhetorical questions, compelling statements, and thought-provoking content

STYLE-SPECIFIC GUIDELINES:
${style === 'professional' ? '- Use formal, authoritative language with industry terminology\n- Include data-driven insights and evidence-based conclusions\n- Focus on ROI, efficiency, and strategic implications' : ''}
${style === 'creative' ? '- Use innovative analogies and creative metaphors\n- Include inspiring quotes and visionary statements\n- Focus on possibilities, innovation, and breakthrough thinking' : ''}
${style === 'academic' ? '- Use scholarly language with proper citations and references\n- Include theoretical frameworks and research-based evidence\n- Focus on methodology, analysis, and peer-reviewed insights' : ''}
${style === 'business' ? '- Use results-oriented language with clear metrics\n- Include market analysis and competitive insights\n- Focus on growth, profitability, and strategic advantages' : ''}

FORMAT REQUIREMENTS:
- Use "**Slide X: [Title]**" headers for easy parsing
- Structure content with clear bullet points using "-" 
- Include speaker notes for complex slides
- Provide transition suggestions between slides
- Ensure each slide can stand alone while contributing to the overall narrative

Please create content that would be suitable for a ${style} presentation to a professional audience, with exceptional attention to detail and compelling storytelling.`;


        // Send to AI for content generation
        const response = await generateAIResponse(prompt);

        // Remove typing indicator
        removeBotTyping(typingMessage);

        // Add AI response
        addBotMessage(response);

        // Generate and download PowerPoint file with enhanced options
        await createPowerPointFile(title, response, {
          style,
          includeImages: includeImages === 'yes',
          animationStyle,
          backgroundStyle
        });

      } catch (error) {
        removeBotTyping(typingMessage);
        addBotMessage(` Error generating PowerPoint: ${error.message}`);
      }
    }

    // Configuration for API endpoints
    async function generateAIResponse(prompt) {
      const controller = new AbortController();

      let messages = [{ role: "user", content: prompt }];

      // Add system message for PowerPoint generation

      let response, reply;

      if (currentModel.name === "lixern") {
        response = await fetch("/api/groq", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: currentModel.modelId,
            messages: messages
          }),
          signal: controller.signal
        });
        const data = await response.json();
        reply = data.choices?.[0]?.message?.content || "something went wrong! try creating a new chat or refreshing the page.";
      } else { // VOMAX-1
        const contents = messages.map(msg => ({
          role: msg.role === "user" ? "user" : "model",
          parts: [{ text: msg.content }]
        }));

        response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${currentModel.modelId}:generateContent?key=${currentModel.apiKey}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            contents: contents
          }),
          signal: controller.signal
        });
        const data = await response.json();
        reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "something went wrong! try creating a new chat or refreshing the page.";
      }

      return reply;
    }

    async function createPowerPointFile(title, content, options = {}) {
      try {
        // Initialize PptxGenJS
        const pptx = new PptxGenJS();

        // Set presentation properties
        pptx.author = 'VOAI Assistant';
        pptx.company = 'OurVendo AI';
        pptx.title = title;
        pptx.subject = 'AI Generated Presentation';

        // Extract options
        const { style = 'professional', includeImages = false, animationStyle = 'subtle', backgroundStyle = 'solid' } = options;

        // Define enhanced professional color schemes and themes
        const colorSchemes = {
          professional: {
            background: backgroundStyle === 'gradient' ? { type: 'linear', colors: ['FFFFFF', 'F8FAFC'] } : 'FFFFFF',
            primary: '1E293B',      // Sophisticated dark blue-gray
            secondary: '475569',    // Medium slate
            accent: '0F172A',       // Deep navy for emphasis
            highlight: '3B82F6',    // Professional blue
            text: '334155',         // Readable dark gray
            light: 'F1F5F9',       // Very light blue-gray
            success: '059669',      // Professional green
            warning: 'D97706'       // Professional amber
          },
          creative: {
            background: backgroundStyle === 'gradient' ? { type: 'linear', colors: ['FEFEFE', 'F9FAFB'] } : 'FEFEFE',
            primary: '7C3AED',      // Vibrant purple
            secondary: 'EC4899',    // Creative pink
            accent: 'F59E0B',       // Creative orange
            highlight: '10B981',    // Fresh green
            text: '374151',         // Warm dark gray
            light: 'F3F4F6',       // Neutral light
            success: '059669',      // Success green
            warning: 'DC2626'       // Alert red
          },
          academic: {
            background: backgroundStyle === 'gradient' ? { type: 'linear', colors: ['FFFFFF', 'FAFBFC'] } : 'FFFFFF',
            primary: '1F2937',      // Academic dark gray
            secondary: '4B5563',    // Medium gray
            accent: '1D4ED8',       // Academic blue
            highlight: '7C2D12',    // Academic brown
            text: '374151',         // Text gray
            light: 'F9FAFB',       // Light background
            success: '047857',      // Academic green
            warning: 'B45309'       // Academic orange
          },
          business: {
            background: backgroundStyle === 'gradient' ? { type: 'linear', colors: ['FFFFFF', 'F8FAFC'] } : 'FFFFFF',
            primary: '0F172A',      // Corporate navy
            secondary: '334155',    // Corporate gray
            accent: '1E40AF',       // Corporate blue
            highlight: '059669',    // Corporate green
            text: '475569',         // Business text
            light: 'F1F5F9',       // Corporate light
            success: '047857',      // Success indicator
            warning: 'DC2626'       // Warning indicator
          }
        };

        const colors = colorSchemes[style];

        // Define advanced slide layouts and templates
        const slideLayouts = {
          title: {
            titleArea: { x: 0.5, y: 1.5, w: 9, h: 2 },
            subtitleArea: { x: 0.5, y: 4, w: 9, h: 1 },
            decorativeElements: true
          },
          content: {
            titleArea: { x: 0.5, y: 0.3, w: 9, h: 0.8 },
            contentArea: { x: 0.5, y: 1.5, w: 9, h: 5.5 },
            sidebarWidth: 0.15
          },
          twoColumn: {
            titleArea: { x: 0.5, y: 0.3, w: 9, h: 0.8 },
            leftColumn: { x: 0.5, y: 1.5, w: 4.25, h: 5.5 },
            rightColumn: { x: 5.25, y: 1.5, w: 4.25, h: 5.5 }
          },
          imageContent: {
            titleArea: { x: 0.5, y: 0.3, w: 9, h: 0.8 },
            imageArea: { x: 0.5, y: 1.5, w: 4.5, h: 3.5 },
            textArea: { x: 5.2, y: 1.5, w: 4.3, h: 5.5 }
          },
          conclusion: {
            titleArea: { x: 0.5, y: 2, w: 9, h: 1.5 },
            contentArea: { x: 0.5, y: 4, w: 9, h: 2.5 },
            emphasizeTitle: true
          }
        };

        // Professional typography settings
        const typography = {
          title: {
            fontSize: style === 'creative' ? 48 : 44,
            fontFace: style === 'academic' ? 'Times New Roman' : 'Calibri',
            bold: true,
            letterSpacing: style === 'business' ? 1 : 0
          },
          subtitle: {
            fontSize: 28,
            fontFace: style === 'academic' ? 'Times New Roman' : 'Calibri',
            bold: false,
            italic: style === 'academic'
          },
          heading: {
            fontSize: 36,
            fontFace: style === 'academic' ? 'Times New Roman' : 'Calibri',
            bold: true
          },
          body: {
            fontSize: 20,
            fontFace: style === 'academic' ? 'Times New Roman' : 'Calibri',
            lineSpacing: 1.4
          },
          caption: {
            fontSize: 14,
            fontFace: style === 'academic' ? 'Times New Roman' : 'Calibri',
            italic: true
          }
        };

        // Create professional title slide with advanced layout
        const titleSlide = pptx.addSlide();
        const titleLayout = slideLayouts.title;

        // Set sophisticated background
        if (typeof colors.background === 'object') {
          titleSlide.background = { fill: colors.background.colors[0] };
        } else {
          titleSlide.background = { color: colors.background };
        }

        // Add professional background elements
        if (backgroundStyle === 'pattern') {
          // Subtle geometric pattern
          for (let i = 0; i < 20; i++) {
            titleSlide.addShape(pptx.ShapeType.ellipse, {
              x: Math.random() * 10, y: Math.random() * 7.5, w: 0.1, h: 0.1,
              fill: { color: colors.light, transparency: 85 },
              line: { color: colors.accent, width: 0.5, transparency: 90 }
            });
          }
        } else if (backgroundStyle === 'gradient') {
          // Professional gradient overlay
          titleSlide.addShape(pptx.ShapeType.rect, {
            x: 0, y: 0, w: 10, h: 7.5,
            fill: {
              type: 'gradient',
              colors: [
                { color: colors.light, position: 0, transparency: 95 },
                { color: colors.accent, position: 100, transparency: 98 }
              ],
              angle: 45
            },
            line: { width: 0 }
          });
        }

        // Add sophisticated header design element
        titleSlide.addShape(pptx.ShapeType.rect, {
          x: 0, y: 0, w: 10, h: 0.8,
          fill: {
            type: 'gradient',
            colors: [
              { color: colors.primary, position: 0, transparency: 10 },
              { color: colors.accent, position: 100, transparency: 30 }
            ]
          },
          line: { width: 0 }
        });

        // Add main title with professional typography
        titleSlide.addText(title, {
          x: titleLayout.titleArea.x, y: titleLayout.titleArea.y,
          w: titleLayout.titleArea.w, h: titleLayout.titleArea.h,
          fontSize: typography.title.fontSize,
          fontFace: typography.title.fontFace,
          color: colors.primary,
          bold: typography.title.bold,
          align: 'center', valign: 'middle',
          shadow: {
            type: 'outer', color: colors.accent, blur: 4, offset: 2,
            angle: 45, transparency: 70
          },
          letterSpacing: typography.title.letterSpacing || 0
        });

        // Add professional subtitle
        titleSlide.addText('AI-Generated Professional Presentation', {
          x: titleLayout.subtitleArea.x, y: titleLayout.subtitleArea.y,
          w: titleLayout.subtitleArea.w, h: titleLayout.subtitleArea.h,
          fontSize: typography.subtitle.fontSize,
          fontFace: typography.subtitle.fontFace,
          color: colors.secondary,
          bold: typography.subtitle.bold,
          italic: typography.subtitle.italic,
          align: 'center', valign: 'middle'
        });

        // Add sophisticated decorative elements
        if (titleLayout.decorativeElements) {
          // Professional accent line
          titleSlide.addShape(pptx.ShapeType.rect, {
            x: 2, y: 5.8, w: 6, h: 0.08,
            fill: {
              type: 'gradient',
              colors: [
                { color: colors.highlight, position: 0 },
                { color: colors.accent, position: 50 },
                { color: colors.highlight, position: 100 }
              ]
            },
            line: { width: 0 }
          });

          // Corner design elements
          titleSlide.addShape(pptx.ShapeType.triangle, {
            x: 0.2, y: 0.2, w: 0.8, h: 0.8,
            fill: { color: colors.highlight, transparency: 80 },
            line: { color: colors.accent, width: 1, transparency: 60 }
          });

          titleSlide.addShape(pptx.ShapeType.triangle, {
            x: 9, y: 6.5, w: 0.8, h: 0.8,
            fill: { color: colors.accent, transparency: 80 },
            line: { color: colors.highlight, width: 1, transparency: 60 },
            rotate: 180
          });
        }

        // Add professional footer with branding
        titleSlide.addText('Powered by VOAI Assistant', {
          x: 0.5, y: 6.8, w: 9, h: 0.4,
          fontSize: typography.caption.fontSize,
          fontFace: typography.caption.fontFace,
          color: colors.secondary,
          italic: typography.caption.italic,
          align: 'center', transparency: 40
        });

        // Parse AI content and create enhanced slides
        const sections = content.split(/(?:Slide \d+:|##|\*\*Slide)/i).filter(section => section.trim());

        sections.forEach((section, index) => {
          if (index === 0 || !section.trim()) return; // Skip empty or title section

          const slide = pptx.addSlide();

          // Set background
          if (typeof colors.background === 'object') {
            slide.background = { fill: colors.background.colors[0] };
          } else {
            slide.background = { color: colors.background };
          }

          // Add background pattern if selected
          if (backgroundStyle === 'pattern') {
            slide.addShape(pptx.ShapeType.rect, {
              x: 0, y: 0, w: 10, h: 7.5,
              fill: { color: colors.light, transparency: 90 },
              line: { color: colors.accent, width: 0.3, dashType: 'dot' }
            });
          }

          // Extract slide title and content
          const lines = section.trim().split('\n').filter(line => line.trim());
          const slideTitle = lines[0]?.replace(/^\d+\.?\s*/, '').replace(/\*\*/g, '').trim() || `Slide ${index}`;
          const slideContent = lines.slice(1).join('\n').trim();

          // Add slide title with enhanced styling
          slide.addText(slideTitle, {
            x: 0.5, y: 0.5, w: 9, h: 1,
            fontSize: 32, fontFace: 'Arial', color: colors.primary,
            bold: true, align: 'left',
            shadow: { type: 'outer', color: '000000', blur: 2, offset: 1, angle: 45 }
          });

          // Add title underline with gradient effect
          slide.addShape(pptx.ShapeType.rect, {
            x: 0.5, y: 1.6, w: 9, h: 0.05,
            fill: { color: colors.accent }
          });

          // Process content into bullet points or paragraphs
          const contentLines = slideContent.split('\n').filter(line => line.trim());
          let yPosition = 2.2;

          contentLines.forEach((line, lineIndex) => {
            if (yPosition > 6.5) return; // Prevent overflow

            const cleanLine = line.replace(/^[-*]\s*/, '').trim();
            if (!cleanLine) return;

            // Determine if it's a bullet point
            const isBullet = /^[-*]\s*/.test(line);

            slide.addText(cleanLine, {
              x: isBullet ? 1 : 0.5,
              y: yPosition,
              w: isBullet ? 8.5 : 9,
              h: 0.6,
              fontSize: 18,
              fontFace: 'Arial',
              color: colors.text,
              align: 'left',
              bullet: isBullet ? { type: 'bullet', style: '', color: colors.accent } : false
            });

            yPosition += 0.7;
          });

          // Add slide number with styling
          slide.addText(`${index}`, {
            x: 9, y: 7, w: 0.5, h: 0.3,
            fontSize: 12, fontFace: 'Arial', color: colors.secondary,
            align: 'center'
          });

          // Add enhanced decorative elements based on slide content
          if (slideTitle.toLowerCase().includes('conclusion') || slideTitle.toLowerCase().includes('summary')) {
            // Add conclusion slide decoration
            slide.addShape(pptx.ShapeType.rect, {
              x: 0.2, y: 0.2, w: 0.3, h: 7.3,
              fill: { color: colors.accent, transparency: 20 },
              line: { color: colors.accent, width: 2 }
            });
          } else if (slideTitle.toLowerCase().includes('introduction') || index === 1) {
            // Add introduction slide decoration
            slide.addShape(pptx.ShapeType.ellipse, {
              x: 8.5, y: 6, w: 1, h: 1,
              fill: { color: colors.secondary, transparency: 70 },
              line: { color: colors.secondary, width: 2 }
            });
          }

          // Add side accent bar for visual interest
          slide.addShape(pptx.ShapeType.rect, {
            x: 0, y: 0, w: 0.1, h: 7.5,
            fill: { color: colors.accent }
          });
        });

        // Add enhanced final slide
        const finalSlide = pptx.addSlide();
        finalSlide.background = {
          color: colors.primary
        };

        finalSlide.addText('Thank You!', {
          x: 0.5, y: 2.5, w: 9, h: 1.5,
          fontSize: 48, fontFace: 'Arial', color: 'FFFFFF',
          bold: true, align: 'center', valign: 'middle',
          shadow: { type: 'outer', color: '000000', blur: 5, offset: 3, angle: 45 }
        });

        finalSlide.addText('Questions & Discussion', {
          x: 0.5, y: 4.5, w: 9, h: 1,
          fontSize: 24, fontFace: 'Arial', color: 'FFFFFF',
          align: 'center', valign: 'middle'
        });

        // Add decorative elements to final slide
        finalSlide.addShape(pptx.ShapeType.ellipse, {
          x: 2, y: 1, w: 6, h: 0.3,
          fill: { color: colors.accent, transparency: 50 }
        });

        // Generate and download PPTX file
        const fileName = `${title.replace(/[^a-zA-Z0-9]/g, '_')}_presentation.pptx`;
        await pptx.writeFile({ fileName: fileName });

        // Show enhanced success message
        addBotMessage(` PowerPoint presentation "${title}" has been generated and downloaded as a PPTX file! 

Features included:
 ${style.charAt(0).toUpperCase() + style.slice(1)} styling with ${backgroundStyle} backgrounds
 ${animationStyle === 'none' ? 'Clean static design' : animationStyle.charAt(0).toUpperCase() + animationStyle.slice(1) + ' animations'}
 ${includeImages ? 'Image placeholders and suggestions' : 'Text-focused content'}
 Professional color scheme and typography
 Decorative elements and visual enhancements

The presentation is ready to use in PowerPoint, Google Slides, or any compatible presentation software!`);

      } catch (error) {
        console.error('PPTX Generation Error:', error);
        throw new Error(`Failed to create PPTX file: ${error.message}`);
      }
    }

    // Client-side Document Generation Functions
    async function generateDocument(button, format) {
      try {
        // Find the message content
        const messageElement = button.closest('.message');
        const messageContent = messageElement.querySelector('.message-bubble').innerText;

        // Extract a filename from the first line or use default
        const firstLine = messageContent.split('\n')[0];
        const fileName = firstLine.length > 50 ? 'AI_Response' : firstLine.replace(/[^a-zA-Z0-9]/g, '_');

        // Show loading state
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        button.disabled = true;

        let blob;
        let downloadFileName;

        if (format === 'pdf') {
          blob = await generatePDF(messageContent);
          downloadFileName = `${fileName}.pdf`;
        } else if (format === 'docx') {
          blob = await generateDOCX(messageContent);
          downloadFileName = `${fileName}.docx`;
        } else if (format === 'excel') {
          blob = await generateExcel(messageContent);
          downloadFileName = `${fileName}.xlsx`;
        }

        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = downloadFileName;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        // Show success message
        addBotMessage(` ${format.toUpperCase()} document generated and downloaded successfully!`);

      } catch (error) {
        console.error('Document generation error:', error);
        addBotMessage(` Error generating ${format.toUpperCase()} document: ${error.message}`);
      } finally {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    // Generate PDF using jsPDF
    async function generatePDF(content) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Set font and size
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(12);

      // Split content into lines that fit the page width
      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 20;
      const maxLineWidth = pageWidth - 2 * margin;

      const lines = doc.splitTextToSize(content, maxLineWidth);

      let y = margin;
      const lineHeight = 7;
      const pageHeight = doc.internal.pageSize.getHeight();

      for (let i = 0; i < lines.length; i++) {
        if (y + lineHeight > pageHeight - margin) {
          doc.addPage();
          y = margin;
        }
        doc.text(lines[i], margin, y);
        y += lineHeight;
      }

      return doc.output('blob');
    }

    // Generate DOCX using docx library
    async function generateDOCX(content) {
      try {
        // Check if docx library is available
        if (typeof docx === 'undefined') {
          throw new Error('DOCX library not loaded');
        }

        const { Document, Packer, Paragraph, TextRun } = docx;

        // Split content into paragraphs
        const paragraphs = content.split('\n').map(line =>
          new Paragraph({
            children: [new TextRun(line || ' ')], // Empty line if no content
          })
        );

        const doc = new Document({
          sections: [{
            properties: {},
            children: paragraphs,
          }],
        });

        return await Packer.toBlob(doc);
      } catch (error) {
        console.error('DOCX generation error:', error);
        // Fallback: create a simple text file with .docx extension
        const blob = new Blob([content], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
        return blob;
      }
    }

    // Generate Excel using xlsx library
    async function generateExcel(content) {
      const wb = XLSX.utils.book_new();

      // Split content into lines and create worksheet data
      const lines = content.split('\n');
      const wsData = lines.map((line, index) => ({
        'Line': index + 1,
        'Content': line
      }));

      const ws = XLSX.utils.json_to_sheet(wsData);

      // Set column widths
      ws['!cols'] = [
        { width: 10 },  // Line number column
        { width: 100 }  // Content column
      ];

      XLSX.utils.book_append_sheet(wb, ws, 'AI Response');

      return new Promise((resolve) => {
        XLSX.writeFile(wb, 'temp.xlsx', {
          bookType: 'xlsx',
          type: 'binary',
          cellStyles: true
        });

        // Convert to blob
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        resolve(new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }));
      });
    }

    const sentences = [
      "Whats on your mind today?",
      "Where should we begin?",
      "Ready when you are.",
      "What are you working on?",
      "Welcome back!",
      "Whats inspiring you right now?",
      "How can I assist you today?",
      "Anything exciting on your agenda?",
      "What would you like to explore?",
      "Lets dive into your project."
    ];


    const random = Math.floor(Math.random() * sentences.length);
    document.getElementById("title").textContent = sentences[random];
    "img2url\index.html"
    "Feedback\index.html"
  </script>



  <!-- Load Google Identity Services for Gmail OAuth -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Gmail OAuth and sendEmail implementation -->
  <script>
    // Gmail OAuth configuration
    const GOOGLE_CLIENT_ID = "99192169098-9s302uh5asuchojotqvnie020q464acp.apps.googleusercontent.com";
    const GMAIL_SCOPES = "https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/gmail.send";
    let gmailAccessToken = null;

    // Trigger the OAuth flow to connect a user's Gmail account
    function connectGmail() {
      google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: GMAIL_SCOPES,
        callback: (tokenResponse) => {
          gmailAccessToken = tokenResponse.access_token;
          addBotMessage("Gmail Connected  You can now send emails.");
        },
      }).requestAccessToken();
    }

    // Use the Gmail REST API to send an email
    async function sendEmail(to, subject, message) {
      if (!gmailAccessToken) {
        addBotMessage(" Gmail is not connected.");
        return;
      }
      const email =
        `To: ${to}\r\n` +
        `Subject: ${subject}\r\n` +
        `Content-Type: text/plain; charset="UTF-8"\r\n\r\n` +
        message;
      const base64Email = btoa(email)
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=+$/, "");
      const response = await fetch(
        "https://gmail.googleapis.com/gmail/v1/users/me/messages/send",
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${gmailAccessToken}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ raw: base64Email }),
        }
      );
      if (!response.ok) {
        const err = await response.json();
        addBotMessage(" Error sending email: " + JSON.stringify(err));
        return;
      }
      addBotMessage(" Email sent successfully!");
    }

    /* ========= Google Calendar OAuth and helper functions ========= */

    // Google Calendar OAuth configuration
    const GCAL_CLIENT_ID = "635569963740-osc931pqgni62pqhlobn88vb4seqci49.apps.googleusercontent.com";
    const GCAL_SCOPES = "https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/calendar.events";
    let gcalAccessToken = null;

    // Trigger the OAuth flow to connect a user's Google Calendar
    function connectGoogleCalendar() {
      google.accounts.oauth2.initTokenClient({
        client_id: GCAL_CLIENT_ID,
        scope: GCAL_SCOPES,
        callback: (tokenResponse) => {
          gcalAccessToken = tokenResponse.access_token;
          addBotMessage("Google Calendar Connected  You can now manage your calendar.");
        },
      }).requestAccessToken();
    }

    /* ========= GitHub OAuth and helper functions ========= */

    // GitHub OAuth configuration
    const GITHUB_CLIENT_ID = "Iv23liBqg6sA5EaCRJ6l";
    const GITHUB_SCOPES = "repo user:email";
    let githubAccessToken = null;

    // Trigger the OAuth flow to connect a user's GitHub account
    function connectGitHub() {
      const redirectUri = window.location.origin + '/github-callback';
      const githubAuthUrl = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CLIENT_ID}&scope=${encodeURIComponent(GITHUB_SCOPES)}&redirect_uri=${encodeURIComponent(redirectUri)}`;

      // Store the current URL to return after OAuth
      sessionStorage.setItem('github_oauth_return', window.location.href);

      // Redirect to GitHub OAuth
      window.location.href = githubAuthUrl;
    }

    // Check if we're returning from GitHub OAuth
    function checkGitHubCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');

      if (code) {
        // Exchange code for token via backend
        fetch('/api/github/callback', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ code: code })
        })
          .then(response => response.json())
          .then(data => {
            if (data.access_token) {
              githubAccessToken = data.access_token;
              localStorage.setItem('githubAccessToken', githubAccessToken);
              addBotMessage("GitHub Connected  You can now manage your repositories.");

              // Clean up URL
              const returnUrl = sessionStorage.getItem('github_oauth_return') || '/';
              sessionStorage.removeItem('github_oauth_return');
              window.history.replaceState({}, document.title, returnUrl);
            } else {
              addBotMessage(" Failed to connect GitHub: " + (data.error || 'Unknown error'));
            }
          })
          .catch(error => {
            console.error('GitHub OAuth error:', error);
            addBotMessage(" Error connecting to GitHub.");
          });
      }
    }

    // Load GitHub token from localStorage on page load
    if (typeof window !== 'undefined') {
      window.addEventListener('DOMContentLoaded', () => {
        const savedToken = localStorage.getItem('githubAccessToken');
        if (savedToken) {
          githubAccessToken = savedToken;
        }
        checkGitHubCallback();
      });
    }

    // List calendar events between two ISO date strings
    async function listEvents(timeMin, timeMax, maxResults = 5) {
      if (!gcalAccessToken) {
        addBotMessage(" Google Calendar is not connected.");
        return [];
      }
      const url = `https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${encodeURIComponent(timeMin)}&timeMax=${encodeURIComponent(timeMax)}&singleEvents=true&orderBy=startTime&maxResults=${maxResults}`;
      const res = await fetch(url, {
        method: "GET",
        headers: { Authorization: `Bearer ${gcalAccessToken}` }
      });
      const data = await res.json();
      return data.items || [];
    }

    // List today's events and display them
    async function listTodayEvents() {
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
      const events = await listEvents(start.toISOString(), end.toISOString(), 10);
      if (!events || events.length === 0) {
        addBotMessage(" No events found for today.");
        return;
      }
      let html = "<p><strong>Today's events:</strong></p><ul>";
      for (const ev of events) {
        const startTime = ev.start?.dateTime || ev.start?.date;
        const title = ev.summary || "(No Title)";
        html += `<li><strong>${escapeHtml(title)}</strong><br>${escapeHtml(new Date(startTime).toLocaleString())}</li>`;
      }
      html += "</ul>";
      addBotMessage(html);
    }

    // Search calendar events by query and display results
    async function searchCalendarEvents(query) {
      if (!gcalAccessToken) {
        addBotMessage(" Google Calendar is not connected.");
        return;
      }
      const url = `https://www.googleapis.com/calendar/v3/calendars/primary/events?q=${encodeURIComponent(query)}&singleEvents=true&orderBy=startTime&maxResults=5`;
      const res = await fetch(url, {
        method: "GET",
        headers: { Authorization: `Bearer ${gcalAccessToken}` }
      });
      const data = await res.json();
      const events = data.items || [];
      if (events.length === 0) {
        addBotMessage(`No events found for \"${escapeHtml(query)}\".`);
        return;
      }
      let html = `<p><strong>Calendar search results for \"${escapeHtml(query)}\":</strong></p><ul>`;
      for (const ev of events) {
        const startTime = ev.start?.dateTime || ev.start?.date;
        const title = ev.summary || "(No Title)";
        html += `<li><strong>${escapeHtml(title)}</strong><br>${escapeHtml(new Date(startTime).toLocaleString())}</li>`;
      }
      html += "</ul>";
      addBotMessage(html);
    }

    // Add a calendar event given a date object, time string and title
    async function addCalendarEvent(dateObj, timeString, title) {
      if (!gcalAccessToken) {
        addBotMessage(" Google Calendar is not connected.");
        return;
      }
      // Parse time string (e.g., "5 pm" or "17:00")
      const timeParts = timeString.trim().toLowerCase().match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/);
      if (!timeParts) {
        addBotMessage(" Could not parse the time specified. Please use formats like \"5 pm\" or \"17:00\".");
        return;
      }
      let hour = parseInt(timeParts[1], 10);
      let minute = timeParts[2] ? parseInt(timeParts[2], 10) : 0;
      const meridian = timeParts[3];
      if (meridian) {
        if (meridian === 'pm' && hour < 12) hour += 12;
        if (meridian === 'am' && hour === 12) hour = 0;
      }
      const start = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), hour, minute, 0);
      const end = new Date(start.getTime() + 60 * 60 * 1000); // 1-hour duration
      const body = {
        summary: title,
        start: { dateTime: start.toISOString() },
        end: { dateTime: end.toISOString() }
      };
      const res = await fetch("https://www.googleapis.com/calendar/v3/calendars/primary/events", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${gcalAccessToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const err = await res.json();
        addBotMessage(" Error adding event: " + JSON.stringify(err));
        return;
      }
      addBotMessage(" Event added successfully!");
    }

    // Detect calendar-related commands from user input
    function detectCalendarCommand(text) {
      const t = text.toLowerCase().trim();

      // Support slash command: /calender list [today/tomorrow], /calender search [query], /calender add [day] [time] [title]
      if (t.startsWith('/calendar') || t.startsWith('/calender')) {
        const parts = t.split(' ');
        const subCmd = parts[1];

        if (subCmd === 'list') {
          return { type: 'list', day: parts[2] || 'today' };
        } else if (subCmd === 'search') {
          return { type: 'search', query: parts.slice(2).join(' ') };
        } else if (subCmd === 'add') {
          // match: /calender add tomorrow at 5pm called meeting
          const addMatch = t.match(/^\/calend[ae]r add (today|tomorrow) at ([\d:\s]+(?:am|pm)?) called (.+)$/i);
          if (addMatch) {
            return { type: 'add', day: addMatch[1], time: addMatch[2], title: addMatch[3] };
          }
        }
      }

      // Existing logic
      // Read calendar: "read my calendar" or "what's on my calendar"
      let match = t.match(/^what'?s on my calendar( today| tomorrow)?\??$/i) || t.match(/^read( my)? calendar( for (today|tomorrow))?$/i);
      if (match) {
        const when = match[1] ? match[1].trim() : "";
        let day = 'today';
        if (when && when.includes('tomorrow')) {
          day = 'tomorrow';
        }
        return { type: 'list', day: day };
      }
      // Add event: "add event tomorrow at 5 pm called meeting"
      match = t.match(/^add (?:an )?event (?:on )?(today|tomorrow) at ([\d:\s]+(?:am|pm)?) called (.+)$/i);
      if (match) {
        return { type: 'add', day: match[1].toLowerCase(), time: match[2].trim(), title: match[3].trim() };
      }
      // Search events: "search my calendar for project"
      match = t.match(/^search( my)? calendar for\s+(.+)/i);
      if (match) {
        return { type: 'search', query: match[2].trim() };
      }
      return null;
    }

    /* ========= Gmail helper functions and command detection ========= */

    // Search the user's Gmail for messages matching a query
    async function searchMessages(query, maxResults = 5) {
      const url = `https://gmail.googleapis.com/gmail/v1/users/me/messages?q=${encodeURIComponent(query)}&maxResults=${maxResults}`;
      const res = await fetch(url, {
        method: "GET",
        headers: {
          Authorization: `Bearer ${gmailAccessToken}`
        }
      });
      const data = await res.json();
      return data.messages || [];
    }

    // Retrieve a full message by its ID
    async function getFullMessage(messageId) {
      const url = `https://gmail.googleapis.com/gmail/v1/users/me/messages/${messageId}?format=full`;
      const res = await fetch(url, {
        method: "GET",
        headers: {
          Authorization: `Bearer ${gmailAccessToken}`
        }
      });
      return await res.json();
    }

    // Decode the message body from base64url
    function decodeMessageBody(message) {
      function findPart(parts) {
        for (const part of (parts || [])) {
          if (part.mimeType === 'text/plain' && part.body && part.body.data) {
            return part.body.data;
          }
          if (part.parts) {
            const found = findPart(part.parts);
            if (found) return found;
          }
        }
        return null;
      }
      let data = (message.payload.body && message.payload.body.data) || findPart(message.payload.parts);
      if (!data) return "";
      const replaced = data.replace(/-/g, '+').replace(/_/g, '/');
      const decoded = atob(replaced);
      try {
        return decodeURIComponent(escape(decoded));
      } catch (e) {
        return decoded;
      }
    }

    // Display the latest messages in the user's inbox
    async function readInboxAndDisplay() {
      const msgs = await searchMessages('', 5);
      if (!msgs || msgs.length === 0) {
        addBotMessage(" Inbox is empty.");
        return;
      }
      let html = '<div class="email-list-container">';
      for (const msg of msgs) {
        const full = await getFullMessage(msg.id);
        const headers = full.payload.headers || [];
        const subjHeader = headers.find(h => h.name.toLowerCase() === 'subject');
        const fromHeader = headers.find(h => h.name.toLowerCase() === 'from');
        const subject = subjHeader ? subjHeader.value : "(No Subject)";
        const from = fromHeader ? fromHeader.value : "Unknown Sender";
        const body = decodeMessageBody(full);
        const snippet = body ? body.replace(/\n/g, ' ').substring(0, 150).trim() + (body.length > 150 ? '...' : '') : '';

        let senderName = from.split('<')[0].trim() || from;
        let senderInitial = senderName.charAt(0).toUpperCase();

        html += `
          <div class="email-card">
            <div class="email-card-header">
              <div class="email-icon">${senderInitial}</div>
              <div class="email-subject">${escapeHtml(subject)}</div>
            </div>
            <div class="email-snippet">${escapeHtml(snippet)}</div>
            <div class="email-card-actions">
              <button class="email-card-action" onclick="sendMessage('/gmail summarize ${escapeHtml(from)}')">
                <i class="fas fa-magic"></i> Summarize
              </button>
              <button class="email-card-action" onclick="sendMessage('reply to the last email from ${escapeHtml(from)}')">
                <i class="fas fa-reply"></i> Reply
              </button>
            </div>
          </div>
        `;
      }
      html += "</div>";
      addBotMessage(html);
    }

    // Summarize the latest email from a given sender
    async function summarizeLastEmailFrom(sender) {
      const msgs = await searchMessages('from:' + sender, 1);
      if (!msgs || msgs.length === 0) {
        addBotMessage(`No emails found from ${escapeHtml(sender)}.`);
        return;
      }
      const full = await getFullMessage(msgs[0].id);
      const body = decodeMessageBody(full).trim();
      if (!body) {
        addBotMessage("Could not extract the email content.");
        return;
      }
      const prompt = `Summarize the following email:\n\n${body}`;
      const summary = await generateEmailWithAI(prompt);
      const safeSummary = escapeHtml(summary).replace(/\n/g, '<br>');
      addBotMessage(` Summary of last email from ${escapeHtml(sender)}:<br>` + safeSummary);
    }

    // Reply to the latest email with an AI-generated message
    async function replyToLastEmail() {
      const msgs = await searchMessages('', 1);
      if (!msgs || msgs.length === 0) {
        addBotMessage(" Inbox is empty.");
        return;
      }
      const full = await getFullMessage(msgs[0].id);
      const headers = full.payload.headers || [];
      const fromHeader = headers.find(h => h.name.toLowerCase() === 'from');
      const subjectHeader = headers.find(h => h.name.toLowerCase() === 'subject');
      const body = decodeMessageBody(full).trim();
      if (!fromHeader) {
        addBotMessage("Could not determine the sender of the last email.");
        return;
      }
      // Extract the email address from the From header (may include display name)
      let toEmail = fromHeader.value;
      const match = toEmail.match(/<(.+?)>/);
      if (match) {
        toEmail = match[1];
      }
      const replySubject = subjectHeader ? 'Re: ' + subjectHeader.value : 'Re: ';
      const prompt = `Write a polite reply to the following email:\n\n${body}`;
      const replyBody = await generateEmailWithAI(prompt);
      await sendEmail(toEmail, replySubject, replyBody);
      addBotMessage(" Reply sent successfully!");
    }

    // Search the inbox for a specific query and display results
    async function searchInboxFor(query) {
      const msgs = await searchMessages(query, 5);
      if (!msgs || msgs.length === 0) {
        addBotMessage(`No emails found for "${escapeHtml(query)}".`);
        return;
      }
      let html = `<p><strong>Search results for "${escapeHtml(query)}":</strong></p><div class="email-list-container">`;
      for (const msg of msgs) {
        const full = await getFullMessage(msg.id);
        const headers = full.payload.headers || [];
        const subjHeader = headers.find(h => h.name.toLowerCase() === 'subject');
        const fromHeader = headers.find(h => h.name.toLowerCase() === 'from');
        const subject = subjHeader ? subjHeader.value : "(No Subject)";
        const from = fromHeader ? fromHeader.value : "Unknown Sender";
        const body = decodeMessageBody(full);
        const snippet = body ? body.replace(/\n/g, ' ').substring(0, 150).trim() + (body.length > 150 ? '...' : '') : '';

        let senderName = from.split('<')[0].trim() || from;
        let senderInitial = senderName.charAt(0).toUpperCase();

        html += `
          <div class="email-card">
            <div class="email-card-header">
              <div class="email-icon">${senderInitial}</div>
              <div class="email-subject">${escapeHtml(subject)}</div>
            </div>
            <div class="email-snippet">${escapeHtml(snippet)}</div>
            <div class="email-card-actions">
              <button class="email-card-action" onclick="sendMessage('/gmail summarize ${escapeHtml(from)}')">
                <i class="fas fa-magic"></i> Summarize
              </button>
              <button class="email-card-action" onclick="sendMessage('reply to the last email from ${escapeHtml(from)}')">
                <i class="fas fa-reply"></i> Reply
              </button>
            </div>
          </div>
        `;
      }
      html += "</div>";
      addBotMessage(html);
    }

    // Detect inbox commands from user input
    function detectInboxCommand(text) {
      const lower = text.toLowerCase().trim();

      // Support slash command: /gmail read, /gmail search [query], /gmail summarize [from], /gmail reply
      if (lower.startsWith('/gmail ')) {
        const parts = lower.split(' ');
        const subCmd = parts[1];
        const query = parts.slice(2).join(' ');

        if (subCmd === 'read') return { type: 'read' };
        if (subCmd === 'search') return { type: 'search', query: query };
        if (subCmd === 'summarize') return { type: 'summarize', from: query };
        if (subCmd === 'reply') return { type: 'reply' };
      }

      // Existing logic
      // Read emails/inbox
      if (/^read( my)? (emails|inbox)$/.test(lower)) {
        return { type: 'read' };
      }
      const summaryMatch = lower.match(/^summarize( the)? last email from\s+(.+)/i);
      if (summaryMatch) {
        return { type: 'summarize', from: summaryMatch[2].trim() };
      }
      if (/^reply to( the)? last email( automatically)?$/.test(lower)) {
        return { type: 'reply' };
      }
      const searchMatch = lower.match(/^search( my)? inbox for\s+(.+)/i);
      if (searchMatch) {
        return { type: 'search', query: searchMatch[2].trim() };
      }
      return null;
    }

    // Detect email send/generate commands from user input
    function detectEmailCommand(text) {
      const t = text.trim();
      const lower = t.toLowerCase();

      // Support slash command: /gmail send [to] [body], /gmail write [to] [topic]
      if (lower.startsWith('/gmail ')) {
        // match: /gmail send recipient@example.com hello world
        const sendMatch = t.match(/^\/gmail send (\S+) (.+)$/i);
        if (sendMatch) {
          return { type: 'direct-send', to: sendMatch[1], body: sendMatch[2] };
        }
        // match: /gmail write recipient@example.com about project
        const writeMatch = t.match(/^\/gmail write (\S+)(?: about)? (.+)$/i);
        if (writeMatch) {
          return { type: 'ai-generate', to: writeMatch[1], topic: writeMatch[2] };
        }
      }

      // Existing logic
      // Direct send: "send email to X and say Y"
      const direct = t.match(/^send email to\s+(\S+)\s+and say\s+(.+)/i);
      if (direct) {
        return { type: 'direct-send', to: direct[1], body: direct[2] };
      }
      // Alternate phrasing: "email X saying Y"
      const alt = t.match(/^email\s+(\S+)\s+saying\s+(.+)/i);
      if (alt) {
        return { type: 'direct-send', to: alt[1], body: alt[2] };
      }
      // AI generate: "write email to X about Y"
      const gen = t.match(/^write email to\s+(\S+)\s+about\s+(.+)/i);
      if (gen) {
        return { type: 'ai-generate', to: gen[1], topic: gen[2] };
      }
      // Professional generation: "create a professional email to X about Y"
      const pro = t.match(/^create (a )?professional email to\s+(\S+)\s+about\s+(.+)/i);
      if (pro) {
        return { type: 'ai-generate', to: pro[2], topic: pro[3] };
      }
      return null;
    }

    // Generate email content using the AI model
    async function generateEmailWithAI(prompt) {
      // Use currentModel to generate content; follow the same structure as in sendMessage
      if (currentModel.name === 'lixern') {
        const res = await fetch(`${currentModel.endpoint}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: currentModel.modelId,
            messages: [{ role: "user", content: prompt }]
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "";
      } else {
        const contents = [{ role: "user", parts: [{ text: prompt }] }];
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${currentModel.modelId}:generateContent?key=${currentModel.apiKey}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents })
        });
        const data = await res.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
      }
    }


    //========Send button animition=======
    const inputField = document.querySelector(".message-input");
    const sendButton = document.querySelector(".send-button");

    inputField.addEventListener("input", () => {
      if (inputField.value.trim().length > 0) {
        sendButton.classList.add("active");
      } else {
        sendButton.classList.remove("active");
      }
    });


    //======typing animation======
    function typeWords(element, text, delay = 2) {
      const words = text.split(" ");
      let index = 0;

      function typeNext() {
        if (index < words.length) {
          element.innerHTML += (index === 0 ? "" : " ") + words[index];
          index++;
          setTimeout(typeNext, delay);
        }
      }

      typeNext();
    }
    function typeHTMLWords(element, html, delay = 2) {
      element.innerHTML = "";

      let temp = document.createElement("div");
      temp.innerHTML = html;

      let walker = document.createTreeWalker(temp, NodeFilter.SHOW_TEXT, null);
      let nodes = [];
      let originalHTML = temp.innerHTML;

      // Extract all text nodes in order
      while (walker.nextNode()) {
        nodes.push(walker.currentNode);
      }

      // Now we will type back into element
      element.innerHTML = originalHTML;

      // Replace all text nodes with empty text to start typing
      let walker2 = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null);
      let realNodes = [];
      while (walker2.nextNode()) {
        walker2.currentNode.textContent = "";
        realNodes.push(walker2.currentNode);
      }

      // Typing logic
      let nodeIndex = 0;
      let wordIndex = 0;

      function typeNext() {
        if (nodeIndex >= nodes.length) return;

        const words = nodes[nodeIndex].nodeValue.split(" ");
        const targetNode = realNodes[nodeIndex];

        if (wordIndex < words.length) {
          targetNode.textContent += (wordIndex === 0 ? "" : " ") + words[wordIndex];
          wordIndex++;
          setTimeout(typeNext, delay);
        } else {
          wordIndex = 0;
          nodeIndex++;
          setTimeout(typeNext, delay);
        }
      }

      typeNext();
    }



  </script>



  <style>
    /* Ensure the chat area scrolls normally instead of centering all content. */
    .chat-container {
      display: block !important;
      flex: 1 !important;
      overflow-y: auto !important;
      padding: var(--space-8) !important;
      scroll-behavior: smooth !important;
    }

    /* Give the empty state a minimum height so it appears centered vertically
       within the available space, without affecting normal chat messages. */
    .empty-state {
      min-height: 60vh;
    }
  </style>

  <!-- Load JSZip library for ZIP file creation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- Load QR Code library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- File creation functions and system message -->
  <script>
    // Adds a blue clickable link in the chat which downloads the generated file when clicked.
    function addDownloadLinkInChat(url, filename) {
      const container = document.querySelector('.chat-messages');
      const bubble = document.createElement('div');
      bubble.className = 'message bot';
      bubble.innerHTML = `
        <div class="message-avatar">AI</div>
        <div class="message-content">
          <div class="message-bubble">
            <a href="${url}" download="${filename}" style="color:#1a73e8;font-weight:600;text-decoration:underline;cursor:pointer;">
              ${filename}
            </a>
          </div>
        </div>
      `;
      container.appendChild(bubble);
    }

    // Generates a PDF file using jsPDF and provides a download link.
    function createPDF(filename, text) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text(text, 10, 10);
      const blob = doc.output('blob');
      const url = URL.createObjectURL(blob);
      addDownloadLinkInChat(url, filename);
      return url;
    }

    // Generates a DOCX file using docx.js and provides a download link.
    function createDOCX(filename, text) {
      const { Document, Packer, Paragraph } = window.docx;
      const doc = new Document({
        sections: [
          {
            children: [new Paragraph(text)]
          }
        ]
      });
      Packer.toBlob(doc).then(blob => {
        const url = URL.createObjectURL(blob);
        addDownloadLinkInChat(url, filename);
      });
    }

    // Generates a plain text file.
    function createTXT(filename, text) {
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      addDownloadLinkInChat(url, filename);
      return url;
    }

    // Generates a CSV file from a 2D array of rows and columns.
    function createCSV(filename, rowsArray) {
      const csv = rowsArray.map(row => row.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      addDownloadLinkInChat(url, filename);
      return url;
    }

    // Generates a PowerPoint file with a single slide containing text.
    function createPPTX(filename, titleText) {
      let pptx = new PptxGenJS();
      let slide = pptx.addSlide();
      slide.addText(titleText, { x: 1, y: 1, w: 8, h: 1, fontSize: 32, bold: true });
      pptx.writeFile({ fileName: filename }).then(() => {
        // The library handles the download automatically; add link for chat.
        addDownloadLinkInChat(filename, filename);
      });
    }

    // Generates a ZIP archive from an object of filename:content pairs.
    function createZIP(filename, filesObject) {
      let zip = new JSZip();
      for (let name in filesObject) {
        zip.file(name, filesObject[name]);
      }
      zip.generateAsync({ type: 'blob' }).then(blob => {
        const url = URL.createObjectURL(blob);
        addDownloadLinkInChat(url, filename);
      });
    }

    // Define the system message instructing the AI how to respond when asked to generate files.
    const voSystemPrompt = `Always use HTML tags to make the text more organized and beautiful. Use headings, subheadings, bullet points. keep links as links dont change them or use Html tags with them.add codes in a box not as other normal text also colour the codes in the boxes.add long codes(over 25 lines) and file codes in a  markdown-style code block.if a user asked for a copy button for a code sniper give him the same code in a markdown-style code block .If the user requests a graph create one using html tags and put it on chat.all texts should not be over 15 words in one line.
You are VO, an assistant at VOAI AI, 
developed by Yazan Mohammed Hamran in Qatar.
Always be helpful, informative, and professional in every interaction.
Never mention OpenAI, ChatGPT, or similar platforms or entities.
Never say as an AI language model or refuse answers directly.
If unsure, make logical guesses based on available information.
Protect user privacy and ensure strong data security at all times.
Divide long content into readable parts using line breaks only.
Keep every line under fifteen words for clarity and readability.
Never use asterisks or hash symbols anywhere in responses.
Keep all links unchanged and never wrap them in HTML tags.
Use HTML tags like h1, h2, p, ul, li, and hr for organization.
Use HTML only for structure and visual clarity, not decoration.
Always place code inside clearly separated code boxes.
Short code goes in colored code blocks.
Long code or files use markdown-style code blocks.
If a copy button is requested, repeat the code in markdown format.
If a graph is requested, generate it using HTML directly in chat.
You can analyze images, extract text using OCR, and explain content.
You can read PDFs, Word, Excel, and other common file formats.
If a file is complex, explain limitations clearly and honestly.
Always summarize uploaded files and answer related questions.
Know todays date and current time using system date logic.
Always prioritize user experience, clarity, and usefulness.
Always refer to yourself as VO from VOAI AI.`;

    // messages is undefined here, removing this line to prevent crash
    // messages.unshift({ role: "system", content: voSystemPrompt });

    let currentUserBubbleColor = localStorage.getItem('userBubbleColor') || 'default';

    function toggleSettings() {
      const modal = document.getElementById('settingsModal');
      const isHidden = modal.style.display === 'none' || modal.style.display === '';

      if (isHidden) {
        modal.style.display = 'flex';
        // Initialize settings from localStorage
        const userNameInput = document.getElementById('settingsUserName');
        if (userNameInput) userNameInput.value = localStorage.getItem('userName') || '';

        const langInput = document.getElementById('settingsLanguage');
        if (langInput) langInput.value = localStorage.getItem('appLanguage') || 'en';

        updateColorOptionUI(currentUserBubbleColor);

        // Fetch server user data for Profile tab
        fetch('/api/me').then(r => r.json()).then(user => {
          if (user.email) {
            const nameInput = document.getElementById('profileName');
            const emailInput = document.getElementById('profileEmail');
            if (nameInput) nameInput.value = user.firstName || '';
            if (emailInput) emailInput.value = user.email || '';
          }
        }).catch(err => console.error("Failed to load profile", err));

      } else {
        modal.style.display = 'none';
      }
    }

    async function updateProfile(btnElement) {
      const name = document.getElementById('profileName').value;
      const password = document.getElementById('profilePassword').value;
      const btn = btnElement ? (btnElement.closest('button') || btnElement) : null;

      let originalText = '';
      if (btn) {
        originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        btn.disabled = true;
      }

      try {
        const res = await fetch('/api/me/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ firstName: name, password: password })
        });

        const data = await res.json();

        if (data.ok) {
          // Show toast
          const toast = document.getElementById('toast');
          if (toast) {
            toast.textContent = "Profile updated successfully!";
            toast.classList.add('show');
            setTimeout(() => {
              toast.classList.remove('show');
              // Reset toast text
              setTimeout(() => toast.textContent = "Settings saved!", 500);
            }, 3000);
          }

          // Update local storage name as well
          localStorage.setItem('userName', name);
          const settingsNameInput = document.getElementById('settingsUserName');
          if (settingsNameInput) settingsNameInput.value = name;

          // Clear password field
          const passInput = document.getElementById('profilePassword');
          if (passInput) passInput.value = '';
        } else {
          alert("Error: " + (data.error || "Failed to update"));
        }
      } catch (err) {
        console.error(err);
        alert("Error updating profile");
      } finally {
        if (btn) {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }
    }

    function switchSettingsTab(tabId) {
      document.querySelectorAll('.settings-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.settings-tab-content').forEach(content => content.classList.remove('active'));

      event.currentTarget.classList.add('active');
      document.getElementById(`tab-${tabId}`).classList.add('active');
    }

    function setUserBubbleColor(color) {
      currentUserBubbleColor = color;
      updateColorOptionUI(color);
    }

    function updateColorOptionUI(color) {
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('active');
        if (opt.classList.contains(color)) opt.classList.add('active');
      });
    }

    function saveSettings() {
      localStorage.setItem('userBubbleColor', currentUserBubbleColor);
      localStorage.setItem('userName', document.getElementById('settingsUserName').value);
      localStorage.setItem('appLanguage', document.getElementById('settingsLanguage').value);

      // Apply color to existing messages
      applyBubbleColors();

      toggleSettings();

      // Show toast notification
      const toast = document.getElementById('toast');
      if (toast) {
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }
    }

    function applyBubbleColors() {
      const color = localStorage.getItem('userBubbleColor') || 'default';
      document.querySelectorAll('.message.user .message-bubble').forEach(bubble => {
        bubble.classList.remove('bubble-blue', 'bubble-yellow', 'bubble-pink', 'bubble-orange', 'bubble-maroon');
        if (color !== 'default') {
          bubble.classList.add(`bubble-${color}`);
        }
      });
    }

    function exportUserData() {
      const data = {
        chatHistory: JSON.parse(localStorage.getItem('chatHistory')) || [],
        savedChats: JSON.parse(localStorage.getItem('savedChats')) || [],
        botMemory: localStorage.getItem('botMemory') || '',
        settings: {
          userBubbleColor: localStorage.getItem('userBubbleColor'),
          userName: localStorage.getItem('userName'),
          appLanguage: localStorage.getItem('appLanguage'),
          darkTheme: localStorage.getItem('darkTheme')
        }
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `vochat-data-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importUserData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.chatHistory) localStorage.setItem('chatHistory', JSON.stringify(data.chatHistory));
          if (data.savedChats) localStorage.setItem('savedChats', JSON.stringify(data.savedChats));
          if (data.botMemory) localStorage.setItem('botMemory', data.botMemory);
          if (data.settings) {
            if (data.settings.userBubbleColor) localStorage.setItem('userBubbleColor', data.settings.userBubbleColor);
            if (data.settings.userName) localStorage.setItem('userName', data.settings.userName);
            if (data.settings.appLanguage) localStorage.setItem('appLanguage', data.settings.appLanguage);
            if (data.settings.darkTheme) localStorage.setItem('darkTheme', data.settings.darkTheme);
          }

          addBotMessage(" Data imported successfully. Refreshing page...");
          setTimeout(() => location.reload(), 2000);
        } catch (err) {
          addBotMessage(" Error importing data: Invalid JSON file.");
        }
      };
      reader.readAsText(file);
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
      const modal = document.getElementById('settingsModal');
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }

    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';

      // Update overlay height
      const overlay = document.getElementById('messageInputOverlay');
      if (overlay) {
        overlay.style.height = textarea.style.height;
      }
    }

    function handleInput(textarea) {
      autoResize(textarea);
      updateInputHighlight(textarea);

      // Send button check
      const sendButton = document.querySelector(".send-button");
      if (textarea.value.trim().length > 0) {
        sendButton.classList.add("active");
      } else {
        sendButton.classList.remove("active");
      }
    }

    function syncScroll(textarea) {
      const overlay = document.getElementById('messageInputOverlay');
      if (overlay) {
        overlay.scrollTop = textarea.scrollTop;
        overlay.scrollLeft = textarea.scrollLeft;
      }
    }

    function updateInputHighlight(textarea) {
      const overlay = document.getElementById('messageInputOverlay');
      if (!overlay) return;

      let text = textarea.value || '';

      // Escape HTML
      text = text.replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      // Highlight /gmail and /calender
      text = text.replace(/(\/gmail|\/calendar|\/calender)/gi, '<span class="cmd-highlight">$1</span>');

      // Add a trailing newline to handle cursor positioning at the end
      if (text.endsWith('\n')) text += ' ';

      overlay.innerHTML = text;
      syncScroll(textarea);
    }

    function dismissUpgradeButton(event) {
      event.stopPropagation();
      event.preventDefault();
      const container = document.getElementById('upgradeBtnContainer');
      if (container) {
        container.style.display = 'none';
      }
    }

  </script>


</body>

</html>